<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Spreadsheet Integration Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 1.5em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"], input[type="number"], select, textarea {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, 
        select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .status.success {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }

        .status.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .status.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }

        .result-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-success {
            background: #e8f5e9;
        }

        .result-error {
            background: #ffebee;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge-success {
            background: #4CAF50;
            color: white;
        }

        .badge-error {
            background: #f44336;
            color: white;
        }

        .badge-warning {
            background: #ff9800;
            color: white;
        }

        .badge-info {
            background: #2196F3;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– Gemini Spreadsheet Integration Test</h1>
            <p>æ—¢å­˜Geminiã‚³ãƒ¼ãƒ‰ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒ</p>
        </div>

        <div class="content">
            <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2><span class="icon">âš™ï¸</span>ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="loadScripts()">
                        <span>ğŸ“¦</span>ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿
                    </button>
                    <button class="btn-success" onclick="initializeIntegration()">
                        <span>ğŸš€</span>çµ±åˆåˆæœŸåŒ–
                    </button>
                    <button class="btn-info" onclick="checkStatus()">
                        <span>âœ…</span>çŠ¶æ…‹ç¢ºèª
                    </button>
                </div>
                <div id="setup-status" class="status" style="display:none;"></div>
            </div>

            <!-- æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2><span class="icon">ğŸ§ª</span>æ‰‹å‹•ãƒ†ã‚¹ãƒˆ</h2>
                
                <div class="input-group">
                    <div style="flex:1;">
                        <label for="test-model">ãƒ¢ãƒ‡ãƒ«:</label>
                        <select id="test-model">
                            <option value="">ãªã—</option>
                            <option value="Flash 2.0">Flash 2.0</option>
                            <option value="Pro">Pro</option>
                            <option value="Pro 1.5">Pro 1.5</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label for="test-function">æ©Ÿèƒ½:</label>
                        <select id="test-function">
                            <option value="">ãªã—</option>
                            <option value="Deep Research">Deep Research</option>
                            <option value="ç”»åƒ">ç”»åƒç”Ÿæˆ</option>
                            <option value="ã‚³ãƒ¼ãƒ‰">ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="test-text">ãƒ†ã‚­ã‚¹ãƒˆ:</label>
                    <textarea id="test-text" placeholder="Geminiã«é€ä¿¡ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›...">ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã®å¤©æ°—ã¯ã©ã†ã§ã™ã‹ï¼Ÿ</textarea>
                </div>

                <div class="button-group">
                    <button class="btn-success" onclick="executeManualTest()">
                        <span>â–¶ï¸</span>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                    </button>
                    <button class="btn-info" onclick="executeDeepResearchTest()">
                        <span>ğŸ”¬</span>Deep Research ãƒ†ã‚¹ãƒˆ
                    </button>
                    <button class="btn-warning" onclick="clearAllFunctions()">
                        <span>ğŸ”§</span>æ©Ÿèƒ½ã‚¯ãƒªã‚¢
                    </button>
                </div>

                <div id="manual-result" class="result-container" style="display:none;"></div>
            </div>

            <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ -->
            <div class="section">
                <h2><span class="icon">ğŸ“Š</span>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ</h2>
                
                <div class="button-group">
                    <button class="btn-success" onclick="generateSampleData()">
                        <span>ğŸ“</span>ã‚µãƒ³ãƒ—ãƒ«ç”Ÿæˆ
                    </button>
                    <button class="btn-info" onclick="executeSingleSample()">
                        <span>â–¶ï¸</span>å˜ä¸€å®Ÿè¡Œ
                    </button>
                    <button class="btn-warning" onclick="executeBatchSample()">
                        <span>âš¡</span>ãƒãƒƒãƒå®Ÿè¡Œ
                    </button>
                </div>

                <div id="sample-data" class="code-block" style="display:none;"></div>
                <div id="sample-result" class="result-container" style="display:none;"></div>
            </div>

            <!-- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº -->
            <div class="section">
                <h2><span class="icon">ğŸ“‘</span>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰</h2>
                
                <div class="input-group">
                    <input type="text" id="spreadsheet-url" placeholder="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›...">
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="loadSpreadsheet()">
                        <span>ğŸ“‚</span>èª­ã¿è¾¼ã¿
                    </button>
                    <button class="btn-success" onclick="executeSpreadsheetRow()">
                        <span>â–¶ï¸</span>è¡Œã‚’å®Ÿè¡Œ
                    </button>
                    <button class="btn-warning" onclick="executeAllRows()">
                        <span>âš¡</span>å…¨è¡Œå®Ÿè¡Œ
                    </button>
                </div>

                <div class="input-group" style="margin-top:15px;">
                    <input type="number" id="row-number" placeholder="è¡Œç•ªå·" min="1" style="width:150px;">
                </div>

                <div id="spreadsheet-status" class="status" style="display:none;"></div>
                <div id="spreadsheet-result" class="result-container" style="display:none;"></div>
            </div>

            <!-- å®Ÿè¡Œå±¥æ­´ -->
            <div class="section">
                <h2><span class="icon">ğŸ“œ</span>å®Ÿè¡Œå±¥æ­´</h2>
                
                <div class="button-group">
                    <button class="btn-info" onclick="showHistory()">
                        <span>ğŸ“‹</span>å±¥æ­´è¡¨ç¤º
                    </button>
                    <button class="btn-success" onclick="exportHistory('json')">
                        <span>ğŸ’¾</span>JSONå‡ºåŠ›
                    </button>
                    <button class="btn-success" onclick="exportHistory('csv')">
                        <span>ğŸ“Š</span>CSVå‡ºåŠ›
                    </button>
                    <button class="btn-danger" onclick="clearHistory()">
                        <span>ğŸ—‘ï¸</span>å±¥æ­´ã‚¯ãƒªã‚¢
                    </button>
                </div>

                <div id="history-result" class="result-container" style="display:none;"></div>
            </div>

            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top:15px;">å‡¦ç†ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let integration = null;
        let adapter = null;
        let isInitialized = false;

        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿
        async function loadScripts() {
            showLoading(true);
            updateStatus('setup-status', 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...', 'info');

            try {
                // æ—¢å­˜ã®Geminiã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ï¼ˆå®Ÿéš›ã®ç’°å¢ƒã§ã¯é©åˆ‡ãªãƒ‘ã‚¹ã«å¤‰æ›´ï¼‰
                await loadScript('gemini-automation-control.js');
                await new Promise(resolve => setTimeout(resolve, 1000));

                // çµ±åˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’èª­ã¿è¾¼ã¿
                await loadScript('gemini-spreadsheet-integration.js');
                await new Promise(resolve => setTimeout(resolve, 500));

                // ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã¿
                await loadScript('gemini-spreadsheet-adapter.js');
                await new Promise(resolve => setTimeout(resolve, 500));

                updateStatus('setup-status', 'âœ… ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†', 'success');
            } catch (error) {
                updateStatus('setup-status', `âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‹•çš„èª­ã¿è¾¼ã¿
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(script);
            });
        }

        // çµ±åˆåˆæœŸåŒ–
        async function initializeIntegration() {
            if (!window.Gemini) {
                updateStatus('setup-status', 'âŒ GeminiãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            showLoading(true);
            updateStatus('setup-status', 'çµ±åˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆæœŸåŒ–ä¸­...', 'info');

            try {
                // GeminiIntegrationã®åˆæœŸåŒ–
                integration = new window.GeminiIntegration(window.Gemini);
                integration.setDebugMode(true);

                // ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®åˆæœŸåŒ–ï¼ˆsheetsClientãŒã‚ã‚‹å ´åˆï¼‰
                if (window.setupGeminiSpreadsheetIntegration) {
                    adapter = await window.setupGeminiSpreadsheetIntegration();
                }

                isInitialized = true;
                updateStatus('setup-status', 'âœ… çµ±åˆåˆæœŸåŒ–å®Œäº†ï¼', 'success');
            } catch (error) {
                updateStatus('setup-status', `âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // çŠ¶æ…‹ç¢ºèª
        function checkStatus() {
            const status = {
                gemini: !!window.Gemini,
                integration: !!integration,
                adapter: !!adapter,
                initialized: isInitialized
            };

            let message = '<strong>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:</strong><br>';
            message += `Gemini: ${status.gemini ? 'âœ…' : 'âŒ'}<br>`;
            message += `Integration: ${status.integration ? 'âœ…' : 'âŒ'}<br>`;
            message += `Adapter: ${status.adapter ? 'âœ…' : 'âŒ'}<br>`;
            message += `åˆæœŸåŒ–æ¸ˆã¿: ${status.initialized ? 'âœ…' : 'âŒ'}`;

            updateStatus('setup-status', message, status.initialized ? 'success' : 'warning');
        }

        // æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function executeManualTest() {
            if (!integration) {
                alert('å…ˆã«çµ±åˆã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„');
                return;
            }

            const data = {
                model: document.getElementById('test-model').value,
                function: document.getElementById('test-function').value,
                text: document.getElementById('test-text').value
            };

            if (!data.text) {
                alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading(true);
            showResult('manual-result', 'å®Ÿè¡Œä¸­...');

            try {
                const result = await integration.executeFromSpreadsheet(data);
                
                let html = '<h3>å®Ÿè¡Œçµæœ</h3>';
                html += `<div class="result-item ${result.success ? 'result-success' : 'result-error'}">`;
                html += `<strong>æˆåŠŸ:</strong> ${result.success}<br>`;
                html += `<strong>å®Ÿè¡Œæ™‚é–“:</strong> ${result.duration}ms<br>`;
                
                if (result.result?.response) {
                    const response = result.result.response;
                    html += `<strong>å¿œç­”:</strong><br>`;
                    html += `<div class="code-block">${escapeHtml(response.substring(0, 500))}${response.length > 500 ? '...' : ''}</div>`;
                    html += `<strong>æ–‡å­—æ•°:</strong> ${response.length}`;
                }
                
                if (result.error) {
                    html += `<strong>ã‚¨ãƒ©ãƒ¼:</strong> ${result.error}`;
                }
                
                html += '</div>';
                
                showResult('manual-result', html);
            } catch (error) {
                showResult('manual-result', `<div class="result-item result-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`);
            } finally {
                showLoading(false);
            }
        }

        // Deep Researchãƒ†ã‚¹ãƒˆ
        async function executeDeepResearchTest() {
            if (!integration) {
                alert('å…ˆã«çµ±åˆã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„');
                return;
            }

            const data = {
                model: 'Pro',
                function: 'Deep Research',
                text: 'AIã®æœ€æ–°å‹•å‘ã«ã¤ã„ã¦è©³ã—ãèª¿æŸ»ã—ã¦ãã ã•ã„',
                maxWaitMinutes: 20
            };

            if (confirm('Deep Researchãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿï¼ˆæœ€å¤§20åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰')) {
                showLoading(true);
                showResult('manual-result', 'Deep Researchå®Ÿè¡Œä¸­... ã“ã‚Œã«ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚');

                try {
                    const result = await integration.executeFromSpreadsheet(data);
                    
                    let html = '<h3>Deep Researchçµæœ</h3>';
                    html += `<div class="result-item result-success">`;
                    html += `<strong>æˆåŠŸ:</strong> ${result.success}<br>`;
                    html += `<strong>å®Ÿè¡Œæ™‚é–“:</strong> ${Math.floor(result.duration / 60000)}åˆ†<br>`;
                    
                    if (result.result?.response) {
                        const response = result.result.response;
                        html += `<strong>èª¿æŸ»çµæœ:</strong><br>`;
                        html += `<div class="code-block">${escapeHtml(response.substring(0, 1000))}${response.length > 1000 ? '...' : ''}</div>`;
                        html += `<strong>æ–‡å­—æ•°:</strong> ${response.length}`;
                    }
                    
                    html += '</div>';
                    
                    showResult('manual-result', html);
                } catch (error) {
                    showResult('manual-result', `<div class="result-item result-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`);
                } finally {
                    showLoading(false);
                }
            }
        }

        // æ©Ÿèƒ½ã‚¯ãƒªã‚¢
        async function clearAllFunctions() {
            if (!window.Gemini) {
                alert('GeminiãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            showLoading(true);
            try {
                await window.Gemini.clearFunctions();
                updateStatus('manual-result', 'âœ… ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                updateStatus('manual-result', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateSampleData() {
            const samples = [
                {
                    model: 'Flash 2.0',
                    function: '',
                    text: 'ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã®å¤©æ°—ã¯ã©ã†ã§ã™ã‹ï¼Ÿ'
                },
                {
                    model: 'Pro',
                    function: 'Deep Research',
                    text: 'AIã®æœ€æ–°å‹•å‘ã«ã¤ã„ã¦è©³ã—ãèª¿æŸ»ã—ã¦ãã ã•ã„'
                },
                {
                    model: 'Flash',
                    function: 'ç”»åƒ',
                    text: 'ç¾ã—ã„å¤•æ—¥ã®é¢¨æ™¯ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„'
                }
            ];

            window.sampleData = samples;
            
            const html = JSON.stringify(samples, null, 2);
            document.getElementById('sample-data').style.display = 'block';
            document.getElementById('sample-data').textContent = html;
        }

        // å˜ä¸€ã‚µãƒ³ãƒ—ãƒ«å®Ÿè¡Œ
        async function executeSingleSample() {
            if (!integration || !window.sampleData) {
                alert('å…ˆã«çµ±åˆã‚’åˆæœŸåŒ–ã—ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                return;
            }

            showLoading(true);
            showResult('sample-result', 'å®Ÿè¡Œä¸­...');

            try {
                const result = await integration.executeFromSpreadsheet(window.sampleData[0]);
                showResult('sample-result', formatExecutionResult(result));
            } catch (error) {
                showResult('sample-result', `<div class="result-item result-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`);
            } finally {
                showLoading(false);
            }
        }

        // ãƒãƒƒãƒã‚µãƒ³ãƒ—ãƒ«å®Ÿè¡Œ
        async function executeBatchSample() {
            if (!integration || !window.sampleData) {
                alert('å…ˆã«çµ±åˆã‚’åˆæœŸåŒ–ã—ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                return;
            }

            showLoading(true);
            showResult('sample-result', 'ãƒãƒƒãƒå®Ÿè¡Œä¸­...');

            try {
                const results = await integration.executeBatch(window.sampleData, {
                    pauseBetweenTasks: 3000,
                    stopOnError: false
                });

                let html = '<h3>ãƒãƒƒãƒå®Ÿè¡Œçµæœ</h3>';
                results.forEach((result, index) => {
                    html += `<div class="result-item ${result.success ? 'result-success' : 'result-error'}">`;
                    html += `<strong>ã‚¿ã‚¹ã‚¯ ${index + 1}:</strong> `;
                    html += result.success ? 
                        `<span class="badge badge-success">æˆåŠŸ</span>` : 
                        `<span class="badge badge-error">å¤±æ•—</span>`;
                    
                    if (result.result?.responseLength) {
                        html += ` (å¿œç­”: ${result.result.responseLength}æ–‡å­—)`;
                    }
                    if (result.error) {
                        html += ` - ${result.error}`;
                    }
                    html += '</div>';
                });

                showResult('sample-result', html);
            } catch (error) {
                showResult('sample-result', `<div class="result-item result-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`);
            } finally {
                showLoading(false);
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        async function loadSpreadsheet() {
            if (!adapter) {
                alert('ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            const url = document.getElementById('spreadsheet-url').value;
            if (!url) {
                alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading(true);
            
            try {
                const { spreadsheetId, gid } = window.parseSpreadsheetUrl(url);
                if (!spreadsheetId) {
                    throw new Error('ç„¡åŠ¹ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL');
                }

                const data = await adapter.loadSpreadsheet(spreadsheetId, gid);
                
                updateStatus('spreadsheet-status', 
                    `âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å®Œäº†<br>` +
                    `ä½œæ¥­è¡Œ: ${data.workRows.length}è¡Œ<br>` +
                    `åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°: ${Object.keys(data.columnMapping).length}åˆ—`, 
                    'success'
                );
            } catch (error) {
                updateStatus('spreadsheet-status', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¡Œå®Ÿè¡Œ
        async function executeSpreadsheetRow() {
            if (!adapter || !adapter.loadedData) {
                alert('å…ˆã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }

            const rowNumber = parseInt(document.getElementById('row-number').value);
            if (!rowNumber) {
                alert('è¡Œç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading(true);
            
            try {
                const result = await adapter.executeRow(rowNumber);
                showResult('spreadsheet-result', formatExecutionResult(result));
            } catch (error) {
                showResult('spreadsheet-result', `<div class="result-item result-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`);
            } finally {
                showLoading(false);
            }
        }

        // å…¨è¡Œå®Ÿè¡Œ
        async function executeAllRows() {
            if (!adapter || !adapter.loadedData) {
                alert('å…ˆã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }

            if (!confirm('ã™ã¹ã¦ã®è¡Œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            showLoading(true);
            
            try {
                const results = await adapter.executeRows();
                
                let html = '<h3>å…¨è¡Œå®Ÿè¡Œçµæœ</h3>';
                const successCount = results.filter(r => r.success && !r.skipped).length;
                const skipCount = results.filter(r => r.skipped).length;
                const failCount = results.filter(r => !r.success && !r.skipped).length;
                
                html += `<div class="status success">`;
                html += `æˆåŠŸ: ${successCount}è¡Œ | ã‚¹ã‚­ãƒƒãƒ—: ${skipCount}è¡Œ | å¤±æ•—: ${failCount}è¡Œ`;
                html += `</div>`;
                
                showResult('spreadsheet-result', html);
            } catch (error) {
                showResult('spreadsheet-result', `<div class="result-item result-error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`);
            } finally {
                showLoading(false);
            }
        }

        // å±¥æ­´è¡¨ç¤º
        function showHistory() {
            if (!integration) {
                alert('çµ±åˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            const history = integration.getHistory();
            
            if (history.length === 0) {
                showResult('history-result', '<p>å®Ÿè¡Œå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>');
                return;
            }

            let html = '<h3>å®Ÿè¡Œå±¥æ­´</h3>';
            history.forEach((item, index) => {
                html += `<div class="result-item">`;
                html += `<strong>#${index + 1}</strong> `;
                html += `${new Date(item.timestamp).toLocaleString()} - `;
                html += item.success ? 
                    `<span class="badge badge-success">æˆåŠŸ</span>` : 
                    `<span class="badge badge-error">å¤±æ•—</span>`;
                
                if (item.mappedTask?.text) {
                    html += `<br>ãƒ†ã‚­ã‚¹ãƒˆ: ${item.mappedTask.text.substring(0, 50)}...`;
                }
                html += '</div>';
            });
            
            showResult('history-result', html);
        }

        // å±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportHistory(format) {
            if (!integration) {
                alert('çµ±åˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                const data = integration.exportResults(format);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
                const blob = new Blob([data], { 
                    type: format === 'json' ? 'application/json' : 'text/csv' 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gemini-history-${Date.now()}.${format}`;
                a.click();
                URL.revokeObjectURL(url);
                
                updateStatus('history-result', `âœ… ${format.toUpperCase()}å½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
            } catch (error) {
                updateStatus('history-result', `âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // å±¥æ­´ã‚¯ãƒªã‚¢
        function clearHistory() {
            if (!integration) {
                alert('çµ±åˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            if (confirm('å®Ÿè¡Œå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                integration.clearHistory();
                updateStatus('history-result', 'âœ… å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `status ${type}`;
            element.innerHTML = message;
        }

        function showResult(elementId, html) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = html;
        }

        function formatExecutionResult(result) {
            let html = '<h3>å®Ÿè¡Œçµæœ</h3>';
            html += `<div class="result-item ${result.success ? 'result-success' : 'result-error'}">`;
            
            if (result.skipped) {
                html += '<strong>ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ</strong>';
            } else {
                html += `<strong>æˆåŠŸ:</strong> ${result.success}<br>`;
                
                if (result.duration) {
                    html += `<strong>å®Ÿè¡Œæ™‚é–“:</strong> ${result.duration}ms<br>`;
                }
                
                if (result.result?.response) {
                    const response = result.result.response;
                    html += `<strong>å¿œç­”:</strong><br>`;
                    html += `<div class="code-block">${escapeHtml(response.substring(0, 500))}${response.length > 500 ? '...' : ''}</div>`;
                    html += `<strong>æ–‡å­—æ•°:</strong> ${response.length}`;
                }
                
                if (result.error) {
                    html += `<strong>ã‚¨ãƒ©ãƒ¼:</strong> ${result.error}`;
                }
            }
            
            html += '</div>';
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', () => {
            console.log('Gemini Spreadsheet Integration Test Page Loaded');
        });
    </script>
</body>
</html>