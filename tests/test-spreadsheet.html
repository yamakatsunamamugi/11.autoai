<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>スプレッドシート読み込みテストツール</title>
  <link rel="stylesheet" href="test-styles.css">
</head>
<body>
  <div class="test-interface">
    <!-- ヘッダー -->
    <header class="app-header">
      <div class="header-content">
        <h1>🔬 スプレッドシート読み込みテストツール</h1>
        <div class="header-subtitle">プロフェッショナル総合テスト環境</div>
      </div>
      <div class="header-actions">
        <button class="btn-icon" id="themeToggle" title="テーマ切り替え">🌙</button>
        <button class="btn-icon" id="helpBtn" title="ヘルプ">❓</button>
      </div>
    </header>

    <!-- コントロールパネル -->
    <div class="control-panel">
      <div class="control-group">
        <label for="spreadsheetUrl">スプレッドシートURL</label>
        <div class="url-input-group">
          <input type="url" id="spreadsheetUrl" class="url-input" 
                 placeholder="https://docs.google.com/spreadsheets/d/..." 
                 value="https://docs.google.com/spreadsheets/d/1C5aOSyyCBXf7HwF-BGGu-cz5jdRwNBaoW4G4ivIRrRg/edit?gid=1633283608#gid=1633283608">
          <button class="btn-secondary" id="savedUrlsBtn">📂 保存済み</button>
        </div>
      </div>
      
      <div class="control-actions">
        <button class="btn-primary" id="loadBtn">
          <span class="btn-icon">📥</span> 読み込み
        </button>
        <button class="btn-secondary" id="stepModeBtn">
          <span class="btn-icon">👣</span> ステップ実行
        </button>
        <button class="btn-secondary" id="autoRunBtn">
          <span class="btn-icon">▶️</span> 自動実行
        </button>
        <button class="btn-danger" id="stopBtn" disabled>
          <span class="btn-icon">⏹️</span> 停止
        </button>
      </div>

      <div class="execution-status">
        <div class="status-indicator" id="statusIndicator">
          <span class="status-dot"></span>
          <span class="status-text">待機中</span>
        </div>
        <div class="progress-bar" id="progressBar">
          <div class="progress-fill"></div>
        </div>
      </div>
    </div>

    <!-- タブナビゲーション -->
    <nav class="tab-navigation">
      <button class="tab-btn active" data-tab="overview">
        <span class="tab-icon">📊</span> 概要
      </button>
      <button class="tab-btn" data-tab="structure">
        <span class="tab-icon">🏗️</span> 構造分析
      </button>
      <button class="tab-btn" data-tab="controls">
        <span class="tab-icon">🎛️</span> 制御情報
      </button>
      <button class="tab-btn" data-tab="tasks">
        <span class="tab-icon">📝</span> タスク生成
      </button>
      <button class="tab-btn" data-tab="debug">
        <span class="tab-icon">🐛</span> デバッグ
      </button>
      <button class="tab-btn" data-tab="performance">
        <span class="tab-icon">⚡</span> パフォーマンス
      </button>
      <button class="tab-btn" data-tab="logs">
        <span class="tab-icon">📜</span> ログ
      </button>
    </nav>

    <!-- メインコンテンツエリア -->
    <div class="main-content">
      <!-- 左側：データビューア -->
      <div class="data-viewer">
        <!-- 概要タブ -->
        <div class="tab-content active" id="overview-tab">
          <div class="overview-container">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="totalRows">-</div>
                <div class="stat-label">総行数</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="workRows">-</div>
                <div class="stat-label">作業行</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="aiColumns">-</div>
                <div class="stat-label">AI列</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="totalTasks">-</div>
                <div class="stat-label">タスク数</div>
              </div>
            </div>
            
            <div class="execution-timeline">
              <h3>実行タイムライン</h3>
              <div id="timelineContainer"></div>
            </div>
          </div>
        </div>

        <!-- 構造分析タブ -->
        <div class="tab-content" id="structure-tab">
          <div class="structure-container">
            <div class="structure-header">
              <h3>スプレッドシート構造分析</h3>
              <p class="tab-description">
                読み込んだスプレッドシートの構造を分析し、特殊行（メニュー、AI、モデル、機能）の検出状況とAI列の配置を確認できます。
                データが正しく解析されているか診断する際に使用します。
              </p>
              <div class="structure-actions">
                <button class="btn-small" id="expandAllBtn">すべて展開</button>
                <button class="btn-small" id="collapseAllBtn">すべて折りたたみ</button>
              </div>
            </div>
            <div id="structureTree"></div>
            <div class="spreadsheet-table-container">
              <h4>スプレッドシートデータプレビュー（最初の20行）</h4>
              <table id="spreadsheetTable" class="spreadsheet-table"></table>
            </div>
          </div>
        </div>

        <!-- 制御情報タブ -->
        <div class="tab-content" id="controls-tab">
          <div class="controls-container">
            <div class="control-section">
              <h3>行制御情報</h3>
              <div id="rowControlsContainer"></div>
            </div>
            <div class="control-section">
              <h3>列制御情報</h3>
              <div id="columnControlsContainer"></div>
            </div>
            <div class="control-section">
              <h3>制御マッピング図</h3>
              <div id="controlMappingDiagram"></div>
            </div>
          </div>
        </div>

        <!-- タスク生成タブ -->
        <div class="tab-content" id="tasks-tab">
          <div class="tasks-container">
            <div class="tasks-header">
              <h3>生成されたタスク</h3>
              <div class="tasks-filter">
                <select id="taskFilterAI">
                  <option value="">すべてのAI</option>
                  <option value="claude">Claude</option>
                  <option value="gemini">Gemini</option>
                  <option value="chatgpt">ChatGPT</option>
                </select>
                <select id="taskFilterStatus">
                  <option value="">すべての状態</option>
                  <option value="executable">実行可能</option>
                  <option value="skipped">スキップ</option>
                </select>
              </div>
            </div>
            <div id="tasksTableContainer"></div>
            <div class="tasks-export">
              <button class="btn-secondary" id="exportTasksBtn">📤 エクスポート</button>
            </div>
          </div>
        </div>

        <!-- デバッグタブ -->
        <div class="tab-content" id="debug-tab">
          <div class="debug-container">
            <div class="debug-toolbar">
              <button class="btn-small" id="nextStepBtn">次へ →</button>
              <button class="btn-small" id="skipStepBtn">スキップ ⏭️</button>
              <button class="btn-small" id="continueBtn">続行 ▶️</button>
              <button class="btn-small" id="addBreakpointBtn">ブレークポイント追加</button>
            </div>
            <div class="debug-split">
              <div class="debug-variables">
                <h3>変数インスペクター</h3>
                <div id="variablesTree"></div>
              </div>
              <div class="debug-console">
                <h3>デバッグコンソール</h3>
                <div id="debugOutput"></div>
                <div class="console-input-wrapper">
                  <input type="text" id="consoleInput" placeholder="コードを入力..." />
                  <button id="executeBtn">実行</button>
                </div>
              </div>
            </div>
            <div class="debug-breakpoints">
              <h3>ブレークポイント</h3>
              <div id="breakpointsList"></div>
            </div>
          </div>
        </div>

        <!-- パフォーマンスタブ -->
        <div class="tab-content" id="performance-tab">
          <div class="performance-container">
            <div class="performance-summary">
              <h3>パフォーマンス測定</h3>
              <p class="tab-description">
                スプレッドシートの読み込みとタスク生成の処理時間を測定します。
                処理が遅い場合の原因分析に使用できます。
              </p>
              <div class="perf-stats">
                <div class="perf-stat">
                  <span class="perf-label">読み込み時間:</span>
                  <span class="perf-value" id="loadTime">-</span>
                </div>
                <div class="perf-stat">
                  <span class="perf-label">タスク生成時間:</span>
                  <span class="perf-value" id="taskGenTime">-</span>
                </div>
                <div class="perf-stat">
                  <span class="perf-label">総実行時間:</span>
                  <span class="perf-value" id="totalExecutionTime">-</span>
                </div>
              </div>
            </div>
            <div class="performance-details">
              <h3>処理ステップ別時間</h3>
              <table id="performanceTable" class="perf-table">
                <thead>
                  <tr>
                    <th>処理ステップ</th>
                    <th>時間 (ms)</th>
                    <th>割合</th>
                  </tr>
                </thead>
                <tbody id="perfTableBody">
                  <tr>
                    <td colspan="3" class="no-data">データなし - スプレッドシートを読み込んでください</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ログタブ -->
        <div class="tab-content" id="logs-tab">
          <div class="logs-container">
            <div class="logs-toolbar">
              <div class="log-filters">
                <label>
                  <input type="checkbox" id="logDebug" checked> DEBUG
                </label>
                <label>
                  <input type="checkbox" id="logInfo" checked> INFO
                </label>
                <label>
                  <input type="checkbox" id="logWarning" checked> WARNING
                </label>
                <label>
                  <input type="checkbox" id="logError" checked> ERROR
                </label>
              </div>
              <div class="log-actions">
                <input type="text" id="logSearch" placeholder="ログを検索..." />
                <button class="btn-small" id="clearLogsBtn">クリア</button>
                <button class="btn-small" id="exportLogsBtn">エクスポート</button>
              </div>
            </div>
            <div class="logs-viewer" id="logsViewer"></div>
          </div>
        </div>
      </div>

      <!-- 右側：詳細パネル -->
      <div class="detail-panel">
        <div class="panel-header">
          <h3>詳細情報</h3>
          <button class="btn-icon panel-toggle" id="panelToggle">◀</button>
        </div>
        <div class="panel-content" id="detailContent">
          <div class="detail-section">
            <h4>現在のステップ</h4>
            <div id="currentStepInfo">待機中...</div>
          </div>
          <div class="detail-section">
            <h4>エラー診断</h4>
            <div id="errorDiagnostics">エラーなし</div>
          </div>
          <div class="detail-section">
            <h4>推奨事項</h4>
            <div id="recommendations">-</div>
          </div>
          <div class="detail-section">
            <h4>比較結果</h4>
            <div id="comparisonResults">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ステータスバー -->
    <footer class="status-bar">
      <div class="status-left">
        <span id="statusText">準備完了</span>
      </div>
      <div class="status-center">
        <span id="progressText">0%</span>
      </div>
      <div class="status-right">
        <span id="memoryStatus">メモリ: -</span>
        <span id="timeStatus">経過時間: 0s</span>
      </div>
    </footer>
  </div>

  <!-- モーダル：保存済みURL -->
  <div class="modal" id="savedUrlsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>保存済みスプレッドシート</h3>
        <button class="modal-close" id="closeSavedUrls">×</button>
      </div>
      <div class="modal-body">
        <div id="savedUrlsList"></div>
        <div class="modal-actions">
          <input type="text" id="newUrlName" placeholder="名前を入力..." />
          <button class="btn-primary" id="saveCurrentUrl">現在のURLを保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- モーダル：ヘルプ -->
  <div class="modal" id="helpModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ヘルプ</h3>
        <button class="modal-close" id="closeHelp">×</button>
      </div>
      <div class="modal-body">
        <div class="help-content">
          <h4>キーボードショートカット</h4>
          <ul class="shortcuts-list">
            <li><kbd>Ctrl+L</kbd> - URLフィールドにフォーカス</li>
            <li><kbd>Ctrl+Enter</kbd> - 読み込み実行</li>
            <li><kbd>F5</kbd> - ステップ実行</li>
            <li><kbd>F8</kbd> - 続行</li>
            <li><kbd>F9</kbd> - ブレークポイント設定</li>
            <li><kbd>Ctrl+K</kbd> - ログクリア</li>
            <li><kbd>Ctrl+S</kbd> - 結果を保存</li>
          </ul>
          
          <h4>機能説明</h4>
          <div class="help-section">
            <h5>ステップ実行モード</h5>
            <p>各処理段階で一時停止し、データの状態を詳細に確認できます。</p>
          </div>
          <div class="help-section">
            <h5>ブレークポイント</h5>
            <p>特定の処理段階で自動的に停止するポイントを設定できます。</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 依存スクリプト -->
  <script src="../src/core/logging-service.js"></script>
  <script src="../src/features/spreadsheet/config.js"></script>
  <script src="../src/features/spreadsheet/url-parser.js"></script>
  <script src="../src/services/auth-service.js"></script>
  <script src="../src/features/spreadsheet/sheets-client.js"></script>
  <script src="../src/features/spreadsheet/reader.js"></script>
  
  <!-- テストツールモジュール -->
  <script type="module" src="test-spreadsheet.js"></script>
</body>
</html>