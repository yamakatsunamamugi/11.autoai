<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レポート機能リファクタリングテスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        button.danger {
            background-color: #f44336;
        }
        
        button.danger:hover {
            background-color: #da190b;
        }
        
        button.info {
            background-color: #2196F3;
        }
        
        button.info:hover {
            background-color: #0b7dda;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .config-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
        }
        
        .config-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        
        .config-item input,
        .config-item select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .log-area {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px;
        }
        
        .log-debug { color: #666; }
        .log-info { color: #333; }
        .log-warn { color: #ff9800; background: #fff3e0; }
        .log-error { color: #f44336; background: #ffebee; }
        .log-success { color: #4CAF50; background: #e8f5e9; }
        
        .status-bar {
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-active { background: #4CAF50; }
        .status-inactive { background: #f44336; }
        .status-processing { background: #ff9800; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .test-results {
            margin-top: 20px;
        }
        
        .result-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: #f5f5f5;
            border-left: 3px solid #2196F3;
        }
        
        .result-success {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .result-error {
            border-left-color: #f44336;
            background: #ffebee;
        }
    </style>
</head>
<body>
    <h1>🔧 レポート機能リファクタリングテスト</h1>

    <div class="status-bar">
        <div>
            <span class="status-indicator status-inactive" id="status-indicator"></span>
            <span id="status-text">準備完了</span>
        </div>
        <div id="status-details"></div>
    </div>

    <div class="section">
        <h2>⚙️ 設定管理</h2>
        <div class="config-grid">
            <div class="config-item">
                <label>デフォルトAIタイプ</label>
                <select id="config-ai-type">
                    <option value="chatgpt">ChatGPT</option>
                    <option value="claude">Claude</option>
                    <option value="gemini">Gemini</option>
                </select>
            </div>
            <div class="config-item">
                <label>並列実行</label>
                <select id="config-parallel">
                    <option value="false">無効</option>
                    <option value="true">有効</option>
                </select>
            </div>
            <div class="config-item">
                <label>最大同時実行数</label>
                <input type="number" id="config-max-concurrent" value="3" min="1" max="10">
            </div>
            <div class="config-item">
                <label>リトライ回数</label>
                <input type="number" id="config-retry" value="3" min="0" max="5">
            </div>
            <div class="config-item">
                <label>ログレベル</label>
                <select id="config-log-level">
                    <option value="debug">Debug</option>
                    <option value="info">Info</option>
                    <option value="warn">Warn</option>
                    <option value="error">Error</option>
                </select>
            </div>
            <div class="config-item">
                <label>キャッシュ</label>
                <select id="config-cache">
                    <option value="true">有効</option>
                    <option value="false">無効</option>
                </select>
            </div>
        </div>
        <div class="button-group">
            <button onclick="applyConfig()">設定を適用</button>
            <button onclick="resetConfig()" class="danger">設定をリセット</button>
            <button onclick="exportConfig()" class="info">設定をエクスポート</button>
        </div>
    </div>

    <div class="section">
        <h2>🧪 ユニットテスト</h2>
        <div class="button-group">
            <button onclick="testTaskFactory()">TaskFactoryテスト</button>
            <button onclick="testExecutor()">Executorテスト</button>
            <button onclick="testConfig()">Configテスト</button>
            <button onclick="testIntegration()">統合テスト</button>
            <button onclick="runAllTests()">全テスト実行</button>
        </div>
        <div class="test-results" id="test-results"></div>
    </div>

    <div class="section">
        <h2>📊 実動作テスト</h2>
        <div class="button-group">
            <button onclick="testCreateTask()">タスク作成</button>
            <button onclick="testExecuteTask()">タスク実行</button>
            <button onclick="testBatchExecution()">バッチ実行</button>
            <button onclick="testFullCycle()">フルサイクル</button>
        </div>
    </div>

    <div class="section">
        <h2>📝 ログ出力</h2>
        <div class="button-group">
            <button onclick="clearLog()">ログをクリア</button>
            <button onclick="downloadLog()" class="info">ログをダウンロード</button>
        </div>
        <div class="log-area" id="log-area"></div>
    </div>

    <script type="module">
        // モジュールのインポート
        import ReportService from '/src/features/report/index.js';
        import { ReportTaskFactory } from '/src/features/report/report-task-factory.js';
        import { ReportExecutor } from '/src/features/report/report-executor.js';
        import { ReportConfig, getReportConfig, resetReportConfig } from '/src/features/report/report-config.js';
        
        // グローバル変数
        let reportService = null;
        let testResults = [];
        
        // 初期化
        window.addEventListener('DOMContentLoaded', () => {
            initializeService();
            addLog('info', 'レポート機能リファクタリングテストツールを初期化しました');
        });
        
        // サービスの初期化
        function initializeService() {
            const config = {
                defaultAIType: document.getElementById('config-ai-type').value,
                execution: {
                    parallel: document.getElementById('config-parallel').value === 'true',
                    maxConcurrent: parseInt(document.getElementById('config-max-concurrent').value),
                    retryAttempts: parseInt(document.getElementById('config-retry').value)
                },
                logging: {
                    level: document.getElementById('config-log-level').value,
                    enabled: true
                },
                performance: {
                    cacheEnabled: document.getElementById('config-cache').value === 'true'
                }
            };
            
            reportService = new ReportService(config);
            updateStatus('active', 'サービス初期化完了');
            
            // グローバルに公開（デバッグ用）
            window.reportService = reportService;
        }
        
        // 設定の適用
        window.applyConfig = function() {
            try {
                initializeService();
                addLog('success', '設定を適用しました');
                showConfigSummary();
            } catch (error) {
                addLog('error', '設定の適用に失敗しました: ' + error.message);
            }
        };
        
        // 設定のリセット
        window.resetConfig = function() {
            resetReportConfig();
            initializeService();
            addLog('info', '設定をリセットしました');
            
            // UIもリセット
            document.getElementById('config-ai-type').value = 'chatgpt';
            document.getElementById('config-parallel').value = 'false';
            document.getElementById('config-max-concurrent').value = '3';
            document.getElementById('config-retry').value = '3';
            document.getElementById('config-log-level').value = 'info';
            document.getElementById('config-cache').value = 'true';
        };
        
        // 設定のエクスポート
        window.exportConfig = function() {
            const config = reportService.getConfig();
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report-config.json';
            a.click();
            URL.revokeObjectURL(url);
            addLog('info', '設定をエクスポートしました');
        };
        
        // TaskFactoryテスト
        window.testTaskFactory = async function() {
            updateStatus('processing', 'TaskFactoryテスト実行中...');
            const results = [];
            
            try {
                // テスト1: 正常なタスク作成
                const factory = new ReportTaskFactory();
                const task = factory.createTask({
                    sourceColumn: 'D',
                    reportColumn: 'V',
                    rowNumber: 5,
                    aiType: 'chatgpt',
                    columnGroup: { promptColumn: 'C', type: 'single' }
                }, {
                    spreadsheetId: 'test-id',
                    gid: '0'
                });
                
                results.push({
                    name: 'タスク作成',
                    success: task && task.id && task.taskType === 'report',
                    message: task ? 'タスクが正常に作成されました' : 'タスク作成失敗'
                });
                
                // テスト2: パラメータ検証
                let validationError = null;
                try {
                    factory.createTask({}, {});
                } catch (error) {
                    validationError = error;
                }
                
                results.push({
                    name: 'パラメータ検証',
                    success: validationError !== null,
                    message: validationError ? '検証が正常に動作しています' : '検証エラーが発生しませんでした'
                });
                
            } catch (error) {
                results.push({
                    name: 'TaskFactory全体',
                    success: false,
                    message: error.message
                });
            }
            
            displayTestResults(results);
            updateStatus('active', 'TaskFactoryテスト完了');
        };
        
        // Executorテスト
        window.testExecutor = async function() {
            updateStatus('processing', 'Executorテスト実行中...');
            const results = [];
            
            try {
                const executor = new ReportExecutor();
                
                // テストタスク
                const testTask = {
                    id: 'test-task-1',
                    taskType: 'report',
                    sourceColumn: 'D',
                    reportColumn: 'V',
                    row: 5,
                    promptColumn: 'C',
                    metadata: {
                        originalPrompt: 'テストプロンプト',
                        aiAnswer: 'テスト回答'
                    }
                };
                
                // テスト用スプレッドシートデータ
                const testData = {
                    spreadsheetId: 'test-id',
                    gid: '0',
                    values: [
                        ['番号', '制御', 'プロンプト', '回答', 'レポート'],
                        ['1', '', 'テスト質問', 'テスト回答', '']
                    ]
                };
                
                results.push({
                    name: 'Executor初期化',
                    success: true,
                    message: 'Executorが正常に初期化されました'
                });
                
            } catch (error) {
                results.push({
                    name: 'Executor全体',
                    success: false,
                    message: error.message
                });
            }
            
            displayTestResults(results);
            updateStatus('active', 'Executorテスト完了');
        };
        
        // Configテスト
        window.testConfig = async function() {
            updateStatus('processing', 'Configテスト実行中...');
            const results = [];
            
            try {
                // テスト1: デフォルト設定
                const config = new ReportConfig();
                results.push({
                    name: 'デフォルト設定',
                    success: config.get('defaultAIType') === 'chatgpt',
                    message: 'デフォルト設定が正しく初期化されました'
                });
                
                // テスト2: 設定の更新
                config.set('execution.parallel', true);
                results.push({
                    name: '設定更新',
                    success: config.get('execution.parallel') === true,
                    message: '設定が正しく更新されました'
                });
                
                // テスト3: 設定の検証
                let validationError = null;
                try {
                    config.set('defaultAIType', 'invalid-ai');
                    config.validateConfig();
                } catch (error) {
                    validationError = error;
                }
                
                results.push({
                    name: '設定検証',
                    success: validationError !== null,
                    message: '不正な設定が正しく検出されました'
                });
                
            } catch (error) {
                results.push({
                    name: 'Config全体',
                    success: false,
                    message: error.message
                });
            }
            
            displayTestResults(results);
            updateStatus('active', 'Configテスト完了');
        };
        
        // 統合テスト
        window.testIntegration = async function() {
            updateStatus('processing', '統合テスト実行中...');
            const results = [];
            
            try {
                // サービス全体の統合テスト
                const service = new ReportService();
                
                // テスト1: サービス初期化
                results.push({
                    name: 'サービス初期化',
                    success: service !== null,
                    message: 'サービスが正常に初期化されました'
                });
                
                // テスト2: タスク作成
                const task = service.createTask({
                    sourceColumn: 'D',
                    reportColumn: 'V',
                    rowNumber: 5,
                    aiType: 'chatgpt',
                    columnGroup: { promptColumn: 'C', type: 'single' }
                }, {
                    spreadsheetId: 'test-id',
                    gid: '0'
                });
                
                results.push({
                    name: 'タスク作成（統合）',
                    success: task !== null,
                    message: 'タスクが正常に作成されました'
                });
                
                // テスト3: ステータス取得
                const status = service.getStatus();
                results.push({
                    name: 'ステータス取得',
                    success: status && status.isEnabled,
                    message: 'ステータスが正常に取得できました'
                });
                
            } catch (error) {
                results.push({
                    name: '統合テスト全体',
                    success: false,
                    message: error.message
                });
            }
            
            displayTestResults(results);
            updateStatus('active', '統合テスト完了');
        };
        
        // 全テスト実行
        window.runAllTests = async function() {
            clearTestResults();
            await testTaskFactory();
            await testExecutor();
            await testConfig();
            await testIntegration();
            addLog('success', '全テストが完了しました');
        };
        
        // テスト結果の表示
        function displayTestResults(results) {
            const container = document.getElementById('test-results');
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `result-item ${result.success ? 'result-success' : 'result-error'}`;
                div.innerHTML = `
                    <strong>${result.success ? '✅' : '❌'} ${result.name}</strong>
                    <div>${result.message}</div>
                `;
                container.appendChild(div);
            });
        }
        
        // テスト結果のクリア
        function clearTestResults() {
            document.getElementById('test-results').innerHTML = '';
        }
        
        // ログ追加
        function addLog(level, message) {
            const logArea = document.getElementById('log-area');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // ログクリア
        window.clearLog = function() {
            document.getElementById('log-area').innerHTML = '';
            addLog('info', 'ログをクリアしました');
        };
        
        // ログダウンロード
        window.downloadLog = function() {
            const logArea = document.getElementById('log-area');
            const text = logArea.innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report-test-log.txt';
            a.click();
            URL.revokeObjectURL(url);
        };
        
        // ステータス更新
        function updateStatus(type, message) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            indicator.className = `status-indicator status-${type}`;
            text.textContent = message;
        }
        
        // 設定サマリー表示
        function showConfigSummary() {
            const summary = reportService.getStatus().configSummary;
            const details = document.getElementById('status-details');
            details.textContent = `AI: ${summary.defaultAIType} | 並列: ${summary.parallelExecution ? '有効' : '無効'} | キャッシュ: ${summary.cacheEnabled ? '有効' : '無効'}`;
        }
        
        // 実動作テスト関数
        window.testCreateTask = function() {
            try {
                const task = reportService.createTask({
                    sourceColumn: 'D',
                    reportColumn: 'V',
                    rowNumber: 10,
                    aiType: 'chatgpt',
                    columnGroup: { promptColumn: 'C', type: 'single' }
                }, {
                    spreadsheetId: 'demo-spreadsheet',
                    gid: '0'
                });
                
                addLog('success', `タスクを作成しました: ${task.id}`);
                console.log('作成されたタスク:', task);
            } catch (error) {
                addLog('error', `タスク作成エラー: ${error.message}`);
            }
        };
        
        window.testExecuteTask = function() {
            addLog('info', 'タスク実行テストは実際のAPIが必要なため、シミュレーションのみ実行します');
        };
        
        window.testBatchExecution = function() {
            addLog('info', 'バッチ実行テストは実際のAPIが必要なため、シミュレーションのみ実行します');
        };
        
        window.testFullCycle = function() {
            addLog('info', 'フルサイクルテストは実際のAPIが必要なため、シミュレーションのみ実行します');
        };
    </script>
</body>
</html>