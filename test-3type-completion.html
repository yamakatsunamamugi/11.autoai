<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3種類AI完了待機機能テスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a67d8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        .log-time {
            color: #888;
            margin-right: 10px;
        }
        .log-success {
            color: #4caf50;
        }
        .log-error {
            color: #f44336;
        }
        .log-warning {
            color: #ff9800;
        }
        .log-info {
            color: #2196f3;
        }
        .task-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .task-cell {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
            background: #fff;
        }
        .task-cell.header {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        .task-cell.pending {
            background: #f0f0f0;
        }
        .task-cell.processing {
            background: #fff3cd;
            animation: pulse 1s infinite;
        }
        .task-cell.completed {
            background: #d4edda;
        }
        .task-cell.blocked {
            background: #f8d7da;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 3種類AI完了待機機能テスト</h1>
        
        <div class="test-section">
            <div class="test-title">テスト設定</div>
            <div class="test-controls">
                <button id="initTest">テスト初期化</button>
                <button id="startTest" disabled>テスト開始</button>
                <button id="simulateCompletion" disabled>完了をシミュレート</button>
                <button id="clearLog">ログクリア</button>
            </div>
            
            <div class="task-grid" id="taskGrid">
                <!-- ヘッダー行 -->
                <div class="task-cell header">列/行</div>
                <div class="task-cell header">D列<br>ChatGPT</div>
                <div class="task-cell header">E列<br>Claude</div>
                <div class="task-cell header">F列<br>Gemini</div>
                <div class="task-cell header">H列<br>次の処理</div>
                <div class="task-cell header">状態</div>
                
                <!-- 行9 -->
                <div class="task-cell header">行9</div>
                <div class="task-cell pending" id="cell-D9">待機中</div>
                <div class="task-cell pending" id="cell-E9">待機中</div>
                <div class="task-cell pending" id="cell-F9">待機中</div>
                <div class="task-cell blocked" id="cell-H9">ブロック中</div>
                <div class="task-cell" id="status-9">-</div>
                
                <!-- 行10 -->
                <div class="task-cell header">行10</div>
                <div class="task-cell pending" id="cell-D10">待機中</div>
                <div class="task-cell pending" id="cell-E10">待機中</div>
                <div class="task-cell pending" id="cell-F10">待機中</div>
                <div class="task-cell blocked" id="cell-H10">ブロック中</div>
                <div class="task-cell" id="status-10">-</div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">実行ログ</div>
            <div class="log-area" id="logArea"></div>
        </div>
    </div>

    <script>
        // テストデータとモック
        class MockStreamProcessor {
            constructor() {
                this.groupCompletionTracker = new Map();
                this.completedTasks = new Set();
                this.logger = {
                    log: (msg, data) => addLog(msg, 'info', data)
                };
            }
            
            initializeGroupTracking(task) {
                if (!task.multiAI || !task.groupId) return;
                
                const trackerKey = `${task.groupId}_${task.row}`;
                if (!this.groupCompletionTracker.has(trackerKey)) {
                    this.groupCompletionTracker.set(trackerKey, {
                        required: new Set(['chatgpt', 'claude', 'gemini']),
                        completed: new Set()
                    });
                    addLog(`グループトラッカー初期化: ${trackerKey}`, 'info');
                }
            }
            
            updateGroupCompletion(task) {
                if (!task.multiAI || !task.groupId) return;
                
                const trackerKey = `${task.groupId}_${task.row}`;
                const tracker = this.groupCompletionTracker.get(trackerKey);
                
                if (tracker) {
                    tracker.completed.add(task.aiType);
                    const progress = `${tracker.completed.size}/${tracker.required.size}`;
                    addLog(`グループ進捗更新: ${trackerKey}, 完了: ${task.aiType}, 状況: ${progress}`, 'info');
                    
                    // UI更新
                    updateTaskCell(task.column, task.row, 'completed');
                    updateStatus(task.row, progress);
                }
            }
            
            isGroupComplete(groupId, row) {
                const trackerKey = `${groupId}_${row}`;
                const tracker = this.groupCompletionTracker.get(trackerKey);
                
                if (!tracker) return true;
                
                for (const requiredAI of tracker.required) {
                    if (!tracker.completed.has(requiredAI)) {
                        addLog(`グループ未完了: ${trackerKey}, 待機中: ${requiredAI}`, 'warning');
                        return false;
                    }
                }
                
                addLog(`グループ完了: ${trackerKey}`, 'success');
                return true;
            }
            
            async checkAndStartNextColumnForRow(column, row, currentTask) {
                addLog(`次列チェック: ${column}${row}`, 'info');
                
                if (currentTask?.multiAI && currentTask?.groupId) {
                    if (!this.isGroupComplete(currentTask.groupId, row)) {
                        addLog(`3種類AI未完了のため次列開始を保留: ${column}${row}`, 'warning');
                        return false;
                    }
                    addLog(`3種類AIグループ完了確認: ${column}${row}`, 'success');
                }
                
                // 次の列（H列）を開始
                addLog(`次列開始可能: H${row}`, 'success');
                updateTaskCell('H', row, 'processing');
                return true;
            }
        }
        
        let processor;
        let currentTasks = [];
        
        // ログ関数
        function addLog(message, type = 'info', data = null) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const logContent = `<span class="log-time">${time}</span><span class="log-${type}">${message}</span>`;
            logEntry.innerHTML = logContent;
            
            if (data) {
                logEntry.innerHTML += `\n<span style="margin-left: 60px; color: #888;">${JSON.stringify(data, null, 2)}</span>`;
            }
            
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // UI更新関数
        function updateTaskCell(column, row, status) {
            const cellId = `cell-${column}${row}`;
            const cell = document.getElementById(cellId);
            if (cell) {
                cell.className = `task-cell ${status}`;
                switch(status) {
                    case 'pending': cell.textContent = '待機中'; break;
                    case 'processing': cell.textContent = '処理中'; break;
                    case 'completed': cell.textContent = '完了'; break;
                    case 'blocked': cell.textContent = 'ブロック中'; break;
                }
            }
        }
        
        function updateStatus(row, status) {
            const statusCell = document.getElementById(`status-${row}`);
            if (statusCell) {
                statusCell.textContent = status;
            }
        }
        
        // テストタスク生成
        function createTestTasks() {
            const tasks = [];
            const rows = [9, 10];
            const aiTypes = [
                { column: 'D', aiType: 'chatgpt' },
                { column: 'E', aiType: 'claude' },
                { column: 'F', aiType: 'gemini' }
            ];
            
            rows.forEach(row => {
                aiTypes.forEach(ai => {
                    tasks.push({
                        id: `task-${ai.column}${row}`,
                        column: ai.column,
                        row: row,
                        aiType: ai.aiType,
                        multiAI: true,
                        groupId: `group_row${row}_3type_3`,
                        prompt: `テストプロンプト ${row}`
                    });
                });
            });
            
            return tasks;
        }
        
        // イベントリスナー
        document.getElementById('initTest').addEventListener('click', () => {
            processor = new MockStreamProcessor();
            currentTasks = createTestTasks();
            
            addLog('テスト環境を初期化しました', 'success');
            addLog(`生成したタスク数: ${currentTasks.length}`, 'info');
            
            // UIリセット
            ['D', 'E', 'F'].forEach(col => {
                [9, 10].forEach(row => {
                    updateTaskCell(col, row, 'pending');
                });
            });
            ['H'].forEach(col => {
                [9, 10].forEach(row => {
                    updateTaskCell(col, row, 'blocked');
                });
            });
            [9, 10].forEach(row => {
                updateStatus(row, '-');
            });
            
            document.getElementById('startTest').disabled = false;
            document.getElementById('simulateCompletion').disabled = false;
        });
        
        document.getElementById('startTest').addEventListener('click', () => {
            addLog('===== テスト開始 =====', 'success');
            
            // 各タスクのグループ追跡を初期化
            currentTasks.forEach(task => {
                processor.initializeGroupTracking(task);
            });
            
            addLog('グループ追跡の初期化完了', 'info');
        });
        
        document.getElementById('simulateCompletion').addEventListener('click', () => {
            // 順番にタスクを完了させる
            const sequence = [
                { column: 'D', row: 9, aiType: 'chatgpt', expectNext: false },
                { column: 'E', row: 9, aiType: 'claude', expectNext: false },
                { column: 'F', row: 9, aiType: 'gemini', expectNext: true },
                { column: 'D', row: 10, aiType: 'chatgpt', expectNext: false },
                { column: 'E', row: 10, aiType: 'claude', expectNext: false },
                { column: 'F', row: 10, aiType: 'gemini', expectNext: true }
            ];
            
            let index = 0;
            const interval = setInterval(() => {
                if (index >= sequence.length) {
                    clearInterval(interval);
                    addLog('===== シミュレーション完了 =====', 'success');
                    return;
                }
                
                const step = sequence[index];
                const task = currentTasks.find(t => 
                    t.column === step.column && t.row === step.row
                );
                
                if (task) {
                    addLog(`\n----- ${step.column}${step.row} (${step.aiType}) 完了 -----`, 'info');
                    
                    // タスク完了をシミュレート
                    updateTaskCell(step.column, step.row, 'processing');
                    setTimeout(() => {
                        processor.updateGroupCompletion(task);
                        
                        // 次列開始チェック
                        const canProceed = processor.checkAndStartNextColumnForRow(
                            step.column, 
                            step.row, 
                            task
                        );
                        
                        if (step.expectNext && canProceed) {
                            addLog(`✅ 期待通り: 次の列が開始可能になりました`, 'success');
                        } else if (!step.expectNext && !canProceed) {
                            addLog(`✅ 期待通り: 次の列はまだブロックされています`, 'success');
                        } else {
                            addLog(`❌ 予期しない結果`, 'error');
                        }
                    }, 500);
                }
                
                index++;
            }, 1500);
        });
        
        document.getElementById('clearLog').addEventListener('click', () => {
            document.getElementById('logArea').innerHTML = '';
            addLog('ログをクリアしました', 'info');
        });
        
        // 初期ログ
        addLog('3種類AI完了待機機能テストページ', 'info');
        addLog('「テスト初期化」をクリックして開始してください', 'info');
    </script>
</body>
</html>