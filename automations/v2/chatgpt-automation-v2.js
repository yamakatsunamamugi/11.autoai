/**
 * @fileoverview ChatGPT Automation V2 - „ÉÜ„Çπ„ÉàÊ∏à„Åø„Ç≥„Éº„Éâ„Éô„Éº„ÇπÁâà
 * 
 * ÁâπÂæ¥:
 * - „ÉÜ„Çπ„ÉàÊ∏à„Åø„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
 * - „É¢„Éá„É´ÈÅ∏Êäû„ÉªÊ©üËÉΩÈÅ∏Êäû„ÉªÂøúÁ≠îÂæÖÊ©ü„Éª„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó„ÅÆÂÆåÂÖ®ÁßªÊ§ç
 * - Deep Research/„Ç®„Éº„Ç∏„Çß„É≥„Éà„É¢„Éº„ÉâÂØæÂøúÔºàÊúÄÂ§ß40ÂàÜÂæÖÊ©üÔºâ
 * - ChatGPT CanvasÊ©üËÉΩÂØæÂøúÔºàprosemirror-editor-container„Åã„Çâ„ÅÆÂèñÂæóÔºâ
 * 
 * @version 2.2.0
 * @updated 2024-12-05 CanvasÊ©üËÉΩ„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó„ÇíÂÑ™ÂÖàÁöÑ„Å´Âá¶ÁêÜ
 */
(function() {
    'use strict';
    
    console.log(`ChatGPT Automation V2 - ÂàùÊúüÂåñÊôÇÂàª: ${new Date().toLocaleString('ja-JP')}`);
    
    // ui-selectors„Åã„Çâ„Ç§„É≥„Éù„Éº„ÉàÔºàChromeÊã°ÂºµÊ©üËÉΩ„ÅÆ„Ç§„É≥„Ç∏„Çß„ÇØ„Éà„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºâ
    const UI_SELECTORS = window.UI_SELECTORS || {};
    const ChatGPTSelectors = UI_SELECTORS.ChatGPT || {};
    
    // ========================================
    // „Çª„É¨„ÇØ„ÇøÂÆöÁæ©Ôºàui-selectors„Åã„Çâ„Éû„Éº„Ç∏„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ‰ªò„ÅçÔºâ
    // ========================================
    const SELECTORS = {
        // „É¢„Éá„É´Èñ¢ÈÄ£
        modelButton: [
            '[data-testid="model-switcher-dropdown-button"]',
            'button[aria-label*="„É¢„Éá„É´ „Çª„É¨„ÇØ„Çø„Éº"]',
            'button[aria-label*="„É¢„Éá„É´"][aria-haspopup="menu"]',
            '#radix-\\:r2m\\:',
            'button.group.flex.cursor-pointer[aria-haspopup="menu"]'
        ],
        modelMenu: [
            '[role="menu"][data-radix-menu-content]',
            '[role="menu"][data-state="open"]',
            'div.z-50.max-w-xs.rounded-2xl.popover[role="menu"]',
            '[aria-labelledby*="radix"][role="menu"]',
            'div[data-radix-popper-content-wrapper] [role="menu"]'
        ],
        legacyButton: [
            '[data-testid="„É¨„Ç¨„Ç∑„Éº„É¢„Éá„É´-submenu"]',
            '[role="menuitem"][data-has-submenu]:contains("„É¨„Ç¨„Ç∑„Éº„É¢„Éá„É´")',
            'div.__menu-item:contains("„É¨„Ç¨„Ç∑„Éº„É¢„Éá„É´")',
            '[role="menuitem"][aria-haspopup="menu"]:last-of-type'
        ],
        legacyMenu: [
            '[role="menu"][data-side="right"]',
            'div[data-side="right"][role="menu"]',
            '[role="menu"]:not([data-side="bottom"])',
            'div.mt-2.max-h-\\[calc\\(100vh-300px\\)\\][role="menu"]'
        ],
        // Ê©üËÉΩÈñ¢ÈÄ£
        menuButton: [
            '[data-testid="composer-plus-btn"]',
            'button[aria-haspopup="menu"]',
            '#radix-\\:R2eij4im4pact9a4mj5\\:',
            'button.composer-btn',
            'div[class*="leading"] button'
        ],
        mainMenu: [
            '[role="menu"][data-state="open"]',
            '[data-radix-menu-content]',
            'div[data-side="bottom"][role="menu"]',
            'div.popover[role="menu"]',
            '[role="menu"]'
        ],
        subMenu: [
            '[role="menu"][data-side="right"]',
            'div[data-side="right"][role="menu"]',
            '[data-align="start"][role="menu"]:last-of-type'
        ],
        // ÂÖ•Âäõ„ÉªÈÄÅ‰ø°Èñ¢ÈÄ£
        textInput: [
            '.ProseMirror',
            '#prompt-textarea',
            '[contenteditable="true"][translate="no"]',
            'div[data-virtualkeyboard="true"]',
            'div.ProseMirror.text-token-text-primary',
            '.ql-editor'
        ],
        sendButton: [
            '[data-testid="send-button"]',
            '#composer-submit-button',
            'button[aria-label="„Éó„É≠„É≥„Éó„Éà„ÇíÈÄÅ‰ø°„Åô„Çã"]',
            'button.composer-submit-btn.composer-submit-button-color',
            'button:has(svg[width="20"][height="20"])'
        ],
        stopButton: [
            '[data-testid="stop-button"]',
            '#composer-submit-button[aria-label="„Çπ„Éà„É™„Éº„Éü„É≥„Ç∞„ÅÆÂÅúÊ≠¢"]',
            'button.composer-submit-btn.composer-secondary-button-color',
            'button:has(svg path[d*="M4.5 5.75"])'
        ],
        // ÁµêÊûúÂèñÂæóÈñ¢ÈÄ£
        canvasText: [
            'div.markdown.prose',
            'div.w-full.pt-1.pb-1',
            'div.markdown-new-styling'
        ],
        normalText: [
            '[data-message-author-role="assistant"]',
            'div.text-message',
            'div.min-h-8.text-message'
        ]
    };
    
    // ========================================
    // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞Ôºà„ÉÜ„Çπ„Éà„Ç≥„Éº„Éâ„Çà„ÇäÔºâ
    // ========================================
    
    // ÂæÖÊ©üÈñ¢Êï∞
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    
    // „É≠„Ç∞Âá∫Âäõ
    function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('ja-JP', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const prefix = `[${timestamp}]`;
        
        switch(type) {
            case 'error':
                console.error(`${prefix} ‚ùå ${message}`);
                break;
            case 'success':
                console.log(`${prefix} ‚úÖ ${message}`);
                break;
            case 'warning':
                console.warn(`${prefix} ‚ö†Ô∏è ${message}`);
                break;
            case 'step':
                console.log(`${prefix} üìç ${message}`);
                break;
            default:
                console.log(`${prefix} ‚ÑπÔ∏è ${message}`);
        }
    }
    
    // Ë£ÖÈ£æË¶ÅÁ¥†„ÇíÈô§Â§ñ„Åó„Åü„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó
    function getCleanText(element) {
        if (!element) return '';
        const clone = element.cloneNode(true);
        // Ë£ÖÈ£æË¶ÅÁ¥†„ÇíÂâäÈô§
        const decorativeElements = clone.querySelectorAll('mat-icon, mat-ripple, svg, .icon, .ripple');
        decorativeElements.forEach(el => el.remove());
        return clone.textContent?.trim() || '';
    }
    
    // React „Ç§„Éô„É≥„Éà„Éà„É™„Ç¨„Éº
    function triggerReactEvent(element, eventType, eventData = {}) {
        try {
            if (eventType === 'click') {
                element.click();
                return true;
            } else if (eventType === 'pointer') {
                const pointerDown = new PointerEvent('pointerdown', {
                    bubbles: true,
                    cancelable: true,
                    view: window,
                    ...eventData
                });
                const pointerUp = new PointerEvent('pointerup', {
                    bubbles: true,
                    cancelable: true,
                    view: window,
                    ...eventData
                });
                element.dispatchEvent(pointerDown);
                element.dispatchEvent(pointerUp);
                return true;
            }
            return false;
        } catch (error) {
            log(`React „Ç§„Éô„É≥„Éà„Éà„É™„Ç¨„ÉºÂ§±Êïó: ${error.message}`, 'error');
            return false;
        }
    }
    
    // Ë¶ÅÁ¥†„ÅåÂèØË¶ñ„Åã„Å§„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    function isElementInteractable(element) {
        if (!element) return false;
        const rect = element.getBoundingClientRect();
        const style = window.getComputedStyle(element);
        return rect.width > 0 && 
               rect.height > 0 && 
               style.display !== 'none' && 
               style.visibility !== 'hidden' && 
               style.opacity !== '0';
    }
    
    // Ë§áÊï∞„Çª„É¨„ÇØ„Çø„ÅßË¶ÅÁ¥†Ê§úÁ¥¢
    async function findElement(selectors, description, maxRetries = 3) {
        for (let retry = 0; retry < maxRetries; retry++) {
            for (const selector of selectors) {
                try {
                    let element;
                    
                    if (selector.includes(':contains(')) {
                        const match = selector.match(/\:contains\("([^"]+)"\)/);
                        if (match) {
                            const text = match[1];
                            const baseSelector = selector.split(':contains(')[0];
                            const elements = document.querySelectorAll(baseSelector || '*');
                            element = Array.from(elements).find(el => 
                                el.textContent && el.textContent.includes(text)
                            );
                        }
                    } else {
                        element = document.querySelector(selector);
                    }
                    
                    if (element && isElementInteractable(element)) {
                        return element;
                    }
                } catch (e) {
                    // „Çª„É¨„ÇØ„Çø„Ç®„É©„Éº„ÇíÁÑ°Ë¶ñ
                }
            }
            
            if (retry < maxRetries - 1) {
                await sleep(500);
            }
        }
        
        return null;
    }
    
    // „ÉÜ„Ç≠„Çπ„Éà„ÅßË¶ÅÁ¥†„ÇíÊ§úÁ¥¢
    function findElementByText(selector, text, parent = document) {
        const elements = parent.querySelectorAll(selector);
        for (const el of elements) {
            if (el.textContent && el.textContent.includes(text)) {
                return el;
            }
        }
        return null;
    }
    
    // ========================================
    // Deep Research/„Ç®„Éº„Ç∏„Çß„É≥„Éà„É¢„Éº„ÉâÂ∞ÇÁî®Âá¶ÁêÜÔºà„ÉÜ„Çπ„Éà„Ç≥„Éº„Éâ„Çà„ÇäÔºâ
    // ========================================
    async function handleSpecialModeWaiting() {
        try {
            log('„ÄêDeep Research/„Ç®„Éº„Ç∏„Çß„É≥„Éà„É¢„Éº„ÉâÁâπÂà•Âá¶ÁêÜ„ÄëÈñãÂßã', 'step');
            log('ÊúÄÂ§ßÂõûÁ≠îÂæÖÊ©üÊôÇÈñì: 40ÂàÜ', 'info');
            
            // 1-1: ÈÄÅ‰ø°ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÂá∫„Å¶„Åè„Çã„Åæ„ÅßÂæÖÊ©ü
            log('1-1. ÈÄÅ‰ø°Âæå„ÄÅÂõûÁ≠îÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÂá∫„Å¶„Åè„Çã„Åæ„ÅßÂæÖÊ©ü', 'step');
            let stopBtn = null;
            for (let i = 0; i < 60; i++) {
                stopBtn = await findElement(SELECTORS.stopButton, 'ÂÅúÊ≠¢„Éú„Çø„É≥', 1);
                if (stopBtn) {
                    log(`ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åó„Åü (${i+1}ÁßíÂæå)`, 'success');
                    break;
                }
                if (i % 10 === 0 && i > 0) {
                    log(`ÂÅúÊ≠¢„Éú„Çø„É≥ÂæÖÊ©ü‰∏≠... ${i}ÁßíÁµåÈÅé`, 'info');
                }
                await sleep(1000);
            }
            
            if (!stopBtn) {
                log('ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü', 'warning');
                return false;
            }
            
            // 1-2: 2ÂàÜÈñìÂæÖÊ©ü„Åó„Å¶ÂÅúÊ≠¢„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
            log('1-2. ÂõûÁ≠îÈÄÅ‰ø°Âæå„ÄÅ2ÂàÜÈñìÂæÖÊ©ü„ÄÇ2ÂàÜ‰ª•ÂÜÖ„Å´ÂõûÁ≠îÂÅúÊ≠¢„ÅåÊ∂àÊªÖ„Åó„Åü„Çâ1-3„Å∏„ÄÅ2ÂàÜÂæÖÊ©üÂæå„ÅØ1-4„Å∏', 'step');
            const twoMinutes = 120; // 2ÂàÜ = 120Áßí
            let disappeared = false;
            
            for (let i = 0; i < twoMinutes; i++) {
                stopBtn = await findElement(SELECTORS.stopButton, 'ÂÅúÊ≠¢„Éú„Çø„É≥', 1);
                
                if (!stopBtn) {
                    disappeared = true;
                    const minutes = Math.floor(i / 60);
                    const seconds = i % 60;
                    log(`ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü (${minutes}ÂàÜ${seconds}Áßí„ÅßÂÆå‰∫Ü)`, 'info');
                    break;
                }
                
                if (i % 30 === 0 && i > 0) {
                    const minutes = Math.floor(i / 60);
                    const seconds = i % 60;
                    log(`ÂÅúÊ≠¢„Éú„Çø„É≥Â≠òÂú®Á¢∫Ë™ç‰∏≠... (${minutes}ÂàÜ${seconds}ÁßíÁµåÈÅé / 2ÂàÜ„Åæ„Åß)`, 'info');
                }
                
                await sleep(1000);
            }
            
            // 1-3: 2ÂàÜ‰ª•ÂÜÖ„Å´ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÊ∂àÊªÖ„Åó„ÅüÂ†¥Âêà
            if (disappeared) {
                log('1-3. ÂõûÁ≠îÂÅúÊ≠¢„Åå2ÂàÜ‰ª•ÂÜÖ„Å´Ê∂àÊªÖ„Åó„Åü„Åü„ÇÅ„ÄÅ„Äå„ÅÑ„ÅÑ„Åã„ÇâÂÖÉ„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÁ¢∫Ë™ç„Åó„Å¶‰ΩúÊ•≠„Çí„Åó„Å¶„Äç„Å®ÂÜçÈÄÅ‰ø°', 'step');
                
                await sleep(2000); // Â∞ë„ÅóÂæÖÊ©ü
                
                // „ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÊ¨Ñ„ÇíÂèñÂæó
                const input = await findElement(SELECTORS.textInput, '„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÊ¨Ñ');
                if (!input) {
                    log('ÂÖ•ÂäõÊ¨Ñ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                    return false;
                }
                
                const retryMessage = '„ÅÑ„ÅÑ„Åã„ÇâÂÖÉ„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÁ¢∫Ë™ç„Åó„Å¶‰ΩúÊ•≠„Çí„Åó„Å¶';
                
                // ÂÖÉ„ÅÆ„Ç≥„Éº„Éâ„ÅÆÂÖ•ÂäõÂá¶ÁêÜ„Çí‰ΩøÁî®
                if (input.classList.contains('ProseMirror') || input.classList.contains('ql-editor')) {
                    input.innerHTML = '';
                    const p = document.createElement('p');
                    p.textContent = retryMessage;
                    input.appendChild(p);
                    input.classList.remove('ql-blank');
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                } else {
                    input.textContent = retryMessage;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                log(`ÂÜçÈÄÅ‰ø°„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÂÆå‰∫Ü: "${retryMessage}"`, 'success');
                await sleep(1000);
                
                // ÈÄÅ‰ø°„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
                const sendBtn = await findElement(SELECTORS.sendButton, 'ÈÄÅ‰ø°„Éú„Çø„É≥');
                if (sendBtn) {
                    sendBtn.click();
                    log('ÂÜçÈÄÅ‰ø°„Åó„Åæ„Åó„Åü', 'success');
                    await sleep(3000);
                    
                    // ÂÜçÈÄÅ‰ø°Âæå„ÄÅÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÂÜçÂá∫Áèæ„Åô„Çã„ÅÆ„ÇíÂæÖ„Å§
                    for (let i = 0; i < 30; i++) {
                        stopBtn = await findElement(SELECTORS.stopButton, 'ÂÅúÊ≠¢„Éú„Çø„É≥', 1);
                        if (stopBtn) {
                            log('ÂÜçÈÄÅ‰ø°Âæå„ÄÅÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÂÜçË°®Á§∫„Åï„Çå„Åæ„Åó„Åü', 'success');
                            break;
                        }
                        await sleep(1000);
                    }
                } else {
                    log('ÈÄÅ‰ø°„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                }
            } else {
                log('2ÂàÜÈñìÁµåÈÅé„ÄÇÂÅúÊ≠¢„Éú„Çø„É≥„ÅØÊ∂àÊªÖ„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü', 'info');
            }
            
            // 1-4: ÂõûÁ≠îÂÅúÊ≠¢„Éú„Çø„É≥„Åå10ÁßíÈñìÈÄ£Á∂ö„ÅßÊ∂àÊªÖ„Åô„Çã„Åæ„ÅßÂæÖÊ©üÔºàÊúÄÂ§ß40ÂàÜÔºâ
            log('1-4. ÂõûÁ≠îÂÅúÊ≠¢„Éú„Çø„É≥„Åå10ÁßíÈñìÈÄ£Á∂ö„ÅßÊ∂àÊªÖ„Åô„Çã„Åæ„ÅßÂæÖÊ©üÔºàÊúÄÂ§ß40ÂàÜÔºâ', 'step');
            
            const maxWaitTime = 40 * 60; // 40ÂàÜ = 2400Áßí
            let consecutiveAbsent = 0;
            
            for (let i = 0; i < maxWaitTime; i++) {
                stopBtn = await findElement(SELECTORS.stopButton, 'ÂÅúÊ≠¢„Éú„Çø„É≥', 1);
                
                if (!stopBtn) {
                    consecutiveAbsent++;
                    if (consecutiveAbsent <= 10) {
                        log(`ÂÅúÊ≠¢„Éú„Çø„É≥‰∏çÂú®: ${consecutiveAbsent}ÁßíÈÄ£Á∂ö`, 'info');
                    }
                    
                    if (consecutiveAbsent >= 10) {
                        log('ÂÅúÊ≠¢„Éú„Çø„É≥„Åå10ÁßíÈñìÈÄ£Á∂ö„ÅßÊ∂àÊªÖ„Åó„Åæ„Åó„Åü„ÄÇÂøúÁ≠îÂÆå‰∫ÜÔºÅ', 'success');
                        break;
                    }
                } else {
                    if (consecutiveAbsent > 0) {
                        log('ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÂÜçË°®Á§∫„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Ç´„Ç¶„É≥„Éà„É™„Çª„ÉÉ„Éà', 'info');
                    }
                    consecutiveAbsent = 0;
                }
                
                // 30Áßí„Åî„Å®„Å´ÈÄ≤ÊçóË°®Á§∫
                if (i % 30 === 0 && i > 0) {
                    const minutes = Math.floor(i / 60);
                    const seconds = i % 60;
                    log(`ÂæÖÊ©ü‰∏≠... (${minutes}ÂàÜ${seconds}ÁßíÁµåÈÅé / ÊúÄÂ§ß40ÂàÜ)`, 'info');
                }
                
                await sleep(1000);
            }
            
            if (consecutiveAbsent < 10) {
                log('ÊúÄÂ§ßÂæÖÊ©üÊôÇÈñìÔºà40ÂàÜÔºâ„Å´ÈÅî„Åó„Åæ„Åó„Åü', 'warning');
            }
            
            await sleep(2000);
            log('Deep Research/„Ç®„Éº„Ç∏„Çß„É≥„Éà„É¢„Éº„ÉâÁâπÂà•Âá¶ÁêÜÂÆå‰∫Ü', 'success');
            return true;
            
        } catch (error) {
            log(`ÁâπÂà•Âá¶ÁêÜ„Åß„Ç®„É©„Éº: ${error.message}`, 'error');
            console.error(error);
            return false;
        }
    }
    
    // ========================================
    // „É°„Ç§„É≥ÂÆüË°åÈñ¢Êï∞
    // ========================================
    async function executeTask(taskData) {
        // ÂÆüË°åÂâç„Å´„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„ÉàÔºà„Å©„ÅÆÁµåË∑Ø„Åã„ÇâÂëº„Å∞„Çå„Å¶„ÇÇÈÅ©Âàá„Å´ÂàùÊúüÂåñÔºâ
        window.__v2_execution_complete = false;
        window.__v2_execution_result = null;
        
        console.log('%cüöÄ ChatGPT V2 „Çø„Çπ„ÇØÂÆüË°åÈñãÂßã', 'color: #00BCD4; font-weight: bold; font-size: 16px');
        console.log('Âèó‰ø°„Åó„Åü„Çø„Çπ„ÇØ„Éá„Éº„Çø:', {
            model: taskData.model,
            function: taskData.function,
            promptLength: taskData.prompt?.length || taskData.text?.length || 0,
            hasPrompt: !!(taskData.prompt || taskData.text)
        });
        
        try {
            // ========================================
            // „Éö„Éº„Ç∏Ê∫ñÂÇôÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØÔºàÂàùÂõûÂÆüË°å„ÅÆÂïèÈ°å„ÇíËß£Ê±∫Ôºâ
            // ========================================
            log('\n„Äê„Éö„Éº„Ç∏ÂàùÊúüÂåñ„ÉÅ„Çß„ÉÉ„ÇØ„Äë', 'step');
            
            // 1. ChatGPT UI„ÅÆÂü∫Êú¨Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
            const criticalElements = {
                '„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÊ¨Ñ': SELECTORS.textInput,
                '„É¢„Éá„É´„Éú„Çø„É≥': SELECTORS.modelButton
            };
            
            let allElementsReady = false;
            let retryCount = 0;
            const maxRetries = 10;
            
            // ÊúÄÂàù„ÅÆ„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÅØËøΩÂä†„ÅÆÂàùÊúüÂåñÂæÖÊ©ü
            const isFirstTask = !window.ChatGPTAutomationV2._initialized;
            if (isFirstTask) {
                log('ÂàùÂõû„Çø„Çπ„ÇØÂÆüË°å„ÇíÊ§úÁü•„ÄÇËøΩÂä†„ÅÆÂàùÊúüÂåñÂæÖÊ©ü„ÇíË°å„ÅÑ„Åæ„Åô', 'info');
                await sleep(3000); // ÂàùÂõû„ÅØ3ÁßíÂæÖÊ©ü
                window.ChatGPTAutomationV2._initialized = true;
            }
            
            // ÂÖ®„Å¶„ÅÆÈáçË¶Å„Å™Ë¶ÅÁ¥†„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©ü
            while (!allElementsReady && retryCount < maxRetries) {
                allElementsReady = true;
                
                for (const [name, selectors] of Object.entries(criticalElements)) {
                    const element = await findElement(selectors, name, 1);
                    if (!element) {
                        log(`${name}„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÂæÖÊ©ü‰∏≠... (${retryCount + 1}/${maxRetries})`, 'warning');
                        allElementsReady = false;
                        break;
                    }
                }
                
                if (!allElementsReady) {
                    await sleep(2000);
                    retryCount++;
                }
            }
            
            if (!allElementsReady) {
                throw new Error('ChatGPT UI„ÅåÂÆåÂÖ®„Å´ÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            
            // 2. React/DOM „ÅÆÂÆâÂÆöÂåñÂæÖÊ©ü
            log('DOMÂÆâÂÆöÂåñÂæÖÊ©ü‰∏≠...', 'info');
            await sleep(1500);
            
            // 3. Êó¢Â≠ò„ÅÆÈñã„ÅÑ„Å¶„ÅÑ„Çã„É°„Éã„É•„Éº„ÇíÂÖ®„Å¶Èñâ„Åò„Çã
            const openMenus = document.querySelectorAll('[role="menu"][data-state="open"]');
            if (openMenus.length > 0) {
                log(`Èñã„ÅÑ„Å¶„ÅÑ„Çã„É°„Éã„É•„Éº(${openMenus.length}ÂÄã)„ÇíÈñâ„Åò„Åæ„Åô`, 'info');
                document.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape', code: 'Escape' }));
                await sleep(500);
            }
            
            log('„Éö„Éº„Ç∏ÂàùÊúüÂåñ„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü', 'success');
            
            // „Éë„É©„É°„Éº„ÇøÊ∫ñÂÇôÔºà„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅÆÂÄ§„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®Ôºâ
            const prompt = taskData.prompt || taskData.text || '';
            const modelName = taskData.model || '';
            const featureName = taskData.function || null;
            
            log(`ÈÅ∏Êäû„Åï„Çå„Åü„É¢„Éá„É´: ${modelName}`, 'info');
            log(`ÈÅ∏Êäû„Åï„Çå„ÅüÊ©üËÉΩ: ${featureName || 'Ë®≠ÂÆö„Å™„Åó'}`, 'info');
            log(`„Éó„É≠„É≥„Éó„Éà: ${prompt.substring(0, 100)}...`, 'info');
            
            // „É¢„Éá„É´ÊÉÖÂ†±„Çí‰∫ãÂâçÂèñÂæóÔºà„ÉÜ„Çπ„ÉàÊ∏à„Åø„Ç≥„Éº„Éâ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÔºâ
            let selectedModel = null;
            if (modelName) {
                // Âà©Áî®ÂèØËÉΩ„Å™„É¢„Éá„É´„ÇíÊ§úÁ¥¢„Åó„Å¶selectedModel„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
                const modelButton = await findElement(SELECTORS.modelButton, '„É¢„Éá„É´Âàá„ÇäÊõø„Åà„Éú„Çø„É≥');
                if (modelButton) {
                    modelButton.dispatchEvent(new PointerEvent('pointerdown', { bubbles: true }));
                    await sleep(100);
                    modelButton.dispatchEvent(new PointerEvent('pointerup', { bubbles: true }));
                    await sleep(1500);
                    
                    const modelMenu = await findElement(SELECTORS.modelMenu, '„É¢„Éá„É´„É°„Éã„É•„Éº');
                    if (modelMenu) {
                        // „É°„Ç§„É≥„É°„Éã„É•„Éº„ÅÆ„É¢„Éá„É´ÂèñÂæó
                        const mainMenuItems = modelMenu.querySelectorAll('[role="menuitem"][data-testid^="model-switcher-"]');
                        for (const item of mainMenuItems) {
                            const itemModelName = getCleanText(item);
                            if (itemModelName === modelName || itemModelName.includes(modelName)) {
                                selectedModel = {
                                    name: itemModelName,
                                    testId: item.getAttribute('data-testid'),
                                    type: 'Current'
                                };
                                break;
                            }
                        }
                        
                        // „É¨„Ç¨„Ç∑„Éº„É¢„Éá„É´„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØ
                        if (!selectedModel) {
                            const legacyButton = modelMenu.querySelector('[role="menuitem"][data-has-submenu]') ||
                                                Array.from(modelMenu.querySelectorAll('[role="menuitem"]'))
                                                    .find(el => el.textContent && el.textContent.includes('„É¨„Ç¨„Ç∑„Éº„É¢„Éá„É´'));
                            
                            if (legacyButton) {
                                legacyButton.click();
                                await sleep(1500);
                                
                                const allMenus = document.querySelectorAll('[role="menu"]');
                                for (const menu of allMenus) {
                                    if (menu !== modelMenu) {
                                        const items = menu.querySelectorAll('[role="menuitem"]');
                                        for (const item of items) {
                                            const itemModelName = getCleanText(item);
                                            if (itemModelName === modelName || itemModelName.includes(modelName)) {
                                                selectedModel = {
                                                    name: itemModelName,
                                                    type: 'Legacy'
                                                };
                                                break;
                                            }
                                        }
                                        if (selectedModel) break;
                                    }
                                }
                            }
                        }
                        
                        // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
                        document.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape', code: 'Escape' }));
                        await sleep(1000);
                    }
                }
            }
            
            // ========================================
            // „Çπ„ÉÜ„ÉÉ„Éó4: „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ
            // ========================================
            log('\n„Äê„Çπ„ÉÜ„ÉÉ„Éó4„Äë„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ', 'step');
            
            const input = await findElement(SELECTORS.textInput, '„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÊ¨Ñ');
            if (!input) {
                throw new Error('ÂÖ•ÂäõÊ¨Ñ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            
            // ChatGPTÂãï‰Ωú„Ç≥„Éº„Éâ„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÂá¶ÁêÜ„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
            if (input.classList.contains('ProseMirror') || input.classList.contains('ql-editor')) {
                input.innerHTML = '';
                const p = document.createElement('p');
                p.textContent = prompt;
                input.appendChild(p);
                input.classList.remove('ql-blank');
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
            } else {
                input.textContent = prompt;
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            log('„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÂÆå‰∫Ü', 'success');
            await sleep(1000);
            
            // ========================================
            // „Çπ„ÉÜ„ÉÉ„Éó5: „É¢„Éá„É´ÈÅ∏ÊäûÔºà„ÉÜ„Çπ„ÉàÊ∏à„Åø„Ç≥„Éº„ÉâÔºâ
            // ========================================
            if (modelName) {
                log('\n„Äê„Çπ„ÉÜ„ÉÉ„Éó5„Äë„É¢„Éá„É´ÈÅ∏Êäû', 'step');
                
                // selectedModel„Åå‰∫ãÂâçÊ§úÁ¥¢„ÅßË¶ã„Å§„Åã„Çâ„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅÆÊÉÖÂ†±„ÇíÂá∫Âäõ
                if (!selectedModel) {
                    log(`‰∫ãÂâçÊ§úÁ¥¢„Åß„É¢„Éá„É´ "${modelName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂÜçÊ§úÁ¥¢„ÇíË©¶„Åø„Åæ„Åô„ÄÇ`, 'warning');
                }
                
                // 5-1: „É¢„Éá„É´„É°„Éã„É•„Éº„ÇíÈñã„Åè
                log('5-1. „É¢„Éá„É´„ÅÆ„É°„Éã„É•„Éº„ÇíÈñã„Åè', 'step');
                const modelBtn = await findElement(SELECTORS.modelButton, '„É¢„Éá„É´„Éú„Çø„É≥');
                if (!modelBtn) {
                    throw new Error('„É¢„Éá„É´„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
                
                modelBtn.dispatchEvent(new PointerEvent('pointerdown', { bubbles: true }));
                await sleep(100);
                modelBtn.dispatchEvent(new PointerEvent('pointerup', { bubbles: true }));
                await sleep(1500);
                
                const modelMenuEl = await findElement(SELECTORS.modelMenu, '„É¢„Éá„É´„É°„Éã„É•„Éº');
                if (!modelMenuEl) {
                    throw new Error('„É¢„Éá„É´„É°„Éã„É•„Éº„ÅåÈñã„Åç„Åæ„Åõ„Çì');
                }
                
                // „É¨„Ç¨„Ç∑„Éº„É¢„Éá„É´„ÅÆÂ†¥ÂêàÔºà„ÉÜ„Çπ„ÉàÊ∏à„Åø„Ç≥„Éº„Éâ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÔºâ
                if (selectedModel.type === 'Legacy') {
                    const legacyBtn = modelMenuEl.querySelector('[role="menuitem"][data-has-submenu]') ||
                                    Array.from(modelMenuEl.querySelectorAll('[role="menuitem"]'))
                                        .find(el => el.textContent && el.textContent.includes('„É¨„Ç¨„Ç∑„Éº„É¢„Éá„É´'));
                    if (legacyBtn) {
                        log('„É¨„Ç¨„Ç∑„Éº„É¢„Éá„É´„É°„Éã„É•„Éº„ÇíÈñã„Åè', 'info');
                        legacyBtn.click();
                        await sleep(1500);
                    }
                }
                
                // 5-2: Ë©≤ÂΩì„ÅÆ„É¢„Éá„É´„ÇíÈÅ∏ÊäûÔºà„ÉÜ„Çπ„ÉàÊ∏à„Åø„Ç≥„Éº„Éâ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÔºâ
                log('5-2. Ë©≤ÂΩì„ÅÆ„É¢„Éá„É´„ÇíÈÅ∏Êäû„Åô„Çã', 'step');
                const allMenuItems = document.querySelectorAll('[role="menuitem"]');
                
                // selectedModel„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅmodelName„ÅßÁõ¥Êé•Ê§úÁ¥¢
                let targetItem = null;
                if (selectedModel) {
                    targetItem = Array.from(allMenuItems).find(item => {
                        const text = getCleanText(item);
                        return text === selectedModel.name || 
                               (selectedModel.testId && item.getAttribute('data-testid') === selectedModel.testId);
                    });
                } else {
                    // selectedModel„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅmodelName„ÅßÁõ¥Êé•Ê§úÁ¥¢
                    targetItem = Array.from(allMenuItems).find(item => {
                        const text = getCleanText(item);
                        return text === modelName || text.includes(modelName);
                    });
                }
                
                if (targetItem) {
                    targetItem.click();
                    await sleep(2000);
                    const selectedName = selectedModel ? selectedModel.name : modelName;
                    log(`„É¢„Éá„É´ÈÅ∏ÊäûÂÆå‰∫Ü: ${selectedName}`, 'success');
                } else {
                    log(`„É¢„Éá„É´ "${modelName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éá„Éï„Ç©„É´„Éà„É¢„Éá„É´„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ`, 'warning');
                }
            } else {
                log('„É¢„Éá„É´ÈÅ∏Êäû„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºà„É¢„Éá„É´Âêç„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºâ', 'info');
            }
            
            // ========================================
            // „Çπ„ÉÜ„ÉÉ„Éó6: Ê©üËÉΩÈÅ∏ÊäûÔºàÊ©üËÉΩÂêç„Éû„ÉÉ„Éî„É≥„Ç∞ÂØæÂøúÔºâ
            // ========================================
            let mappedFeatureName = null;
            if (featureName && featureName !== '' && featureName !== 'none' && featureName !== 'ÈÄöÂ∏∏') {
                // Ê©üËÉΩÂêç„Éû„ÉÉ„Éî„É≥„Ç∞Ôºà„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂÄ§ ‚Üí ChatGPT UIË°®Ë®òÔºâ
                // ÂøÖË¶ÅÊúÄÂ∞èÈôê„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„ÅÆ„ÅøÔºà„Çπ„Éö„É´„Éü„Çπ„ÅÆ‰øÆÊ≠£„Å™„Å©Ôºâ
                const featureMapping = {
                    'DeepReserch': 'Deep Research'  // „Çπ„Éö„É´„Éü„Çπ„ÅÆ‰øÆÊ≠£„ÅÆ„Åø
                };
                
                mappedFeatureName = featureMapping[featureName] || featureName;
                
                console.log(`üîÑ [Ê©üËÉΩÂêç„Éû„ÉÉ„Éî„É≥„Ç∞] "${featureName}" ‚Üí "${mappedFeatureName}"`);
                
                log('\n„Äê„Çπ„ÉÜ„ÉÉ„Éó6„ÄëÊ©üËÉΩÈÅ∏Êäû', 'step');
                
                // 6-1: Ê©üËÉΩ„É°„Éã„É•„Éº„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
                log('6-1. Ê©üËÉΩ„É°„Éã„É•„Éº„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ', 'step');
                const funcMenuBtn = await findElement(SELECTORS.menuButton, '„É°„Éã„É•„Éº„Éú„Çø„É≥');
                if (!funcMenuBtn) {
                    throw new Error('Ê©üËÉΩ„É°„Éã„É•„Éº„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
                
                // ÂàùÂõû„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà„ÅØËøΩÂä†ÂæÖÊ©ü
                if (isFirstTask) {
                    log('ÂàùÂõû„Çø„Çπ„ÇØ„ÅÆ„Åü„ÇÅ„ÄÅ„É°„Éã„É•„ÉºÊìç‰ΩúÂâç„Å´ËøΩÂä†ÂæÖÊ©ü', 'info');
                    await sleep(1000);
                }
                
                funcMenuBtn.dispatchEvent(new PointerEvent('pointerdown', { bubbles: true }));
                await sleep(100);
                funcMenuBtn.dispatchEvent(new PointerEvent('pointerup', { bubbles: true }));
                await sleep(2000); // „É°„Éã„É•„ÉºË°®Á§∫„ÅÆÂæÖÊ©üÊôÇÈñì„ÇíÂ¢ó„ÇÑ„Åô
                
                const funcMenu = await findElement(SELECTORS.mainMenu, '„É°„Ç§„É≥„É°„Éã„É•„Éº');
                if (!funcMenu) {
                    throw new Error('Ê©üËÉΩ„É°„Éã„É•„Éº„ÅåÈñã„Åç„Åæ„Åõ„Çì');
                }
                
                // „É°„Ç§„É≥„É°„Éã„É•„Éº„ÅßÊ©üËÉΩ„ÇíÊé¢„ÅôÔºà„Éû„ÉÉ„Éî„É≥„Ç∞„Åó„ÅüÊ©üËÉΩÂêç„Çí‰ΩøÁî®Ôºâ
                let featureElement = findElementByText('[role="menuitemradio"]', mappedFeatureName);
                
                console.log(`üîç [Ê©üËÉΩÊ§úÁ¥¢] „É°„Ç§„É≥„É°„Éã„É•„Éº„Åß "${mappedFeatureName}" „ÇíÊ§úÁ¥¢: ${featureElement ? 'Ë¶ã„Å§„Åã„Å£„Åü' : 'Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑ'}`);
                
                if (!featureElement) {
                    // 6-2: „Åï„Çâ„Å´Ë°®Á§∫„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
                    log('6-2. Ê©üËÉΩ„É°„Éã„É•„Éº„ÅÆ‰∏≠„ÅÆ„Åï„Çâ„Å´Ë°®Á§∫„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ', 'step');
                    
                    // „Åï„Çâ„Å´Ë°®Á§∫„Éú„Çø„É≥„ÇíË§áÊï∞„ÅÆÊñπÊ≥ï„ÅßÊé¢„Åô
                    let moreBtn = findElementByText('[role="menuitem"]', '„Åï„Çâ„Å´Ë°®Á§∫');
                    if (!moreBtn) {
                        // Âà•„ÅÆ„Éë„Çø„Éº„É≥„ÅßÊ§úÁ¥¢
                        const allMenuItems = funcMenu.querySelectorAll('[role="menuitem"]');
                        for (const item of allMenuItems) {
                            const text = getCleanText(item);
                            if (text === '„Åï„Çâ„Å´Ë°®Á§∫' || text.includes('„Åï„Çâ„Å´Ë°®Á§∫')) {
                                moreBtn = item;
                                console.log(`üîç [Ê©üËÉΩÊ§úÁ¥¢] Âà•„ÅÆ„Éë„Çø„Éº„É≥„Åß"„Åï„Çâ„Å´Ë°®Á§∫"„Éú„Çø„É≥„ÇíÁô∫Ë¶ã`);
                                break;
                            }
                        }
                    }
                    
                    if (moreBtn) {
                        log('„Äå„Åï„Çâ„Å´Ë°®Á§∫„Äç„Å´„Éõ„Éê„Éº„Åó„Å¶„Çµ„Éñ„É°„Éã„É•„Éº„ÇíÈñã„Åè', 'info');
                        
                        // „Åæ„Åö„Éõ„Éê„Éº„Ç§„Éô„É≥„Éà„ÇíË©¶„Åô
                        moreBtn.dispatchEvent(new MouseEvent('mouseenter', { bubbles: true }));
                        moreBtn.dispatchEvent(new MouseEvent('mouseover', { bubbles: true }));
                        await sleep(500);
                        
                        // „Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„ÅÑ„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                        let subMenu = document.querySelector('[data-side="right"]');
                        if (!subMenu) {
                            log('„Éõ„Éê„Éº„Åß„Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åã„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„ÇíË©¶Ë°å', 'info');
                            
                            // „ÇØ„É™„ÉÉ„ÇØÂâç„Å´„Éï„Ç©„Éº„Ç´„Çπ„ÇíË®≠ÂÆö
                            moreBtn.focus();
                            await sleep(100);
                            
                            // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´
                            moreBtn.click();
                            await sleep(500);
                            
                            // ÂÜçÂ∫¶„ÉÅ„Çß„ÉÉ„ÇØ
                            subMenu = document.querySelector('[data-side="right"]');
                        }
                        
                        // „Åù„Çå„Åß„ÇÇÈñã„Åã„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Éù„Ç§„É≥„Çø„Éº„Ç§„Éô„É≥„Éà„ÅßË©¶„Åô
                        if (!subMenu) {
                            log('„Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü', 'warn');
                            
                            // „Éù„Ç§„É≥„Çø„Éº„Ç§„Éô„É≥„Éà„ÇíË©¶„Åô
                            const rect = moreBtn.getBoundingClientRect();
                            const x = rect.left + rect.width / 2;
                            const y = rect.top + rect.height / 2;
                            
                            moreBtn.dispatchEvent(new PointerEvent('pointerenter', {
                                bubbles: true,
                                clientX: x,
                                clientY: y
                            }));
                            
                            moreBtn.dispatchEvent(new PointerEvent('pointerover', {
                                bubbles: true,
                                clientX: x,
                                clientY: y
                            }));
                            
                            await sleep(500);
                            subMenu = document.querySelector('[data-side="right"]');
                        }
                        
                        // ÊúÄÁµÇÊâãÊÆµ: „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
                        if (!subMenu) {
                            log('ÊúÄÁµÇÊâãÊÆµ: „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú„ÇíË©¶Ë°å', 'warn');
                            
                            // Enter„Ç≠„Éº„ÇíÊäº„Åô
                            moreBtn.focus();
                            await sleep(100);
                            
                            moreBtn.dispatchEvent(new KeyboardEvent('keydown', {
                                key: 'Enter',
                                code: 'Enter',
                                bubbles: true
                            }));
                            
                            moreBtn.dispatchEvent(new KeyboardEvent('keyup', {
                                key: 'Enter',
                                code: 'Enter',
                                bubbles: true
                            }));
                            
                            await sleep(500);
                            subMenu = document.querySelector('[data-side="right"]');
                        }
                        
                        // „Éá„Éê„ÉÉ„Ç∞Áî®„ÅÆË©≥Á¥∞„É≠„Ç∞ÔºàÂ§±ÊïóÊôÇ„ÅÆ„ÅøÔºâ
                        if (!subMenu) {
                            // üîç „Éá„Éê„ÉÉ„Ç∞: „ÇØ„É™„ÉÉ„ÇØÂâç„ÅÆË©≥Á¥∞„Å™Áä∂ÊÖã„ÇíË®òÈå≤
                        console.log('üî•üî•üî• [ÈáçË¶Å„Éá„Éê„ÉÉ„Ç∞] „Åï„Çâ„Å´Ë°®Á§∫„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜÈñãÂßã üî•üî•üî•');
                        console.log('üìã [„ÇØ„É™„ÉÉ„ÇØÂâç] „Éú„Çø„É≥„ÅÆÂÆåÂÖ®„Å™ÊÉÖÂ†±:');
                        console.log('  - „Éú„Çø„É≥Ë¶ÅÁ¥†:', moreBtn);
                        console.log('  - „ÉÜ„Ç≠„Çπ„Éà:', moreBtn.textContent?.trim());
                        console.log('  - „Çø„Ç∞Âêç:', moreBtn.tagName);
                        console.log('  - „ÇØ„É©„ÇπÂêç:', moreBtn.className);
                        console.log('  - ID:', moreBtn.id || '„Å™„Åó');
                        
                        // HTMLÂ±ûÊÄß„ÇíÂÖ®„Å¶Ë®òÈå≤
                        console.log('üìã [„ÇØ„É™„ÉÉ„ÇØÂâç] HTMLÂ±ûÊÄß:');
                        console.log('  - role:', moreBtn.getAttribute('role'));
                        console.log('  - aria-haspopup:', moreBtn.getAttribute('aria-haspopup'));
                        console.log('  - aria-expanded:', moreBtn.getAttribute('aria-expanded'));
                        console.log('  - data-has-submenu:', moreBtn.getAttribute('data-has-submenu'));
                        console.log('  - data-testid:', moreBtn.getAttribute('data-testid'));
                        console.log('  - data-state:', moreBtn.getAttribute('data-state'));
                        
                        // „Éú„Çø„É≥„ÅÆ‰ΩçÁΩÆ„Å®„Çµ„Ç§„Ç∫
                        const rect = moreBtn.getBoundingClientRect();
                        console.log('üìã [„ÇØ„É™„ÉÉ„ÇØÂâç] „Éú„Çø„É≥„ÅÆ‰ΩçÁΩÆ„Å®„Çµ„Ç§„Ç∫:');
                        console.log('  - ‰ΩçÁΩÆ:', { x: rect.x, y: rect.y });
                        console.log('  - „Çµ„Ç§„Ç∫:', { width: rect.width, height: rect.height });
                        console.log('  - Ë°®Á§∫Áä∂ÊÖã:', moreBtn.offsetParent !== null ? 'Ë°®Á§∫' : 'ÈùûË°®Á§∫');
                        
                        // „Çπ„Çø„Ç§„É´ÊÉÖÂ†±
                        const computed = window.getComputedStyle(moreBtn);
                        console.log('üìã [„ÇØ„É™„ÉÉ„ÇØÂâç] „Çπ„Çø„Ç§„É´ÊÉÖÂ†±:');
                        console.log('  - pointerEvents:', computed.pointerEvents);
                        console.log('  - cursor:', computed.cursor);
                        console.log('  - display:', computed.display);
                        console.log('  - visibility:', computed.visibility);
                        console.log('  - opacity:', computed.opacity);
                        
                        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÊÉÖÂ†±
                        console.log('üìã [„ÇØ„É™„ÉÉ„ÇØÂâç] „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÊÉÖÂ†±:');
                        console.log('  - onclickÈñ¢Êï∞:', typeof moreBtn.onclick);
                        const reactKeys = Object.keys(moreBtn).filter(key => key.startsWith('__react'));
                        console.log('  - React„Éó„É≠„Éë„ÉÜ„Ç£:', reactKeys);
                        if (reactKeys.length > 0) {
                            reactKeys.forEach(key => {
                                console.log(`    - ${key}:`, typeof moreBtn[key]);
                            });
                        }
                        
                        // Ë¶™Ë¶ÅÁ¥†„ÅÆÊÉÖÂ†±
                        console.log('üìã [„ÇØ„É™„ÉÉ„ÇØÂâç] Ë¶™Ë¶ÅÁ¥†„ÅÆÊÉÖÂ†±:');
                        console.log('  - Ë¶™Ë¶ÅÁ¥†„Çø„Ç∞:', moreBtn.parentElement?.tagName);
                        console.log('  - Ë¶™Ë¶ÅÁ¥†role:', moreBtn.parentElement?.getAttribute('role'));
                        console.log('  - Ë¶™Ë¶ÅÁ¥†„ÇØ„É©„Çπ:', moreBtn.parentElement?.className);
                        
                        // ÁèæÂú®„ÅÆ„É°„Éã„É•„ÉºÁä∂ÊÖã
                        console.log('üìã [„ÇØ„É™„ÉÉ„ÇØÂâç] „É°„Éã„É•„ÉºÁä∂ÊÖã:');
                        const menus = document.querySelectorAll('[role="menu"]');
                        console.log('  - „É°„Éã„É•„ÉºÊï∞:', menus.length);
                        menus.forEach((menu, idx) => {
                            console.log(`  - „É°„Éã„É•„Éº${idx}:`, {
                                dataState: menu.getAttribute('data-state'),
                                dataSide: menu.getAttribute('data-side'),
                                Â≠êË¶ÅÁ¥†Êï∞: menu.children.length
                            });
                        });
                        
                        // „ÇØ„É™„ÉÉ„ÇØÂÆüË°å
                        // ÈáçË¶Å: „Éï„Ç©„Éº„Ç´„Çπ„ÇíÁ∂≠ÊåÅ„Åó„Å¶„ÇØ„É™„ÉÉ„ÇØ„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã
                        // ÁêÜÁî±: ChatGPT„ÅÆ„É°„Éã„É•„Éº„ÅØ„Éï„Ç©„Éº„Ç´„Çπ„ÇíÂ§±„ÅÜ„Å®Ëá™ÂãïÁöÑ„Å´Èñâ„Åò„Çã
                        console.log('üéØ [„ÇØ„É™„ÉÉ„ÇØÂÆüË°å] „Éï„Ç©„Éº„Ç´„Çπ„ÇíË®≠ÂÆö„Åó„Å¶„Åã„Çâ„ÇØ„É™„ÉÉ„ÇØ');
                        
                        // „Éï„Ç©„Éº„Ç´„Çπ„ÇíÊòéÁ§∫ÁöÑ„Å´Ë®≠ÂÆö
                        moreBtn.focus();
                        console.log('  ‚úÖ „Éï„Ç©„Éº„Ç´„Çπ„ÇíË®≠ÂÆö');
                        await sleep(100); // „Éï„Ç©„Éº„Ç´„Çπ„ÅåÂÆâÂÆö„Åô„Çã„Åæ„ÅßÂæÖÊ©ü
                        
                        // onclick„ÅÆË©≥Á¥∞„ÇíË™øÊüª
                        console.log('üîç [onclickË©≥Á¥∞ÂàÜÊûê]');
                        console.log('  - onclickÂûã:', typeof moreBtn.onclick);
                        console.log('  - onclickÂÄ§:', moreBtn.onclick);
                        if (moreBtn.onclick && typeof moreBtn.onclick === 'object') {
                            console.log('  - onclick„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç≠„Éº:', Object.keys(moreBtn.onclick));
                            console.log('  - „Ç≥„É≥„Çπ„Éà„É©„ÇØ„ÇøÂêç:', moreBtn.onclick.constructor?.name);
                            // „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ‰∏≠Ë∫´„ÇíË©≥„Åó„ÅèË™øÊüª
                            try {
                                console.log('  - onclick JSON:', JSON.stringify(moreBtn.onclick));
                            } catch (e) {
                                console.log('  - onclick JSONÂ§âÊèõÂ§±Êïó:', e.message);
                            }
                        }
                        
                        // „É°„Ç§„É≥„É°„Éã„É•„Éº„ÅåÈñâ„Åò„ÇãÂéüÂõ†„ÇíË™øÊüª
                        console.log('üîç [„É°„Éã„É•„ÉºÈñâ„Åò„ÇãÂïèÈ°å„ÅÆË™øÊüª]');
                        const mainMenu = document.querySelector('[role="menu"]');
                        if (mainMenu) {
                            console.log('  - „É°„Ç§„É≥„É°„Éã„É•„Éº„ÅÆdata-state:', mainMenu.getAttribute('data-state'));
                            console.log('  - „É°„Ç§„É≥„É°„Éã„É•„Éº„ÅÆaria-hidden:', mainMenu.getAttribute('aria-hidden'));
                            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí‰∏ÄÊôÇÁöÑ„Å´ËøΩÂä†„Åó„Å¶Èñâ„Åò„ÇãÂéüÂõ†„ÇíÁâπÂÆö
                            const handleClose = (e) => {
                                console.log('‚ö†Ô∏è „É°„Éã„É•„Éº„ÅåÈñâ„Åò„Çâ„Çå„Çà„ÅÜ„Å®„Åó„Å¶„ÅÑ„Åæ„Åô!', e.type);
                            };
                            mainMenu.addEventListener('focusout', handleClose);
                            mainMenu.addEventListener('blur', handleClose);
                            mainMenu.addEventListener('mouseleave', handleClose);
                        }
                        
                        // „ÇØ„É™„ÉÉ„ÇØÂÆüË°åÔºà„Éï„Ç©„Éº„Ç´„Çπ„ÇíÁ∂≠ÊåÅÔºâ
                        console.log('  üñ±Ô∏è „ÇØ„É™„ÉÉ„ÇØÂÆüË°å');
                        
                        // preventDefault„Åßfocusout„ÇíÈò≤„Åê
                        const preventFocusLoss = (e) => {
                            console.log('  üõ°Ô∏è „Éï„Ç©„Éº„Ç´„ÇπÂñ™Â§±„ÇíÈò≤Ê≠¢:', e.type);
                            e.preventDefault();
                            e.stopPropagation();
                        };
                        
                        // ‰∏ÄÊôÇÁöÑ„Å´focusout„ÇíÁÑ°ÂäπÂåñ
                        moreBtn.addEventListener('focusout', preventFocusLoss, true);
                        moreBtn.addEventListener('blur', preventFocusLoss, true);
                        
                        moreBtn.click();
                        
                        // „ÇØ„É™„ÉÉ„ÇØÂæå„ÇÇ„Éï„Ç©„Éº„Ç´„Çπ„ÇíÁ∂≠ÊåÅ
                        console.log('  üéØ „ÇØ„É™„ÉÉ„ÇØÂæå„ÄÅ„Éï„Ç©„Éº„Ç´„Çπ„ÇíÂº∑Âà∂Á∂≠ÊåÅ');
                        setTimeout(() => {
                            moreBtn.focus();
                            // „Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åè„Åæ„Åß„Éï„Ç©„Éº„Ç´„Çπ„Çí‰øùÊåÅ
                            const keepFocus = setInterval(() => {
                                if (document.activeElement !== moreBtn) {
                                    moreBtn.focus();
                                }
                            }, 50);
                            
                            // 500msÂæå„Å´„Éï„Ç©„Éº„Ç´„Çπ‰øùÊåÅ„ÇíËß£Èô§
                            setTimeout(() => {
                                clearInterval(keepFocus);
                                moreBtn.removeEventListener('focusout', preventFocusLoss, true);
                                moreBtn.removeEventListener('blur', preventFocusLoss, true);
                            }, 500);
                        }, 10);
                        
                        console.log('‚úÖ [„ÇØ„É™„ÉÉ„ÇØÂÆå‰∫Ü] „Éï„Ç©„Éº„Ç´„Çπ‰øùË≠∑‰ªò„Åçclick()ÂÆüË°åÂÆå‰∫Ü');
                        
                        // „ÇØ„É™„ÉÉ„ÇØÂæå„ÅÆÂ§âÂåñ„ÇíÊÆµÈöéÁöÑ„Å´Ë®òÈå≤
                        for (let i = 0; i < 5; i++) {
                            await sleep(200);
                            const elapsed = (i + 1) * 200;
                            console.log(`üìä [„ÇØ„É™„ÉÉ„ÇØÂæå ${elapsed}ms]:`, {
                                'aria-expanded': moreBtn.getAttribute('aria-expanded'),
                                'data-state': moreBtn.getAttribute('data-state'),
                                '„É°„Éã„É•„ÉºÊï∞': document.querySelectorAll('[role="menu"]').length,
                                '„Çµ„Éñ„É°„Éã„É•„ÉºÂ≠òÂú®': !!document.querySelector('[data-side="right"]')
                            });
                            
                            // „Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„ÅÑ„Åü„ÇâÂç≥Â∫ß„Å´Ë®òÈå≤
                            if (document.querySelector('[data-side="right"]')) {
                                console.log('üéâ „Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åç„Åæ„Åó„ÅüÔºÅ');
                                break;
                            }
                        }
                        
                            // „Åô„Åπ„Å¶„ÅÆÊñπÊ≥ï„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÅÆ„Åø„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„ÇíÂá∫Âäõ
                            console.log('‚ùå [„Ç®„É©„Éº] „Åô„Åπ„Å¶„ÅÆÊñπÊ≥ï„Åß„Çµ„Éñ„É°„Éã„É•„Éº„ÇíÈñã„Åë„Åæ„Åõ„Çì„Åß„Åó„Åü');
                            console.log('  - Ë©¶„Åó„ÅüÊñπÊ≥ï: „Éõ„Éê„Éº„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„ÄÅ„Éù„Ç§„É≥„Çø„Éº„Ç§„Éô„É≥„Éà„ÄÅ„Ç≠„Éº„Éú„Éº„Éâ');
                            console.log('  - ÁèæÂú®„ÅÆ„É°„Éã„É•„ÉºÊï∞:', document.querySelectorAll('[role="menu"]').length);
                            
                            // Ê©üËÉΩÈÅ∏Êäû„ÇíÂ§±Êïó„Å®„Åó„Å¶Ëøî„Åô
                            return {
                                success: false,
                                error: '„Çµ„Éñ„É°„Éã„É•„Éº„ÇíÈñã„Åë„Åæ„Åõ„Çì„Åß„Åó„Åü',
                                displayedFunction: ''
                            };
                        }
                        
                        // „Çµ„Éñ„É°„Éã„É•„Éº„ÅåÊ≠£Â∏∏„Å´Èñã„ÅÑ„ÅüÂ†¥Âêà
                        subMenu = document.querySelector('[data-side="right"]');
                        if (!subMenu) {
                            // ‰ª£ÊõøÊñπÊ≥ï: ÊúÄÂæå„ÅÆ„É°„Éã„É•„Éº„Åæ„Åü„ÅØmenuitemradio„ÇíÂê´„ÇÄ„É°„Éã„É•„Éº„ÇíÊé¢„Åô
                            const allMenusAfter = document.querySelectorAll('[role="menu"]');
                            if (allMenusAfter.length > 1) {
                                subMenu = allMenusAfter[allMenusAfter.length - 1];
                            }
                            
                            if (!subMenu) {
                                for (const menu of allMenusAfter) {
                                    if (menu.querySelectorAll('[role="menuitemradio"]').length > 0) {
                                        subMenu = menu;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // 6-3: „Çµ„Éñ„É°„Éã„É•„Éº„ÅßÊ©üËÉΩ„ÇíÊé¢„ÅôÔºà„ÉÜ„Çπ„Éà„Ç≥„Éº„Éâ„ÅÆÂÆüË£ÖÔºâ
                        log('6-3. „Çµ„Éñ„É°„Éã„É•„Éº„ÅßÊ©üËÉΩ„ÇíÈÅ∏Êäû', 'step');
                        if (subMenu) {
                            console.log('‚úÖ [„Éá„Éê„ÉÉ„Ç∞] „Çµ„Éñ„É°„Éã„É•„ÉºÊ§úÂá∫ÊàêÂäü');
                            console.log('  - „Çµ„Éñ„É°„Éã„É•„Éº„ÅÆmenuitemradioÊï∞:', subMenu.querySelectorAll('[role="menuitemradio"]').length);
                            // „ÉÜ„Çπ„Éà„Ç≥„Éº„Éâ„ÅÆÂÆüË£Ö„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
                            const subMenuItems = subMenu.querySelectorAll('[role="menuitemradio"]');
                            for (const item of subMenuItems) {
                                const featureName = getCleanText(item);
                                if (featureName === mappedFeatureName) {
                                    featureElement = item;
                                    log(`„Çµ„Éñ„É°„Éã„É•„ÉºÊ©üËÉΩÁô∫Ë¶ã: ${featureName}`, 'success');
                                    break;
                                }
                            }
                            
                            // „ÉÜ„Çπ„Éà„Ç≥„Éº„Éâ„ÅÆfindElementByText‰∫íÊèõÂÆüË£Ö„ÇÇËøΩÂä†
                            if (!featureElement) {
                                featureElement = findElementByText('[role="menuitemradio"]', mappedFeatureName, subMenu);
                            }
                            
                            console.log(`üîç [Ê©üËÉΩÊ§úÁ¥¢] „Çµ„Éñ„É°„Éã„É•„Éº„Åß "${mappedFeatureName}" „ÇíÊ§úÁ¥¢: ${featureElement ? 'Ë¶ã„Å§„Åã„Å£„Åü' : 'Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑ'}`);
                        } else {
                            console.log(`‚ùå [„Éá„Éê„ÉÉ„Ç∞] „Çµ„Éñ„É°„Éã„É•„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
                            console.log('  - ÂïèÈ°å: „Åï„Çâ„Å´Ë°®Á§∫„ÇØ„É™„ÉÉ„ÇØÂæå„ÇÇ„Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åã„Å™„ÅÑ');
                            console.log('  - ÂèØËÉΩ„Å™ÂéüÂõ†:');
                            console.log('    1. „É°„Éã„É•„Éº„ÅåÈñâ„Åò„Å¶„Åó„Åæ„Å£„Åü');
                            console.log('    2. „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÅåÊ≠£„Åó„ÅèÂá¶ÁêÜ„Åï„Çå„Å™„Åã„Å£„Åü');
                            console.log('    3. UI„ÅÆÁä∂ÊÖã„Åå‰∏çÂÆâÂÆö');
                            
                            // „Ç®„É©„ÉºÊôÇ„ÅÆËøΩÂä†ÊÉÖÂ†±ÂèéÈõÜ
                            const bodyClick = document.querySelector('body');
                            const activeElement = document.activeElement;
                            console.log('  - ÁèæÂú®„ÅÆ„Éï„Ç©„Éº„Ç´„ÇπË¶ÅÁ¥†:', activeElement?.tagName, activeElement?.className);
                            console.log('  - bodyË¶ÅÁ¥†„ÅÆÁä∂ÊÖã:', {
                                „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ: !!bodyClick,
                                „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ: window.scrollY
                            });
                        }
                    } else {
                        console.log(`‚ö†Ô∏è [Ê©üËÉΩÊ§úÁ¥¢] "„Åï„Çâ„Å´Ë°®Á§∫"„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
                        console.log('  - Âà©Áî®ÂèØËÉΩ„Å™menuitem:');
                        const allMenuItems = document.querySelectorAll('[role="menuitem"]');
                        allMenuItems.forEach((item, idx) => {
                            const text = item.textContent?.trim();
                            if (text && text.length < 50) {
                                console.log(`    [${idx}] "${text}"`);
                            }
                        });
                    }
                }
                
                // „Åô„Åπ„Å¶„ÅÆÊ§úÁ¥¢„ÅåÁµÇ„Çè„Å£„Å¶„Åã„ÇâÂà§ÂÆö
                if (featureElement) {
                    featureElement.click();
                    await sleep(1500);
                    log(`Ê©üËÉΩÈÅ∏ÊäûÂÆå‰∫Ü: ${mappedFeatureName}`, 'success');
                    
                    // 6-4: Ê©üËÉΩ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                    log('6-4. Ê©üËÉΩ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÇíÁ¢∫Ë™ç', 'step');
                    const buttons = document.querySelectorAll('button[data-pill="true"]');
                    let found = false;
                    for (const button of buttons) {
                        const text = getCleanText(button);
                        if (text) {
                            log(`ÈÅ∏Êäû„Åï„Çå„ÅüÊ©üËÉΩ„Éú„Çø„É≥: ${text}`, 'success');
                            found = true;
                        }
                    }
                    if (!found) {
                        log('Ê©üËÉΩ„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'warning');
                    }
                } else {
                    // „Éá„Éê„ÉÉ„Ç∞: Âà©Áî®ÂèØËÉΩ„Å™Ê©üËÉΩ„ÇíÂèéÈõÜ
                    const allFeatures = [];
                    
                    // „É°„Ç§„É≥„É°„Éã„É•„Éº„ÅÆÊ©üËÉΩ„ÇíÂèñÂæó
                    const mainMenuItems = document.querySelectorAll('[role="menuitemradio"]');
                    mainMenuItems.forEach(item => {
                        const text = getCleanText(item);
                        if (text) {
                            // „Çµ„Éñ„É°„Éã„É•„ÉºÂÜÖ„Åã„É°„Ç§„É≥„É°„Éã„É•„ÉºÂÜÖ„Åã„ÇíÂà§ÂÆö
                            const isInSubMenu = item.closest('[data-side="right"]');
                            if (isInSubMenu) {
                                allFeatures.push(`[„Çµ„Éñ] ${text}`);
                            } else {
                                allFeatures.push(`[„É°„Ç§„É≥] ${text}`);
                            }
                        }
                    });
                    
                    console.log(`‚ùå [Ê©üËÉΩÊ§úÁ¥¢] "${mappedFeatureName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÂà©Áî®ÂèØËÉΩ„Å™Ê©üËÉΩ:`, allFeatures);
                    
                    // „Çà„ÇäË©≥Á¥∞„Å™ÊÉÖÂ†±„ÇíÂá∫Âäõ
                    if (allFeatures.length === 0) {
                        console.log(`‚ö†Ô∏è [Ê©üËÉΩÊ§úÁ¥¢] „É°„Éã„É•„ÉºÈ†ÖÁõÆ„Åå1„Å§„ÇÇË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„É°„Éã„É•„Éº„ÅåÊ≠£„Åó„ÅèÈñã„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`);
                    } else {
                        console.log(`üìã [Ê©üËÉΩÊ§úÁ¥¢] Ë¶ã„Å§„Åã„Å£„ÅüÊ©üËÉΩÊï∞: ${allFeatures.length}ÂÄã`);
                    }
                    
                    log(`ÊåáÂÆö„Åï„Çå„ÅüÊ©üËÉΩ "${mappedFeatureName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`, 'warning');
                }
                
                // 6-5: „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
                log('6-5. Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã', 'step');
                document.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape', code: 'Escape' }));
                await sleep(1000);
            }
            
            // ========================================
            // „Çπ„ÉÜ„ÉÉ„Éó7: „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÔºàÂÜçË©¶Ë°åÂØæÂøúÔºâ
            // ========================================
            log('\n„Äê„Çπ„ÉÜ„ÉÉ„Éó7„Äë„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÔºàÂÜçË©¶Ë°åÂØæÂøúÔºâ', 'step');
            
            // ÈÄÅ‰ø°„Éú„Çø„É≥„Çí5Âõû„Åæ„ÅßÂÜçË©¶Ë°å
            let sendSuccess = false;
            let sendAttempts = 0;
            const maxSendAttempts = 5;
            
            while (!sendSuccess && sendAttempts < maxSendAttempts) {
                sendAttempts++;
                log(`ÈÄÅ‰ø°Ë©¶Ë°å ${sendAttempts}/${maxSendAttempts}`, 'step');
                
                const sendBtn = await findElement(SELECTORS.sendButton, 'ÈÄÅ‰ø°„Éú„Çø„É≥');
                if (!sendBtn) {
                    if (sendAttempts === maxSendAttempts) {
                        throw new Error('ÈÄÅ‰ø°„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                    log(`ÈÄÅ‰ø°„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ2ÁßíÂæå„Å´ÂÜçË©¶Ë°å...`, 'warning');
                    await sleep(2000);
                    continue;
                }
                
                // ÈÄÅ‰ø°„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
                sendBtn.click();
                log(`ÈÄÅ‰ø°„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åæ„Åó„ÅüÔºàË©¶Ë°å${sendAttempts}Ôºâ`, 'success');
                await sleep(1000);
                
                // ÈÄÅ‰ø°Âæå„Å´ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Çã„Åã„ÄÅ„Åæ„Åü„ÅØÈÄÅ‰ø°„Éú„Çø„É≥„ÅåÊ∂à„Åà„Çã„Åæ„Åß5ÁßíÂæÖÊ©ü
                let stopButtonAppeared = false;
                let sendButtonDisappeared = false;
                
                for (let i = 0; i < 5; i++) {
                    // ÂÅúÊ≠¢„Éú„Çø„É≥„ÅÆÁ¢∫Ë™ç
                    const stopBtn = await findElement(SELECTORS.stopButton, 'ÂÅúÊ≠¢„Éú„Çø„É≥', 1);
                    if (stopBtn) {
                        stopButtonAppeared = true;
                        log('ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åó„Åü - ÈÄÅ‰ø°ÊàêÂäü', 'success');
                        break;
                    }
                    
                    // ÈÄÅ‰ø°„Éú„Çø„É≥„ÅåÊ∂à„Åà„Åü„Åã„Å©„ÅÜ„Åã„ÇíÁ¢∫Ë™ç
                    const stillSendBtn = await findElement(SELECTORS.sendButton, 'ÈÄÅ‰ø°„Éú„Çø„É≥', 1);
                    if (!stillSendBtn) {
                        sendButtonDisappeared = true;
                        log('ÈÄÅ‰ø°„Éú„Çø„É≥„ÅåÊ∂à„Åà„Åæ„Åó„Åü - ÈÄÅ‰ø°ÊàêÂäü', 'success');
                        break;
                    }
                    
                    await sleep(1000);
                }
                
                if (stopButtonAppeared || sendButtonDisappeared) {
                    sendSuccess = true;
                    break;
                } else {
                    log(`ÈÄÅ‰ø°ÂèçÂøú„ÅåÁ¢∫Ë™ç„Åß„Åç„Åæ„Åõ„Çì„ÄÇÂÜçË©¶Ë°å„Åó„Åæ„Åô...`, 'warning');
                    await sleep(2000);
                }
            }
            
            if (!sendSuccess) {
                throw new Error(`${maxSendAttempts}ÂõûË©¶Ë°å„Åó„Å¶„ÇÇÈÄÅ‰ø°„ÅåÊàêÂäü„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü`);
            }
            
            // ÈÄÅ‰ø°ÊôÇÂàª„ÇíË®òÈå≤ÔºàSpreadsheetLoggerÁî®Ôºâ
            log(`üîç ÈÄÅ‰ø°ÊôÇÂàªË®òÈå≤ÈñãÂßã - AIHandler: ${!!window.AIHandler}, recordSendTimestamp: ${!!window.AIHandler?.recordSendTimestamp}, currentAITaskInfo: ${!!window.currentAITaskInfo}`, 'info');
            if (window.AIHandler && window.AIHandler.recordSendTimestamp) {
                try {
                    log(`üìù ÈÄÅ‰ø°ÊôÇÂàªË®òÈå≤ÂÆüË°åÈñãÂßã - „Çø„Çπ„ÇØID: ${window.currentAITaskInfo?.taskId}`, 'info');
                    await window.AIHandler.recordSendTimestamp('ChatGPT');
                    log(`‚úÖ ÈÄÅ‰ø°ÊôÇÂàªË®òÈå≤ÊàêÂäü`, 'success');
                } catch (error) {
                    log(`‚ùå ÈÄÅ‰ø°ÊôÇÂàªË®òÈå≤„Ç®„É©„Éº: ${error.message}`, 'error');
                }
            } else {
                log(`‚ö†Ô∏è AIHandler „Åæ„Åü„ÅØ recordSendTimestamp „ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì`, 'warning');
            }
            
            await sleep(1000);
            
            // ========================================
            // „Çπ„ÉÜ„ÉÉ„Éó8: ÂøúÁ≠îÂæÖÊ©ü
            // ========================================
            log('\n„Äê„Çπ„ÉÜ„ÉÉ„Éó8„ÄëÂøúÁ≠îÂæÖÊ©ü', 'step');
            
            // Deep Research/„Ç®„Éº„Ç∏„Çß„É≥„Éà„É¢„Éº„Éâ„ÅÆÂà§ÂÆöÔºà„Éû„ÉÉ„Éî„É≥„Ç∞Âæå„ÅÆÊ©üËÉΩÂêç„Çí‰ΩøÁî®Ôºâ
            const finalFeatureName = mappedFeatureName || featureName;
            console.log(`üîç [Ê©üËÉΩÂà§ÂÆö] ChatGPTÊ©üËÉΩ„ÉÅ„Çß„ÉÉ„ÇØ:`, {
                originalFeatureName: featureName,
                mappedFeatureName: mappedFeatureName,
                finalFeatureName: finalFeatureName,
                isDeepResearch: finalFeatureName === 'Deep Research',
                containsResearch: finalFeatureName && finalFeatureName.includes('Research'),
                containsAgent: finalFeatureName && finalFeatureName.includes('„Ç®„Éº„Ç∏„Çß„É≥„Éà')
            });
            
            const isSpecialMode = finalFeatureName && (
                finalFeatureName === 'Deep Research' || 
                finalFeatureName === '„Ç®„Éº„Ç∏„Çß„É≥„Éà„É¢„Éº„ÉâÊñ∞Ë¶è' ||
                finalFeatureName === '„Ç®„Éº„Ç∏„Çß„É≥„Éà„É¢„Éº„Éâ' ||
                finalFeatureName.includes('„Ç®„Éº„Ç∏„Çß„É≥„Éà') ||
                finalFeatureName.includes('Research')
            );
            
            console.log(`üéØ [Ê©üËÉΩÂà§ÂÆö] ChatGPTÁâπÂà•„É¢„Éº„ÉâÂà§ÂÆöÁµêÊûú: ${isSpecialMode} (ÊúÄÁµÇÊ©üËÉΩÂêç: "${finalFeatureName}")`);
            
            if (isSpecialMode) {
                log(`${finalFeatureName}Ê§úÂá∫ - ÁâπÂà•„Å™ÂæÖÊ©üÂá¶ÁêÜ„ÇíÂÆüË°å`, 'warning');
                await handleSpecialModeWaiting();
            } else {
                // ÈÄöÂ∏∏„ÅÆÂæÖÊ©üÂá¶ÁêÜ
                log('ÈÄöÂ∏∏„ÅÆÂæÖÊ©üÂá¶ÁêÜ„ÇíÂÆüË°å', 'info');
                
                // ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Çã„Åæ„ÅßÂæÖÊ©ü
                let stopBtn = null;
                for (let i = 0; i < 30; i++) {
                    stopBtn = await findElement(SELECTORS.stopButton, 'ÂÅúÊ≠¢„Éú„Çø„É≥', 1);
                    if (stopBtn) {
                        log('ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åó„Åü', 'success');
                        break;
                    }
                    await sleep(1000);
                }
                
                // ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÊ∂à„Åà„Çã„Åæ„ÅßÂæÖÊ©üÔºàÊúÄÂ§ß5ÂàÜÔºâ
                if (stopBtn) {
                    log('ÈÄÅ‰ø°ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÊ∂à„Åà„Çã„Åæ„ÅßÂæÖÊ©üÔºàÊúÄÂ§ß5ÂàÜÔºâ', 'info');
                    for (let i = 0; i < 300; i++) {
                        stopBtn = await findElement(SELECTORS.stopButton, 'ÂÅúÊ≠¢„Éú„Çø„É≥', 1);
                        if (!stopBtn) {
                            log('ÂøúÁ≠îÂÆå‰∫Ü', 'success');
                            break;
                        }
                        if (i % 30 === 0 && i > 0) {
                            const minutes = Math.floor(i / 60);
                            const seconds = i % 60;
                            log(`ÂøúÁ≠îÂæÖÊ©ü‰∏≠... (${minutes}ÂàÜ${seconds}ÁßíÁµåÈÅé)`, 'info');
                        }
                        await sleep(1000);
                    }
                }
            }
            
            await sleep(2000); // ËøΩÂä†„ÅÆÂæÖÊ©ü
            
            // ========================================
            // „Çπ„ÉÜ„ÉÉ„Éó9: „ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó„Å®Ë°®Á§∫  
            // ========================================
            log('\n„Äê„Çπ„ÉÜ„ÉÉ„Éó9„Äë„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó„Å®Ë°®Á§∫', 'step');
            
            // „ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó„ÅÆÊîπÂñÑÁâàÔºàui-selectors„Çí‰ΩøÁî®Ôºâ
            let responseText = '';
            
            // ui-selectors„Åã„ÇâÂèñÂæóÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅÇ„ÇäÔºâ
            // UI_SELECTORS„ÅØui-selectors.js„Åã„ÇâËá™ÂãïÁöÑ„Å´Ê≥®ÂÖ•„Åï„Çå„Çã
            const textSelectors = (window.UI_SELECTORS && window.UI_SELECTORS.ChatGPT && window.UI_SELECTORS.ChatGPT.TEXT_EXTRACTION) || 
                ChatGPTSelectors.TEXT_EXTRACTION || {
                    ASSISTANT_MESSAGE: [
                        '[data-message-author-role="assistant"]',
                        'div[class*="agent-turn"]',
                        'div[class*="model-response"]',
                        'article[class*="message"]'
                    ],
                    MESSAGE_CONTENT: [
                        'div.markdown.prose',
                        'div.markdown',
                        'div[class*="markdown"]',
                        'div.text-base',
                        'div[class*="text-message"]',
                        'div[class*="prose"]'
                    ],
                    CANVAS_ARTIFACT: [
                        // ui-selectors.js„ÅÆÊúÄÊñ∞ÂÆöÁæ©„Çí‰ΩøÁî®ÔºàÂãïÁöÑ„Å´ÂèñÂæóÔºâ
                        '#prosemirror-editor-container .ProseMirror[contenteditable="false"]',
                        '#prosemirror-editor-container .ProseMirror',
                        'div#prosemirror-editor-container .markdown.prose',
                        'div._main_5jn6z_1.markdown.prose.ProseMirror',
                        'div._main_5jn6z_1.ProseMirror',
                        '.ProseMirror[contenteditable="false"]',
                        'div.markdown.prose.ProseMirror[contenteditable="false"]',
                        '[contenteditable="false"].markdown.prose',
                        'div.markdown.prose:not([data-message-author-role])',
                        '#canvas-content',
                        '[data-testid="canvas-content"]',
                        'div[class*="canvas"]',
                        'div[class*="artifact"]'
                    ]
                };
            
            // „ÄêÈáçË¶Å„ÄëCanvas/Artifact„ÇíÊúÄÂÑ™ÂÖà„Åß„ÉÅ„Çß„ÉÉ„ÇØÔºàChatGPT CanvasÊ©üËÉΩÂØæÂøúÔºâ
            log('Canvas/Artifact„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂÑ™ÂÖàÁöÑ„Å´Ê§úÁ¥¢‰∏≠...', 'info');
            
            for (const selector of textSelectors.CANVAS_ARTIFACT) {
                const elements = document.querySelectorAll(selector);
                
                if (elements.length > 0) {
                    log(`„Çª„É¨„ÇØ„Çø "${selector}" „Åß ${elements.length}ÂÄã„ÅÆË¶ÅÁ¥†„ÇíÁô∫Ë¶ã`, 'info');
                    
                    for (const elem of elements) {
                        const text = elem.textContent?.trim() || '';
                        
                        // CanvasË¶ÅÁ¥†„ÅÆË©≥Á¥∞ÊÉÖÂ†±„Çí„É≠„Ç∞
                        const isEditable = elem.getAttribute('contenteditable');
                        const classList = elem.className || '';
                        const hasProseMirror = elem.classList && elem.classList.contains('ProseMirror');
                        
                        log(`CanvasË¶ÅÁ¥†„ÉÅ„Çß„ÉÉ„ÇØ: ÊñáÂ≠óÊï∞=${text.length}, contenteditable=${isEditable}, classes="${classList}"`, 'info');
                        
                        // ÊúÄ‰ΩéÊñáÂ≠óÊï∞„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁ∑©ÂíåÔºà10ÊñáÂ≠ó‚Üí5ÊñáÂ≠óÔºâ
                        if (text && text.length > 5) {
                            responseText = text;
                            
                            // CanvasË¶ÅÁ¥†„ÅÆÁ®ÆÈ°û„ÇíÂà§ÂÆö
                            if (selector.includes('prosemirror-editor-container')) {
                                log(`‚úÖ prosemirror-editor-containerÂûãCanvasÂèñÂæóÊàêÂäü: ${text.length}ÊñáÂ≠ó`, 'success');
                            } else if (hasProseMirror) {
                                log(`‚úÖ ProseMirrorÂûãCanvasÂèñÂæóÊàêÂäü: ${text.length}ÊñáÂ≠ó`, 'success');
                            } else {
                                log(`‚úÖ CanvasÂèñÂæóÊàêÂäü (${selector}): ${text.length}ÊñáÂ≠ó`, 'success');
                            }
                            
                            log(`CanvasÂÜÖÂÆπ„Éó„É¨„Éì„É•„Éº: ${text.substring(0, 200)}...`, 'info');
                            break;
                        } else if (text) {
                            log(`CanvasË¶ÅÁ¥†„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÅåÊñáÂ≠óÊï∞„ÅåÂ∞ë„Å™„Åô„Åé„Åæ„ÅôÔºà${text.length}ÊñáÂ≠óÔºâ`, 'warning');
                        }
                    }
                    if (responseText) break;
                }
            }
            
            // Canvas„ÅÆ„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíË©≥Á¥∞„Å´Âá∫Âäõ
            if (!responseText) {
                log('‚ö†Ô∏è Canvas„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇË©≥Á¥∞„Å™Ë®∫Êñ≠„ÇíÂÆüË°å‰∏≠...', 'warning');
                
                // prosemirror-editor-container„ÅÆÂ≠òÂú®Á¢∫Ë™ç
                const editorContainer = document.getElementById('prosemirror-editor-container');
                if (editorContainer) {
                    log('‚úÖ prosemirror-editor-container„ÅåÂ≠òÂú®„Åó„Åæ„Åô', 'info');
                    const proseMirrorInside = editorContainer.querySelector('.ProseMirror');
                    if (proseMirrorInside) {
                        const content = proseMirrorInside.textContent?.trim() || '';
                        log(`  ÂÜÖÈÉ®„ÅÆProseMirrorË¶ÅÁ¥†: ÊñáÂ≠óÊï∞=${content.length}`, 'info');
                        if (content.length > 0) {
                            log(`  ÂÜÖÂÆπ„ÅÆÊúÄÂàù„ÅÆ100ÊñáÂ≠ó: ${content.substring(0, 100)}...`, 'info');
                        }
                    }
                }
                
                // „Åô„Åπ„Å¶„ÅÆProseMirrorË¶ÅÁ¥†„ÇíÁ¢∫Ë™ç
                const allProseMirror = document.querySelectorAll('.ProseMirror');
                if (allProseMirror.length > 0) {
                    log(`ÂÖ®ProseMirrorË¶ÅÁ¥†: ${allProseMirror.length}ÂÄã`, 'info');
                    allProseMirror.forEach((elem, index) => {
                        const content = elem.textContent?.trim() || '';
                        const isEditable = elem.getAttribute('contenteditable');
                        const parent = elem.parentElement?.id || elem.parentElement?.className || 'unknown';
                        log(`  [${index}] Ë¶™Ë¶ÅÁ¥†="${parent}", Á∑®ÈõÜÂèØËÉΩ=${isEditable}, ÊñáÂ≠óÊï∞=${content.length}`, 'info');
                    });
                }
            }
            
            // CanvasÂèñÂæó„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅÆ„Åø„ÄÅ„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åã„ÇâÂèñÂæó„ÇíË©¶„Åø„Çã
            if (!responseText) {
                log('Canvas„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åã„ÇâÂèñÂæó„ÇíË©¶„Åø„Åæ„Åô', 'info');
                
                for (const msgSelector of textSelectors.ASSISTANT_MESSAGE) {
                    const assistantMessages = document.querySelectorAll(msgSelector);
                    if (assistantMessages.length > 0) {
                        const lastMessage = assistantMessages[assistantMessages.length - 1];
                        
                        // markdownÂΩ¢Âºè„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊé¢„Åô
                        for (const contentSelector of textSelectors.MESSAGE_CONTENT) {
                            const elements = lastMessage.querySelectorAll(contentSelector);
                            for (const elem of elements) {
                                const text = elem.textContent?.trim() || '';
                                if (text && text.length > 10) {
                                    responseText = text;
                                    log(`„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæóÊàêÂäü (${contentSelector}): ${text.length}ÊñáÂ≠ó`, 'success');
                                    log(`ÊúÄÂàù„ÅÆ100ÊñáÂ≠ó: ${text.substring(0, 100)}...`, 'info');
                                    break;
                                }
                            }
                            if (responseText) break;
                        }
                        if (responseText) break;
                    }
                }
            }
            
            if (responseText) {
                console.log('‚úÖ ChatGPT V2 „Çø„Çπ„ÇØÂÆüË°åÂÆå‰∫Ü');
                // ÂÆüË°åÂÆå‰∫Ü„Éï„É©„Ç∞„ÇíË®≠ÂÆöÔºàAITaskExecutor„ÅåÁ¢∫Ë™çÔºâ
                window.__v2_execution_complete = true;
                window.__v2_execution_result = {
                    success: true,
                    response: responseText
                };
                return {
                    success: true,
                    response: responseText
                };
            } else {
                throw new Error('ÂøúÁ≠î„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
            }
            
        } catch (error) {
            console.error('‚ùå ChatGPT V2 „Çø„Çπ„ÇØÂÆüË°å„Ç®„É©„Éº:', error);
            // „Ç®„É©„ÉºÊôÇ„ÇÇÂÆå‰∫Ü„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            window.__v2_execution_complete = true;
            window.__v2_execution_result = {
                success: false,
                error: error.message
            };
            return {
                success: false,
                error: error.message
            };
        }
    }
    
    // ========================================
    // runAutomationÈñ¢Êï∞ÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
    // ========================================
    async function runAutomation(config) {
        // executeTaskÂÜÖ„Åß„Éï„É©„Ç∞„É™„Çª„ÉÉ„Éà„ÅåË°å„Çè„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ‰∏çË¶Å
        return executeTask({
            model: config.model,
            function: config.function,
            prompt: config.text || config.prompt
        });
    }
    
    // ========================================
    // „Éï„Çß„Éº„Ç∫Âà•ÂÆüË°åÈñ¢Êï∞ÔºàÈ†ÜÊ¨°Âá¶ÁêÜÁî®Ôºâ
    // ========================================
    
    /**
     * „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ„ÅÆ„ÅøÂÆüË°å
     */
    async function inputTextOnly(prompt) {
        try {
            log('üìù „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ„ÅÆ„ÅøÂÆüË°å', 'info');
            const input = await findElement(SELECTORS.textInput, '„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÊ¨Ñ');
            if (!input) {
                throw new Error('ÂÖ•ÂäõÊ¨Ñ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            
            // „ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÂá¶ÁêÜ
            if (input.classList.contains('ProseMirror') || input.classList.contains('ql-editor')) {
                input.innerHTML = '';
                const p = document.createElement('p');
                p.textContent = prompt;
                input.appendChild(p);
                input.classList.remove('ql-blank');
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
            } else {
                input.textContent = prompt;
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            log('‚úÖ „ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÂÆå‰∫Ü', 'success');
            return { success: true };
        } catch (error) {
            log(`‚ùå „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ„Ç®„É©„Éº: ${error.message}`, 'error');
            return { success: false, error: error.message };
        }
    }
    
    /**
     * „É¢„Éá„É´ÈÅ∏Êäû„ÅÆ„ÅøÂÆüË°å
     */
    async function selectModelOnly(modelName) {
        try {
            if (!modelName) {
                log('„É¢„Éá„É´Âêç„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'warning');
                return { success: true };
            }
            
            log(`üìù „É¢„Éá„É´ÈÅ∏Êäû„ÅÆ„ÅøÂÆüË°å: ${modelName}`, 'info');
            
            // „É¢„Éá„É´„É°„Éã„É•„Éº„ÇíÈñã„Åè
            const modelBtn = await findElement(SELECTORS.modelButton, '„É¢„Éá„É´„Éú„Çø„É≥');
            if (!modelBtn) {
                throw new Error('„É¢„Éá„É´„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            
            modelBtn.dispatchEvent(new PointerEvent('pointerdown', { bubbles: true }));
            await sleep(100);
            modelBtn.dispatchEvent(new PointerEvent('pointerup', { bubbles: true }));
            await sleep(1500);
            
            const modelMenuEl = await findElement(SELECTORS.modelMenu, '„É¢„Éá„É´„É°„Éã„É•„Éº');
            if (!modelMenuEl) {
                throw new Error('„É¢„Éá„É´„É°„Éã„É•„Éº„ÅåÈñã„Åç„Åæ„Åõ„Çì');
            }
            
            // „É¢„Éá„É´„ÇíÈÅ∏Êäû
            const allMenuItems = document.querySelectorAll('[role="menuitem"]');
            const targetItem = Array.from(allMenuItems).find(item => {
                const text = getCleanText(item);
                return text === modelName || text.includes(modelName);
            });
            
            if (targetItem) {
                targetItem.click();
                await sleep(2000);
                log(`‚úÖ „É¢„Éá„É´ÈÅ∏ÊäûÂÆå‰∫Ü: ${modelName}`, 'success');
            } else {
                log(`‚ö†Ô∏è „É¢„Éá„É´ "${modelName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`, 'warning');
            }
            
            // ÈÅ∏ÊäûÂæå„ÅÆÂÆüÈöõ„ÅÆ„É¢„Éá„É´„ÇíÂèñÂæó
            let actualSelectedModel = '';
            try {
                if (window.ModelInfoExtractor) {
                    actualSelectedModel = window.ModelInfoExtractor.extract('ChatGPT') || '';
                    log(`üìä ÂÆüÈöõ„Å´ÈÅ∏Êäû„Åï„Çå„Åü„É¢„Éá„É´: "${actualSelectedModel}"`, 'info');
                }
            } catch (e) {
                log(`„É¢„Éá„É´ÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº: ${e.message}`, 'warn');
            }
            
            return { 
                success: true,
                displayedModel: actualSelectedModel
            };
        } catch (error) {
            log(`‚ùå „É¢„Éá„É´ÈÅ∏Êäû„Ç®„É©„Éº: ${error.message}`, 'error');
            return { success: false, error: error.message };
        }
    }
    
    /**
     * Ê©üËÉΩÈÅ∏Êäû„ÅÆ„ÅøÂÆüË°å
     */
    async function selectFunctionOnly(functionName) {
        try {
            if (!functionName || functionName === '' || functionName === 'none' || functionName === 'ÈÄöÂ∏∏') {
                log('Ê©üËÉΩÈÅ∏Êäû„Çí„Çπ„Ç≠„ÉÉ„Éó', 'info');
                return { success: true };
            }
            
            log(`üìù Ê©üËÉΩÈÅ∏Êäû„ÅÆ„ÅøÂÆüË°å: ${functionName}`, 'info');
            
            // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñã„Åè
            const funcMenuBtn = await findElement(SELECTORS.menuButton, '„É°„Éã„É•„Éº„Éú„Çø„É≥');
            if (!funcMenuBtn) {
                throw new Error('Ê©üËÉΩ„É°„Éã„É•„Éº„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            
            funcMenuBtn.dispatchEvent(new PointerEvent('pointerdown', { bubbles: true }));
            await sleep(100);
            funcMenuBtn.dispatchEvent(new PointerEvent('pointerup', { bubbles: true }));
            await sleep(2000);
            
            const funcMenu = await findElement(SELECTORS.mainMenu, '„É°„Ç§„É≥„É°„Éã„É•„Éº');
            if (!funcMenu) {
                throw new Error('Ê©üËÉΩ„É°„Éã„É•„Éº„ÅåÈñã„Åç„Åæ„Åõ„Çì');
            }
            
            // Ê©üËÉΩ„ÇíÊé¢„Åô
            let featureElement = findElementByText('[role="menuitemradio"]', functionName);
            
            if (!featureElement) {
                // „Åï„Çâ„Å´Ë°®Á§∫„Éú„Çø„É≥„ÇíÊé¢„Åó„Å¶„Éõ„Éê„ÉºÔºàChatGPT„ÅØ„Éõ„Éê„Éº„Åß„É°„Éã„É•„Éº„ÅåÈñã„ÅèÔºâ
                let moreBtn = findElementByText('[role="menuitem"]', '„Åï„Çâ„Å´Ë°®Á§∫');
                if (!moreBtn) {
                    // Ëã±Ë™ûÁâà„ÅÆÂ†¥Âêà
                    moreBtn = findElementByText('[role="menuitem"]', 'Show more');
                }
                
                if (moreBtn) {
                    log('„Äå„Åï„Çâ„Å´Ë°®Á§∫„Äç„Å´„Éõ„Éê„Éº„Åó„Å¶„Çµ„Éñ„É°„Éã„É•„Éº„ÇíÈñã„Åè', 'info');
                    
                    // „Éû„Ç¶„Çπ„Éõ„Éê„Éº„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´ÔºàChatGPT„ÅÆ„É°„Éã„É•„Éº„ÅØ„Éõ„Éê„Éº„ÅßÈñã„ÅèÔºâ
                    moreBtn.dispatchEvent(new MouseEvent('mouseenter', { 
                        bubbles: true, 
                        cancelable: true,
                        view: window
                    }));
                    await sleep(50);
                    
                    moreBtn.dispatchEvent(new MouseEvent('mouseover', { 
                        bubbles: true,
                        cancelable: true,
                        view: window
                    }));
                    await sleep(50);
                    
                    // PointerEvent„ÇÇË©¶„ÅôÔºà„Çà„ÇäÁèæ‰ª£ÁöÑ„Å™„Ç§„Éô„É≥„ÉàÔºâ
                    moreBtn.dispatchEvent(new PointerEvent('pointerenter', {
                        bubbles: true,
                        cancelable: true,
                        pointerType: 'mouse'
                    }));
                    await sleep(50);
                    
                    moreBtn.dispatchEvent(new PointerEvent('pointerover', {
                        bubbles: true,
                        cancelable: true,
                        pointerType: 'mouse'
                    }));
                    
                    // „Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åè„Åæ„ÅßÂæÖÊ©ü
                    await sleep(800);
                    
                    // „Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„ÅÑ„Åü„ÅãÁ¢∫Ë™ç
                    let subMenu = document.querySelector('[data-side="right"]');
                    
                    // „Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åã„Å™„ÅÑÂ†¥Âêà„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Å®„Åó„Å¶1Âõû„Å†„Åë„ÇØ„É™„ÉÉ„ÇØ„ÇíË©¶„Åø„Çã
                    if (!subMenu) {
                        log('„Éõ„Éê„Éº„Åß„Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åã„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„ÇíË©¶Ë°å', 'info');
                        moreBtn.focus();
                        await sleep(100);
                        moreBtn.click();
                        await sleep(800);
                        subMenu = document.querySelector('[data-side="right"]');
                    }
                    
                    if (subMenu) {
                        log('„Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åç„Åæ„Åó„Åü', 'success');
                        featureElement = findElementByText('[role="menuitemradio"]', functionName, subMenu);
                    } else {
                        log('‚ö†Ô∏è „Çµ„Éñ„É°„Éã„É•„Éº„ÅåÈñã„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü', 'warning');
                    }
                }
            }
            
            if (featureElement) {
                featureElement.click();
                await sleep(1500);
                log(`‚úÖ Ê©üËÉΩÈÅ∏ÊäûÂÆå‰∫Ü: ${functionName}`, 'success');
            } else {
                log(`‚ö†Ô∏è Ê©üËÉΩ "${functionName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`, 'warning');
            }
            
            // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
            document.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape', code: 'Escape' }));
            await sleep(1000);
            
            // ÈÅ∏ÊäûÂæå„ÅÆÂÆüÈöõ„ÅÆÊ©üËÉΩ„ÇíÂèñÂæó
            let actualSelectedFunction = '';
            try {
                if (window.FunctionInfoExtractor) {
                    actualSelectedFunction = window.FunctionInfoExtractor.extract('ChatGPT') || '';
                    log(`üìä ÂÆüÈöõ„Å´ÈÅ∏Êäû„Åï„Çå„ÅüÊ©üËÉΩ: "${actualSelectedFunction}"`, 'info');
                }
            } catch (e) {
                log(`Ê©üËÉΩÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº: ${e.message}`, 'warn');
            }
            
            return { 
                success: true, 
                displayedFunction: actualSelectedFunction 
            };
        } catch (error) {
            log(`‚ùå Ê©üËÉΩÈÅ∏Êäû„Ç®„É©„Éº: ${error.message}`, 'error');
            return { success: false, error: error.message };
        }
    }
    
    /**
     * ÈÄÅ‰ø°„Å®ÂøúÁ≠îÂèñÂæó„ÅÆ„ÅøÂÆüË°å
     */
    async function sendAndGetResponse() {
        try {
            log('üìù ÈÄÅ‰ø°„Å®ÂøúÁ≠îÂèñÂæó„ÇíÂÆüË°å', 'info');
            
            // ÈÄÅ‰ø°„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
            const sendBtn = await findElement(SELECTORS.sendButton, 'ÈÄÅ‰ø°„Éú„Çø„É≥');
            if (!sendBtn) {
                throw new Error('ÈÄÅ‰ø°„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            
            sendBtn.click();
            log('‚úÖ ÈÄÅ‰ø°„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ', 'success');
            await sleep(1000);
            
            // ÂÅúÊ≠¢„Éú„Çø„É≥„ÅåÊ∂à„Åà„Çã„Åæ„ÅßÂæÖÊ©üÔºàÊúÄÂ§ß5ÂàÜÔºâ
            let stopBtn = await findElement(SELECTORS.stopButton, 'ÂÅúÊ≠¢„Éú„Çø„É≥', 1);
            if (stopBtn) {
                log('ÂøúÁ≠îÂæÖÊ©ü‰∏≠...', 'info');
                for (let i = 0; i < 300; i++) {
                    stopBtn = await findElement(SELECTORS.stopButton, 'ÂÅúÊ≠¢„Éú„Çø„É≥', 1);
                    if (!stopBtn) {
                        log('ÂøúÁ≠îÂÆå‰∫Ü', 'success');
                        break;
                    }
                    await sleep(1000);
                }
            }
            
            await sleep(2000);
            
            // „ÉÜ„Ç≠„Çπ„ÉàÂèñÂæóÔºàCanvasÂÑ™ÂÖàÔºâ
            let responseText = '';
            
            // ÊúÄÂàù„Å´Canvas/Artifact„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàChatGPT CanvasÊ©üËÉΩÂØæÂøúÔºâ
            // ui-selectors.js„Åã„ÇâÂèñÂæó„ÄÅ„Åæ„Åü„ÅØ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            const canvasSelectors = (window.UI_SELECTORS && window.UI_SELECTORS.ChatGPT && window.UI_SELECTORS.ChatGPT.TEXT_EXTRACTION && window.UI_SELECTORS.ChatGPT.TEXT_EXTRACTION.CANVAS_ARTIFACT) ||
                [
                    '#prosemirror-editor-container .ProseMirror[contenteditable="false"]',
                    '#prosemirror-editor-container .ProseMirror',
                    'div._main_5jn6z_1.markdown.prose.ProseMirror',
                    '.ProseMirror[contenteditable="false"]',
                    'div.markdown.prose.ProseMirror[contenteditable="false"]'
                ];
            
            for (const selector of canvasSelectors) {
                const elements = document.querySelectorAll(selector);
                for (const elem of elements) {
                    const text = elem.textContent?.trim() || '';
                    if (text && text.length > 5) {
                        responseText = text;
                        log(`‚úÖ CanvasÂèñÂæóÊàêÂäü: ${text.length}ÊñáÂ≠ó`, 'success');
                        break;
                    }
                }
                if (responseText) break;
            }
            
            // Canvas„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åã„ÇâÂèñÂæó
            if (!responseText) {
                const assistantMessages = document.querySelectorAll('[data-message-author-role="assistant"]');
                if (assistantMessages.length > 0) {
                    const lastMessage = assistantMessages[assistantMessages.length - 1];
                    const elements = lastMessage.querySelectorAll('div.markdown.prose');
                    for (const elem of elements) {
                        const text = elem.textContent?.trim() || '';
                        if (text && text.length > 10) {
                            responseText = text;
                            break;
                        }
                    }
                }
            }
            
            if (responseText) {
                log(`‚úÖ ÂøúÁ≠îÂèñÂæóÊàêÂäü: ${responseText.length}ÊñáÂ≠ó`, 'success');
                
                // ÁèæÂú®Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„É¢„Éá„É´„Å®Ê©üËÉΩ„ÇíÂèñÂæó
                let displayedModel = '';
                let displayedFunction = '';
                
                try {
                    // ModelInfoExtractor„Çí‰ΩøÁî®Ôºà„Ç∞„É≠„Éº„Éê„É´„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÔºâ
                    if (window.ModelInfoExtractor) {
                        displayedModel = window.ModelInfoExtractor.extract('ChatGPT') || '';
                        log(`üìä ModelInfoExtractorÁµêÊûú: "${displayedModel}"`, 'info');
                    } else {
                        log('‚ö†Ô∏è ModelInfoExtractor„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì', 'warn');
                    }
                    
                    // FunctionInfoExtractor„Çí‰ΩøÁî®
                    if (window.FunctionInfoExtractor) {
                        displayedFunction = window.FunctionInfoExtractor.extract('ChatGPT') || '';
                        log(`üìä FunctionInfoExtractorÁµêÊûú: "${displayedFunction}"`, 'info');
                        
                        // Á©∫ÊñáÂ≠ó„ÅÆÂ†¥Âêà„ÅÆË®∫Êñ≠
                        if (!displayedFunction) {
                            log('‚ö†Ô∏è Ê©üËÉΩÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇUI„ÅÆÁä∂ÊÖã„ÇíË®∫Êñ≠„Åó„Åæ„Åô...', 'warn');
                            
                            // Canvas „Éë„Éç„É´„ÅÆÂ≠òÂú®Á¢∫Ë™ç
                            const canvasPanel = document.querySelector('#prosemirror-editor-container');
                            log(`  - Canvas„Éë„Éç„É´ (#prosemirror-editor-container): ${canvasPanel ? 'Â≠òÂú®' : 'Â≠òÂú®„Åó„Å™„ÅÑ'}`, 'info');
                            
                            // Ê©üËÉΩ„Éú„Çø„É≥„ÅÆÁ¢∫Ë™ç
                            const pillButtons = document.querySelectorAll('button[data-pill="true"]');
                            log(`  - Ê©üËÉΩ„Éú„Çø„É≥ (data-pill="true"): ${pillButtons.length}ÂÄã`, 'info');
                            if (pillButtons.length > 0) {
                                pillButtons.forEach((btn, idx) => {
                                    log(`    [${idx}] ${btn.textContent?.trim() || '(„ÉÜ„Ç≠„Çπ„Éà„Å™„Åó)'}`, 'info');
                                });
                            }
                            
                            // „É°„Éã„É•„ÉºÈ†ÖÁõÆ„ÅÆÁ¢∫Ë™ç
                            const checkedItems = document.querySelectorAll('[role="menuitemradio"][aria-checked="true"]');
                            log(`  - ÈÅ∏Êäû„Åï„Çå„Åü„É°„Éã„É•„ÉºÈ†ÖÁõÆ: ${checkedItems.length}ÂÄã`, 'info');
                            if (checkedItems.length > 0) {
                                checkedItems.forEach((item, idx) => {
                                    log(`    [${idx}] ${item.textContent?.trim() || '(„ÉÜ„Ç≠„Çπ„Éà„Å™„Åó)'}`, 'info');
                                });
                            }
                        }
                    } else {
                        log('‚ö†Ô∏è FunctionInfoExtractor„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì', 'warn');
                    }
                } catch (e) {
                    log(`‚ùå „É¢„Éá„É´/Ê©üËÉΩÊÉÖÂ†±„ÅÆÂèñÂæó„Ç®„É©„Éº: ${e.message}`, 'error');
                    console.error(e);
                }
                
                return { 
                    success: true, 
                    response: responseText,
                    displayedModel: displayedModel,
                    displayedFunction: displayedFunction
                };
            } else {
                throw new Error('ÂøúÁ≠î„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
            }
            
        } catch (error) {
            log(`‚ùå ÈÄÅ‰ø°„ÉªÂøúÁ≠îÂèñÂæó„Ç®„É©„Éº: ${error.message}`, 'error');
            return { success: false, error: error.message };
        }
    }
    
    // ========================================
    // „Ç∞„É≠„Éº„Éê„É´ÂÖ¨Èñã
    // ========================================
    window.ChatGPTAutomationV2 = {
        executeTask,
        runAutomation,
        // „Éï„Çß„Éº„Ç∫Âà•„É°„ÇΩ„ÉÉ„ÉâÔºàÈ†ÜÊ¨°Âá¶ÁêÜÁî®Ôºâ
        inputTextOnly,
        selectModelOnly,
        selectFunctionOnly,
        sendAndGetResponse
    };
    
    console.log('‚úÖ ChatGPT Automation V2 Ê∫ñÂÇôÂÆå‰∫Ü');
    console.log('‰ΩøÁî®ÊñπÊ≥ï: ChatGPTAutomationV2.executeTask({ model: "GPT-4o", function: "Deep Research", prompt: "..." })');
    
})();