/**
 * @fileoverview ChatGPT Automation V2 - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç›´æ¥å®Ÿè¡Œç‰ˆ
 * 
 * ç‰¹å¾´:
 * - ãƒ¢ãƒ‡ãƒ«ã¨æ©Ÿèƒ½ã®äº‹å‰æ¢ç´¢ãªã—
 * - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥å®Ÿè¡Œ
 * - Deep Research/ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼ˆæœ€å¤§40åˆ†å¾…æ©Ÿï¼‰
 * 
 * @version 2.0.0
 */
(function() {
    'use strict';
    
    console.log('%cğŸš€ ChatGPT Automation V2 åˆæœŸåŒ–', 'color: #4CAF50; font-weight: bold; font-size: 16px');
    
    // ========================================
    // ã‚»ãƒ¬ã‚¯ã‚¿å®šç¾©ï¼ˆæä¾›ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æŠ½å‡ºï¼‰
    // ========================================
    const SELECTORS = {
        // ãƒ¢ãƒ‡ãƒ«é–¢é€£
        modelButton: [
            '[data-testid="model-switcher-dropdown-button"]',
            'button[aria-label*="ãƒ¢ãƒ‡ãƒ« ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼"]',
            'button[aria-label*="ãƒ¢ãƒ‡ãƒ«"][aria-haspopup="menu"]',
            '#radix-\\:r2m\\:',
            'button.group.flex.cursor-pointer[aria-haspopup="menu"]'
        ],
        modelMenu: [
            '[role="menu"][data-radix-menu-content]',
            '[role="menu"][data-state="open"]',
            'div.z-50.max-w-xs.rounded-2xl.popover[role="menu"]'
        ],
        legacyButton: [
            '[data-testid="ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ¢ãƒ‡ãƒ«-submenu"]',
            '[role="menuitem"][data-has-submenu]:contains("ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ¢ãƒ‡ãƒ«")',
            '[role="menuitem"][aria-haspopup="menu"]:last-of-type'
        ],
        // æ©Ÿèƒ½é–¢é€£
        menuButton: [
            '[data-testid="composer-plus-btn"]',
            'button[aria-haspopup="menu"]',
            'button.composer-btn'
        ],
        mainMenu: [
            '[role="menu"][data-state="open"]',
            '[data-radix-menu-content]',
            'div[data-side="bottom"][role="menu"]'
        ],
        subMenu: [
            '[role="menu"][data-side="right"]',
            'div[data-side="right"][role="menu"]'
        ],
        // å…¥åŠ›ãƒ»é€ä¿¡é–¢é€£
        textInput: [
            '.ProseMirror',
            '#prompt-textarea',
            '[contenteditable="true"][translate="no"]',
            'div.ProseMirror.text-token-text-primary'
        ],
        sendButton: [
            '[data-testid="send-button"]',
            '#composer-submit-button',
            'button[aria-label="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡ã™ã‚‹"]'
        ],
        stopButton: [
            '[data-testid="stop-button"]',
            '#composer-submit-button[aria-label="ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®åœæ­¢"]',
            'button:has(svg path[d*="M4.5 5.75"])'
        ],
        // çµæœå–å¾—é–¢é€£
        canvasText: [
            'div.markdown.prose',
            'div.w-full.pt-1.pb-1'
        ],
        normalText: [
            '[data-message-author-role="assistant"]',
            'div.text-message'
        ]
    };
    
    // ========================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ========================================
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    
    const log = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString('ja-JP', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        });
        
        const styles = {
            info: 'color: #2196F3',
            success: 'color: #4CAF50',
            warning: 'color: #FF9800',
            error: 'color: #F44336',
            step: 'color: #9C27B0; font-weight: bold'
        };
        
        console.log(`%c[${timestamp}] ${message}`, styles[type] || styles.info);
    };
    
    const findElement = async (selectors, maxRetries = 3) => {
        for (let retry = 0; retry < maxRetries; retry++) {
            for (const selector of selectors) {
                try {
                    const element = document.querySelector(selector);
                    if (element && isElementInteractable(element)) {
                        return element;
                    }
                } catch (e) {
                    // ã‚»ãƒ¬ã‚¯ã‚¿ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
                }
            }
            
            if (retry < maxRetries - 1) {
                await wait(500);
            }
        }
        return null;
    };
    
    const isElementInteractable = (element) => {
        if (!element) return false;
        const rect = element.getBoundingClientRect();
        const style = window.getComputedStyle(element);
        return rect.width > 0 && 
               rect.height > 0 && 
               style.display !== 'none' && 
               style.visibility !== 'hidden' && 
               style.opacity !== '0';
    };
    
    const findElementByText = (selector, text, parent = document) => {
        const elements = parent.querySelectorAll(selector);
        for (const el of elements) {
            if (el.textContent && el.textContent.includes(text)) {
                return el;
            }
        }
        return null;
    };
    
    // ========================================
    // ãƒ¢ãƒ‡ãƒ«é¸æŠ
    // ========================================
    async function selectModel(modelName) {
        console.log(`[selectModel] å‘¼ã³å‡ºã— - ãƒ¢ãƒ‡ãƒ«å: "${modelName}"`);
        
        // Auto/default/ç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’æ˜ç¤ºçš„ã«é¸æŠ
        const useDefault = !modelName || modelName === '' || modelName === 'default' || 
                          (typeof modelName === 'string' && modelName.toLowerCase() === 'auto');
        
        if (useDefault) {
            log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ï¼ˆGPT-4oï¼‰ã‚’é¸æŠ', 'info');
            console.log('[selectModel] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¾ã™');
            modelName = 'GPT-4o';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
        } else {
            log(`ãƒ¢ãƒ‡ãƒ«é¸æŠ: ${modelName}`, 'step');
        }
        
        try {
            // å¸¸ã«ãƒ¢ãƒ‡ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãï¼ˆAutoã§ã‚‚é–‹ãï¼‰
            const modelButton = await findElement(SELECTORS.modelButton);
            if (!modelButton) {
                log('ãƒ¢ãƒ‡ãƒ«ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                return false;
            }
            
            modelButton.click();
            await wait(1500);
            
            // ãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã™
            const modelMenu = await findElement(SELECTORS.modelMenu);
            if (!modelMenu) {
                log('ãƒ¢ãƒ‡ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ãã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                return false;
            }
            
            // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ¢ã™
            let modelItem = findElementByText('[role="menuitem"]', modelName, modelMenu);
            
            // ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®å ´åˆ
            if (!modelItem && modelName.toLowerCase().includes('gpt')) {
                const legacyButton = findElementByText('[role="menuitem"]', 'ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ¢ãƒ‡ãƒ«', modelMenu);
                if (legacyButton) {
                    legacyButton.click();
                    await wait(1000);
                    
                    // ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ¢ã™
                    const allMenus = document.querySelectorAll('[role="menu"]');
                    for (const menu of allMenus) {
                        modelItem = findElementByText('[role="menuitem"]', modelName, menu);
                        if (modelItem) break;
                    }
                }
            }
            
            if (modelItem) {
                modelItem.click();
                await wait(2000);
                log(`ãƒ¢ãƒ‡ãƒ«é¸æŠå®Œäº†: ${modelName}`, 'success');
                return true;
            } else {
                log(`ãƒ¢ãƒ‡ãƒ« "${modelName}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'warning');
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
                document.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape' }));
                await wait(500);
                return false;
            }
            
        } catch (error) {
            log(`ãƒ¢ãƒ‡ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            return false;
        }
    }
    
    // ========================================
    // æ©Ÿèƒ½é¸æŠ
    // ========================================
    async function selectFeature(featureName) {
        // nullã€undefinedã€ç©ºæ–‡å­—ã€'none'ã€'é€šå¸¸'ã®å ´åˆã¯é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
        if (!featureName || featureName === '' || featureName === 'none' || featureName === 'é€šå¸¸') {
            log('é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨', 'info');
            return true;
        }
        
        log(`æ©Ÿèƒ½é¸æŠ: ${featureName}`, 'step');
        
        try {
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
            const menuButton = await findElement(SELECTORS.menuButton);
            if (!menuButton) {
                log('æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                return false;
            }
            
            menuButton.click();
            await wait(1500);
            
            const mainMenu = await findElement(SELECTORS.mainMenu);
            if (!mainMenu) {
                log('æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ãã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                return false;
            }
            
            // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ¢ã™
            let featureItem = findElementByText('[role="menuitemradio"]', featureName, mainMenu);
            
            // ã•ã‚‰ã«è¡¨ç¤ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ¢ã™
            if (!featureItem) {
                const moreButton = findElementByText('[role="menuitem"]', 'ã•ã‚‰ã«è¡¨ç¤º', mainMenu);
                if (moreButton) {
                    moreButton.click();
                    await wait(1000);
                    
                    const subMenu = document.querySelector('[data-side="right"]');
                    if (subMenu) {
                        featureItem = findElementByText('[role="menuitemradio"]', featureName, subMenu);
                    }
                }
            }
            
            if (featureItem) {
                featureItem.click();
                await wait(1500);
                log(`æ©Ÿèƒ½é¸æŠå®Œäº†: ${featureName}`, 'success');
            } else {
                log(`æ©Ÿèƒ½ "${featureName}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'warning');
            }
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            document.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape' }));
            await wait(500);
            
            return true;
            
        } catch (error) {
            log(`æ©Ÿèƒ½é¸æŠã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            return false;
        }
    }
    
    // ========================================
    // Deep Research/ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ç‰¹åˆ¥å‡¦ç†
    // ========================================
    async function handleSpecialModeWaiting(featureName) {
        const isSpecialMode = featureName && (
            featureName.includes('Deep Research') || 
            featureName.includes('ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ')
        );
        
        if (!isSpecialMode) {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
            return await handleNormalWaiting();
        }
        
        log(`ã€${featureName}ç‰¹åˆ¥å‡¦ç†ã€‘é–‹å§‹ï¼ˆæœ€å¤§40åˆ†å¾…æ©Ÿï¼‰`, 'step');
        
        // 1-1: åœæ­¢ãƒœã‚¿ãƒ³ãŒå‡ºã¦ãã‚‹ã¾ã§å¾…æ©Ÿ
        log('åœæ­¢ãƒœã‚¿ãƒ³ã®å‡ºç¾ã‚’å¾…æ©Ÿä¸­...', 'info');
        let stopBtn = null;
        for (let i = 0; i < 60; i++) {
            stopBtn = await findElement(SELECTORS.stopButton, 1);
            if (stopBtn) {
                log(`åœæ­¢ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ (${i+1}ç§’å¾Œ)`, 'success');
                break;
            }
            await wait(1000);
        }
        
        if (!stopBtn) {
            log('åœæ­¢ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
            return false;
        }
        
        // 1-2: 5åˆ†é–“å¾…æ©Ÿã—ã¦åœæ­¢ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ç¢ºèª
        log('5åˆ†é–“å¾…æ©Ÿä¸­...', 'info');
        const fiveMinutes = 300; // 5åˆ† = 300ç§’
        let disappeared = false;
        
        for (let i = 0; i < fiveMinutes; i++) {
            stopBtn = await findElement(SELECTORS.stopButton, 1);
            
            if (!stopBtn) {
                disappeared = true;
                const minutes = Math.floor(i / 60);
                const seconds = i % 60;
                log(`åœæ­¢ãƒœã‚¿ãƒ³ãŒæ¶ˆæ»…ã—ã¾ã—ãŸ (${minutes}åˆ†${seconds}ç§’ã§æ¶ˆæ»…)`, 'warning');
                break;
            }
            
            if (i % 30 === 0 && i > 0) {
                const minutes = Math.floor(i / 60);
                const seconds = i % 60;
                log(`å¾…æ©Ÿä¸­... (${minutes}åˆ†${seconds}ç§’çµŒé)`, 'info');
            }
            
            await wait(1000);
        }
        
        // 1-3: 5åˆ†ä»¥å†…ã«åœæ­¢ãƒœã‚¿ãƒ³ãŒæ¶ˆæ»…ã—ãŸå ´åˆã€å†é€ä¿¡
        if (disappeared) {
            log('ã€Œã„ã„ã‹ã‚‰å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¢ºèªã—ã¦ä½œæ¥­ã‚’ã—ã¦ã€ã‚’å†é€ä¿¡', 'step');
            
            await wait(2000);
            
            const input = await findElement(SELECTORS.textInput);
            if (input) {
                await inputText(input, 'ã„ã„ã‹ã‚‰å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¢ºèªã—ã¦ä½œæ¥­ã‚’ã—ã¦');
                await wait(1000);
                
                const sendBtn = await findElement(SELECTORS.sendButton);
                if (sendBtn) {
                    sendBtn.click();
                    log('å†é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                    await wait(3000);
                }
            }
        }
        
        // 1-4: åœæ­¢ãƒœã‚¿ãƒ³ãŒ10ç§’é–“é€£ç¶šã§æ¶ˆæ»…ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§40åˆ†ï¼‰
        log('å¿œç­”å®Œäº†ã‚’å¾…æ©Ÿä¸­ï¼ˆæœ€å¤§40åˆ†ï¼‰...', 'info');
        
        const maxWaitTime = 40 * 60; // 40åˆ† = 2400ç§’
        let consecutiveAbsent = 0;
        
        for (let i = 0; i < maxWaitTime; i++) {
            stopBtn = await findElement(SELECTORS.stopButton, 1);
            
            if (!stopBtn) {
                consecutiveAbsent++;
                if (consecutiveAbsent >= 10) {
                    log('åœæ­¢ãƒœã‚¿ãƒ³ãŒ10ç§’é–“é€£ç¶šã§æ¶ˆæ»…ã—ã¾ã—ãŸã€‚å¿œç­”å®Œäº†ï¼', 'success');
                    break;
                }
            } else {
                consecutiveAbsent = 0;
            }
            
            if (i % 60 === 0 && i > 0) {
                const minutes = Math.floor(i / 60);
                log(`å¾…æ©Ÿä¸­... (${minutes}åˆ†çµŒé / æœ€å¤§40åˆ†)`, 'info');
            }
            
            await wait(1000);
        }
        
        await wait(2000);
        return true;
    }
    
    // ========================================
    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰å¾…æ©Ÿå‡¦ç†
    // ========================================
    async function handleNormalWaiting() {
        log('é€šå¸¸ãƒ¢ãƒ¼ãƒ‰å¾…æ©Ÿå‡¦ç†', 'info');
        
        // åœæ­¢ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
        let stopBtn = null;
        for (let i = 0; i < 30; i++) {
            stopBtn = await findElement(SELECTORS.stopButton, 1);
            if (stopBtn) {
                log('åœæ­¢ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ', 'success');
                break;
            }
            await wait(1000);
        }
        
        // åœæ­¢ãƒœã‚¿ãƒ³ãŒæ¶ˆãˆã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§5åˆ†ï¼‰
        if (stopBtn) {
            log('å¿œç­”å®Œäº†ã‚’å¾…æ©Ÿä¸­ï¼ˆæœ€å¤§5åˆ†ï¼‰...', 'info');
            for (let i = 0; i < 300; i++) {
                stopBtn = await findElement(SELECTORS.stopButton, 1);
                if (!stopBtn) {
                    log('å¿œç­”å®Œäº†', 'success');
                    break;
                }
                if (i % 30 === 0 && i > 0) {
                    log(`å¾…æ©Ÿä¸­... (${i}ç§’çµŒé)`, 'info');
                }
                await wait(1000);
            }
        }
        
        await wait(2000);
        return true;
    }
    
    // ========================================
    // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
    // ========================================
    async function inputText(element, text) {
        if (element.classList.contains('ProseMirror') || element.classList.contains('ql-editor')) {
            element.innerHTML = '';
            const p = document.createElement('p');
            p.textContent = text;
            element.appendChild(p);
            element.classList.remove('ql-blank');
            element.dispatchEvent(new Event('input', { bubbles: true }));
            element.dispatchEvent(new Event('change', { bubbles: true }));
        } else {
            element.textContent = text;
            element.dispatchEvent(new Event('input', { bubbles: true }));
        }
    }
    
    // ========================================
    // å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
    // ========================================
    async function getResponseText() {
        log('å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆå–å¾—', 'step');
        
        let canvasText = '';
        let normalText = '';
        
        // Canvasæ©Ÿèƒ½ã®ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        const canvasContainers = document.querySelectorAll('div.w-full.pt-1.pb-1');
        for (const container of canvasContainers) {
            const markdownDiv = container.querySelector('div.markdown.prose');
            if (markdownDiv) {
                const parentMessage = markdownDiv.closest('[data-message-author-role]');
                if (!parentMessage) {
                    canvasText = markdownDiv.textContent?.trim() || '';
                    if (canvasText) {
                        log(`Canvas ãƒ†ã‚­ã‚¹ãƒˆå–å¾—: ${canvasText.length}æ–‡å­—`, 'success');
                        break;
                    }
                }
            }
        }
        
        // é€šå¸¸å‡¦ç†ã®ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        const assistantMessages = document.querySelectorAll('[data-message-author-role="assistant"]');
        if (assistantMessages.length > 0) {
            const lastMessage = assistantMessages[assistantMessages.length - 1];
            const markdownDivs = lastMessage.querySelectorAll('div.markdown');
            for (const markdownDiv of markdownDivs) {
                const text = markdownDiv.textContent?.trim() || '';
                if (text && text !== canvasText) {
                    normalText = text;
                    log(`é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆå–å¾—: ${normalText.length}æ–‡å­—`, 'success');
                    break;
                }
            }
        }
        
        // ã©ã¡ã‚‰ã‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™ï¼ˆCanvasã‚’å„ªå…ˆï¼‰
        return canvasText || normalText || '';
    }
    
    // ========================================
    // ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
    // ========================================
    async function executeTask(taskData) {
        console.log('%cğŸš€ ChatGPT V2 ã‚¿ã‚¹ã‚¯å®Ÿè¡Œé–‹å§‹', 'color: #00BCD4; font-weight: bold; font-size: 16px');
        console.log('å—ä¿¡ã—ãŸã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿:', {
            model: taskData.model,
            function: taskData.function,
            promptLength: taskData.prompt?.length || taskData.text?.length || 0,
            hasPrompt: !!(taskData.prompt || taskData.text)
        });
        
        try {
            // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
            const modelName = taskData.model;  // ãã®ã¾ã¾ï¼ˆå¤‰æ›ã—ãªã„ï¼‰
            const featureName = taskData.function;  // ãã®ã¾ã¾ï¼ˆå¤‰æ›ã—ãªã„ï¼‰
            const promptText = taskData.prompt || taskData.text || '';
            
            console.log(`ãƒ¢ãƒ‡ãƒ«: "${modelName}", æ©Ÿèƒ½: "${featureName}"`);
            
            if (!promptText) {
                throw new Error('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            // 1. ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
            log('ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›', 'step');
            const input = await findElement(SELECTORS.textInput);
            if (!input) {
                throw new Error('å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            await inputText(input, promptText);
            log('ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›å®Œäº†', 'success');
            await wait(1000);
            
            // 2. ãƒ¢ãƒ‡ãƒ«é¸æŠ
            await selectModel(modelName);
            
            // 3. æ©Ÿèƒ½é¸æŠ
            await selectFeature(featureName);
            
            // 4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
            log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡', 'step');
            const sendBtn = await findElement(SELECTORS.sendButton);
            if (!sendBtn) {
                throw new Error('é€ä¿¡ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            sendBtn.click();
            log('é€ä¿¡å®Œäº†', 'success');
            await wait(1000);
            
            // 5. å¿œç­”å¾…æ©Ÿ
            await handleSpecialModeWaiting(featureName);
            
            // 6. ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
            const responseText = await getResponseText();
            
            if (responseText) {
                console.log('âœ… ChatGPT V2 ã‚¿ã‚¹ã‚¯å®Ÿè¡Œå®Œäº†');
                return {
                    success: true,
                    response: responseText
                };
            } else {
                throw new Error('å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
            }
            
        } catch (error) {
            console.error('âŒ ChatGPT V2 ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }
    
    // ========================================
    // runAutomationé–¢æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    // ========================================
    async function runAutomation(config) {
        return executeTask({
            model: config.model,
            function: config.function,
            prompt: config.text || config.prompt
        });
    }
    
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
    // ========================================
    window.ChatGPTAutomationV2 = {
        executeTask,
        runAutomation
    };
    
    console.log('âœ… ChatGPT Automation V2 æº–å‚™å®Œäº†');
    console.log('ä½¿ç”¨æ–¹æ³•: ChatGPTAutomationV2.executeTask({ model: "GPT-4", function: "Deep Research", prompt: "..." })');
    
})();