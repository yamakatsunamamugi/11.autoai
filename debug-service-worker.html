<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Service Worker ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }
    .error {
      background: #fee;
      border-left-color: #f44;
    }
    .success {
      background: #efe;
      border-left-color: #4c4;
    }
    .warning {
      background: #ffe;
      border-left-color: #fa0;
    }
    code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 14px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #5a67d8;
    }
    .log-entry {
      margin: 5px 0;
      padding: 8px;
      background: #f8f8f8;
      border-left: 3px solid #ccc;
      font-family: monospace;
      font-size: 13px;
    }
    .log-error {
      border-left-color: #f44;
      background: #fff5f5;
    }
    .log-success {
      border-left-color: #4c4;
      background: #f5fff5;
    }
    .log-info {
      border-left-color: #4af;
      background: #f5f9ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Chromeæ‹¡å¼µæ©Ÿèƒ½ Service Worker ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="section" id="status">
      <h2>ç¾åœ¨ã®çŠ¶æ…‹</h2>
      <div id="statusContent">ãƒã‚§ãƒƒã‚¯ä¸­...</div>
    </div>

    <div class="section">
      <h2>ãƒ‡ãƒãƒƒã‚°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
      <button onclick="checkExtensionContext()">æ‹¡å¼µæ©Ÿèƒ½ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèª</button>
      <button onclick="checkChromeAPIs()">Chrome APIã®å¯ç”¨æ€§ã‚’ç¢ºèª</button>
      <button onclick="testBackgroundConnection()">Backgroundæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
      <button onclick="checkManifest()">Manifestç¢ºèª</button>
      <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="section">
      <h2>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h2>
      <div id="debugLog"></div>
    </div>

    <div class="section error">
      <h2>ã‚¨ãƒ©ãƒ¼åŸå› ã¨è§£æ±ºæ–¹æ³•</h2>
      <div id="errorAnalysis">
        <p><strong>Status code: 3</strong> ã¯ä»¥ä¸‹ã®åŸå› ã§ç™ºç”Ÿã—ã¾ã™ï¼š</p>
        <ol>
          <li><strong>ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ï¼š</strong> file:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹</li>
          <li><strong>æ‹¡å¼µæ©Ÿèƒ½ãŒæœªãƒ­ãƒ¼ãƒ‰ï¼š</strong> Chromeæ‹¡å¼µæ©Ÿèƒ½ã¨ã—ã¦èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„</li>
          <li><strong>Service Workerã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ï¼š</strong> background.jsã¾ãŸã¯ãã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹</li>
        </ol>
      </div>
    </div>

    <div class="section warning">
      <h2>æ­£ã—ã„ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•</h2>
      <pre>1. chrome://extensions/ ã‚’é–‹ã
2. ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹
3. ã€Œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. /Users/roudousha/Dropbox/11.autoai ã‚’é¸æŠ
5. æ‹¡å¼µæ©Ÿèƒ½IDã‚’ã‚³ãƒ”ãƒ¼
6. chrome-extension://[æ‹¡å¼µæ©Ÿèƒ½ID]/debug-service-worker.html ã«ã‚¢ã‚¯ã‚»ã‚¹</pre>
    </div>
  </div>

  <script>
    const log = (message, type = 'info') => {
      const logDiv = document.getElementById('debugLog');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      console.log(`[${type.toUpperCase()}] ${message}`);
    };

    const updateStatus = (message, type = 'info') => {
      const statusDiv = document.getElementById('statusContent');
      statusDiv.className = type;
      statusDiv.innerHTML = message;
    };

    // åˆæœŸãƒã‚§ãƒƒã‚¯
    window.addEventListener('DOMContentLoaded', () => {
      checkExtensionContext();
    });

    function checkExtensionContext() {
      log('æ‹¡å¼µæ©Ÿèƒ½ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­...', 'info');
      
      if (typeof chrome === 'undefined') {
        log('âŒ chrome ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæœªå®šç¾©', 'error');
        updateStatus('Chrome APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚file:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚', 'error');
        return;
      }

      if (!chrome.runtime) {
        log('âŒ chrome.runtime ãŒæœªå®šç¾©', 'error');
        updateStatus('chrome.runtime APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'error');
        return;
      }

      if (!chrome.runtime.id) {
        log('âŒ æ‹¡å¼µæ©Ÿèƒ½IDãŒå–å¾—ã§ãã¾ã›ã‚“', 'error');
        updateStatus('æ‹¡å¼µæ©Ÿèƒ½ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚chrome-extension:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }

      log(`âœ… æ‹¡å¼µæ©Ÿèƒ½ID: ${chrome.runtime.id}`, 'success');
      updateStatus(`æ‹¡å¼µæ©Ÿèƒ½ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œä¸­<br>ID: ${chrome.runtime.id}`, 'success');
      
      // Service Worker ã®çŠ¶æ…‹ã‚’ç¢ºèª
      if (navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          log(`Service Workerç™»éŒ²æ•°: ${registrations.length}`, 'info');
          registrations.forEach(reg => {
            log(`SW: ${reg.scope} - ${reg.active ? 'Active' : 'Inactive'}`, 'info');
          });
        });
      }
    }

    function checkChromeAPIs() {
      log('Chrome APIå¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯é–‹å§‹', 'info');
      
      const apis = [
        'runtime', 'storage', 'tabs', 'windows', 'identity',
        'system', 'scripting', 'action'
      ];
      
      apis.forEach(api => {
        if (chrome[api]) {
          log(`âœ… chrome.${api} - åˆ©ç”¨å¯èƒ½`, 'success');
        } else {
          log(`âŒ chrome.${api} - åˆ©ç”¨ä¸å¯`, 'error');
        }
      });
    }

    function testBackgroundConnection() {
      log('Background Service Workerã¸ã®æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      
      if (!chrome.runtime || !chrome.runtime.sendMessage) {
        log('âŒ chrome.runtime.sendMessage ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
        return;
      }

      // Background ã«ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
      chrome.runtime.sendMessage(
        { action: 'checkServiceWorkerStatus' },
        response => {
          if (chrome.runtime.lastError) {
            log(`âŒ Backgroundæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${chrome.runtime.lastError.message}`, 'error');
          } else if (response) {
            log(`âœ… Backgroundå¿œç­”: ${JSON.stringify(response)}`, 'success');
          } else {
            log('âš ï¸ Backgroundã‹ã‚‰å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
          }
        }
      );
    }

    function checkManifest() {
      log('Manifest.json ã®ç¢ºèª', 'info');
      
      if (!chrome.runtime || !chrome.runtime.getManifest) {
        log('âŒ Manifestã‚’å–å¾—ã§ãã¾ã›ã‚“', 'error');
        return;
      }

      const manifest = chrome.runtime.getManifest();
      log(`âœ… Manifest version: ${manifest.manifest_version}`, 'success');
      log(`âœ… æ‹¡å¼µæ©Ÿèƒ½å: ${manifest.name}`, 'success');
      log(`âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${manifest.version}`, 'success');
      
      if (manifest.background) {
        log(`âœ… Backgroundè¨­å®š:`, 'success');
        log(`  - Service Worker: ${manifest.background.service_worker}`, 'info');
        log(`  - Type: ${manifest.background.type}`, 'info');
      }
      
      // web_accessible_resources ã®ç¢ºèª
      if (manifest.web_accessible_resources) {
        const resources = manifest.web_accessible_resources[0].resources;
        const testFiles = resources.filter(r => r.includes('test'));
        log(`âœ… ãƒ†ã‚¹ãƒˆé–¢é€£ã®web_accessible_resources: ${testFiles.length}å€‹`, 'info');
        testFiles.slice(0, 5).forEach(file => {
          log(`  - ${file}`, 'info');
        });
      }
    }

    function clearLogs() {
      document.getElementById('debugLog').innerHTML = '';
      log('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
    }

    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°åˆ†æ
    function analyzeError() {
      const url = window.location.href;
      const protocol = window.location.protocol;
      
      log(`ç¾åœ¨ã®URL: ${url}`, 'info');
      log(`ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${protocol}`, 'info');
      
      if (protocol === 'file:') {
        log('âŒ file:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™', 'error');
        log('è§£æ±ºæ–¹æ³•: chrome-extension:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„', 'error');
        
        const errorDiv = document.getElementById('errorAnalysis');
        errorDiv.innerHTML += `
          <div style="background: #ffe; padding: 10px; margin: 10px 0; border-radius: 6px;">
            <strong>æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ:</strong><br>
            ç¾åœ¨ file:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚<br>
            Chromeæ‹¡å¼µæ©Ÿèƒ½ã®Service Workerã¯ chrome-extension:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚
          </div>
        `;
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
    setTimeout(analyzeError, 100);
  </script>
</body>
</html>