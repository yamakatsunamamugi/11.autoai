<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Service Worker デバッグツール</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }
    .error {
      background: #fee;
      border-left-color: #f44;
    }
    .success {
      background: #efe;
      border-left-color: #4c4;
    }
    .warning {
      background: #ffe;
      border-left-color: #fa0;
    }
    code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 14px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #5a67d8;
    }
    .log-entry {
      margin: 5px 0;
      padding: 8px;
      background: #f8f8f8;
      border-left: 3px solid #ccc;
      font-family: monospace;
      font-size: 13px;
    }
    .log-error {
      border-left-color: #f44;
      background: #fff5f5;
    }
    .log-success {
      border-left-color: #4c4;
      background: #f5fff5;
    }
    .log-info {
      border-left-color: #4af;
      background: #f5f9ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 Chrome拡張機能 Service Worker デバッグツール</h1>
    
    <div class="section" id="status">
      <h2>現在の状態</h2>
      <div id="statusContent">チェック中...</div>
    </div>

    <div class="section">
      <h2>デバッグアクション</h2>
      <button onclick="checkExtensionContext()">拡張機能コンテキストを確認</button>
      <button onclick="checkChromeAPIs()">Chrome APIの可用性を確認</button>
      <button onclick="testBackgroundConnection()">Background接続テスト</button>
      <button onclick="checkManifest()">Manifest確認</button>
      <button onclick="clearLogs()">ログクリア</button>
    </div>

    <div class="section">
      <h2>デバッグログ</h2>
      <div id="debugLog"></div>
    </div>

    <div class="section error">
      <h2>エラー原因と解決方法</h2>
      <div id="errorAnalysis">
        <p><strong>Status code: 3</strong> は以下の原因で発生します：</p>
        <ol>
          <li><strong>直接ファイルアクセス：</strong> file:// プロトコルでアクセスしている</li>
          <li><strong>拡張機能が未ロード：</strong> Chrome拡張機能として読み込まれていない</li>
          <li><strong>Service Workerの構文エラー：</strong> background.jsまたはそのインポートにエラーがある</li>
        </ol>
      </div>
    </div>

    <div class="section warning">
      <h2>正しいアクセス方法</h2>
      <pre>1. chrome://extensions/ を開く
2. デベロッパーモードを有効にする
3. 「パッケージ化されていない拡張機能を読み込む」をクリック
4. /Users/roudousha/Dropbox/11.autoai を選択
5. 拡張機能IDをコピー
6. chrome-extension://[拡張機能ID]/debug-service-worker.html にアクセス</pre>
    </div>
  </div>

  <script>
    const log = (message, type = 'info') => {
      const logDiv = document.getElementById('debugLog');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      console.log(`[${type.toUpperCase()}] ${message}`);
    };

    const updateStatus = (message, type = 'info') => {
      const statusDiv = document.getElementById('statusContent');
      statusDiv.className = type;
      statusDiv.innerHTML = message;
    };

    // 初期チェック
    window.addEventListener('DOMContentLoaded', () => {
      checkExtensionContext();
    });

    function checkExtensionContext() {
      log('拡張機能コンテキストをチェック中...', 'info');
      
      if (typeof chrome === 'undefined') {
        log('❌ chrome オブジェクトが未定義', 'error');
        updateStatus('Chrome APIが利用できません。file:// プロトコルでアクセスしています。', 'error');
        return;
      }

      if (!chrome.runtime) {
        log('❌ chrome.runtime が未定義', 'error');
        updateStatus('chrome.runtime APIが利用できません。', 'error');
        return;
      }

      if (!chrome.runtime.id) {
        log('❌ 拡張機能IDが取得できません', 'error');
        updateStatus('拡張機能コンテキストではありません。chrome-extension:// プロトコルでアクセスしてください。', 'error');
        return;
      }

      log(`✅ 拡張機能ID: ${chrome.runtime.id}`, 'success');
      updateStatus(`拡張機能コンテキストで実行中<br>ID: ${chrome.runtime.id}`, 'success');
      
      // Service Worker の状態を確認
      if (navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          log(`Service Worker登録数: ${registrations.length}`, 'info');
          registrations.forEach(reg => {
            log(`SW: ${reg.scope} - ${reg.active ? 'Active' : 'Inactive'}`, 'info');
          });
        });
      }
    }

    function checkChromeAPIs() {
      log('Chrome API可用性チェック開始', 'info');
      
      const apis = [
        'runtime', 'storage', 'tabs', 'windows', 'identity',
        'system', 'scripting', 'action'
      ];
      
      apis.forEach(api => {
        if (chrome[api]) {
          log(`✅ chrome.${api} - 利用可能`, 'success');
        } else {
          log(`❌ chrome.${api} - 利用不可`, 'error');
        }
      });
    }

    function testBackgroundConnection() {
      log('Background Service Workerへの接続テスト開始', 'info');
      
      if (!chrome.runtime || !chrome.runtime.sendMessage) {
        log('❌ chrome.runtime.sendMessage が利用できません', 'error');
        return;
      }

      // Background にテストメッセージを送信
      chrome.runtime.sendMessage(
        { action: 'checkServiceWorkerStatus' },
        response => {
          if (chrome.runtime.lastError) {
            log(`❌ Background接続エラー: ${chrome.runtime.lastError.message}`, 'error');
          } else if (response) {
            log(`✅ Background応答: ${JSON.stringify(response)}`, 'success');
          } else {
            log('⚠️ Backgroundから応答がありません', 'warning');
          }
        }
      );
    }

    function checkManifest() {
      log('Manifest.json の確認', 'info');
      
      if (!chrome.runtime || !chrome.runtime.getManifest) {
        log('❌ Manifestを取得できません', 'error');
        return;
      }

      const manifest = chrome.runtime.getManifest();
      log(`✅ Manifest version: ${manifest.manifest_version}`, 'success');
      log(`✅ 拡張機能名: ${manifest.name}`, 'success');
      log(`✅ バージョン: ${manifest.version}`, 'success');
      
      if (manifest.background) {
        log(`✅ Background設定:`, 'success');
        log(`  - Service Worker: ${manifest.background.service_worker}`, 'info');
        log(`  - Type: ${manifest.background.type}`, 'info');
      }
      
      // web_accessible_resources の確認
      if (manifest.web_accessible_resources) {
        const resources = manifest.web_accessible_resources[0].resources;
        const testFiles = resources.filter(r => r.includes('test'));
        log(`✅ テスト関連のweb_accessible_resources: ${testFiles.length}個`, 'info');
        testFiles.slice(0, 5).forEach(file => {
          log(`  - ${file}`, 'info');
        });
      }
    }

    function clearLogs() {
      document.getElementById('debugLog').innerHTML = '';
      log('ログをクリアしました', 'info');
    }

    // エラーの詳細分析
    function analyzeError() {
      const url = window.location.href;
      const protocol = window.location.protocol;
      
      log(`現在のURL: ${url}`, 'info');
      log(`プロトコル: ${protocol}`, 'info');
      
      if (protocol === 'file:') {
        log('❌ file:// プロトコルでアクセスしています', 'error');
        log('解決方法: chrome-extension:// プロトコルでアクセスしてください', 'error');
        
        const errorDiv = document.getElementById('errorAnalysis');
        errorDiv.innerHTML += `
          <div style="background: #ffe; padding: 10px; margin: 10px 0; border-radius: 6px;">
            <strong>検出された問題:</strong><br>
            現在 file:// プロトコルでアクセスしています。<br>
            Chrome拡張機能のService Workerは chrome-extension:// プロトコルでのみ動作します。
          </div>
        `;
      }
    }

    // ページ読み込み時に自動実行
    setTimeout(analyzeError, 100);
  </script>
</body>
</html>