<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2rem;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .test-panel {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .control-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #666;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      flex: 1;
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status-panel {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-label {
      color: #666;
      font-weight: 500;
    }

    .status-value {
      color: #333;
      font-weight: 600;
    }

    .log-panel {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-left: 3px solid transparent;
    }

    .log-entry.info {
      border-left-color: #3b82f6;
    }

    .log-entry.success {
      border-left-color: #10b981;
      color: #10b981;
    }

    .log-entry.warning {
      border-left-color: #f59e0b;
      color: #f59e0b;
    }

    .log-entry.error {
      border-left-color: #ef4444;
      color: #ef4444;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin-top: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
    }

    .test-scenarios {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .scenario-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .scenario-card:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .scenario-card.selected {
      border-color: #764ba2;
      background: #f8f4ff;
    }

    .scenario-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .scenario-description {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”„ ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>

    <div class="test-panel">
      <h2>ãƒ†ã‚¹ãƒˆè¨­å®š</h2>
      
      <div class="control-group">
        <label for="aiType">AIã‚¿ã‚¤ãƒ—</label>
        <select id="aiType">
          <option value="Claude">Claude</option>
          <option value="ChatGPT">ChatGPT</option>
          <option value="Gemini">Gemini</option>
        </select>
      </div>

      <div class="control-group">
        <label for="prompt">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
        <textarea id="prompt" placeholder="ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›...">ã“ã‚Œã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã™ã€‚é•·ã„å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</textarea>
      </div>

      <div class="control-group">
        <label for="timeout">ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰</label>
        <input type="number" id="timeout" value="10000" min="1000" max="600000">
      </div>

      <div class="control-group">
        <label for="maxRetries">æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°</label>
        <input type="number" id="maxRetries" value="3" min="1" max="10">
      </div>

      <div class="control-group">
        <label>
          <input type="checkbox" id="enableDeepResearch">
          DeepResearchãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
        </label>
      </div>

      <div class="control-group">
        <label>
          <input type="checkbox" id="simulateTimeout" checked>
          ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        </label>
      </div>
    </div>

    <div class="test-panel">
      <h2>ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª</h2>
      <div class="test-scenarios">
        <div class="scenario-card" data-scenario="timeout">
          <div class="scenario-title">ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼</div>
          <div class="scenario-description">å¿œç­”ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã€ãƒªãƒˆãƒ©ã‚¤ãŒç™ºç”Ÿ</div>
        </div>
        <div class="scenario-card" data-scenario="partial">
          <div class="scenario-title">éƒ¨åˆ†çš„ãªå¿œç­”</div>
          <div class="scenario-description">å¿œç­”ã®é€”ä¸­ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</div>
        </div>
        <div class="scenario-card" data-scenario="network">
          <div class="scenario-title">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼</div>
          <div class="scenario-description">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œ</div>
        </div>
        <div class="scenario-card" data-scenario="success">
          <div class="scenario-title">æˆåŠŸã‚±ãƒ¼ã‚¹</div>
          <div class="scenario-description">æ­£å¸¸ã«å¿œç­”ã‚’å–å¾—</div>
        </div>
      </div>
    </div>

    <div class="test-panel">
      <h2>å®Ÿè¡Œåˆ¶å¾¡</h2>
      <div class="button-group">
        <button id="startTest">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <button id="stopTest" disabled>ãƒ†ã‚¹ãƒˆåœæ­¢</button>
        <button id="clearLog">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressBar">0%</div>
      </div>

      <div class="status-panel">
        <div class="status-item">
          <span class="status-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
          <span class="status-value" id="testStatus">å¾…æ©Ÿä¸­</span>
        </div>
        <div class="status-item">
          <span class="status-label">ç¾åœ¨ã®ãƒªãƒˆãƒ©ã‚¤å›æ•°:</span>
          <span class="status-value" id="currentRetry">0</span>
        </div>
        <div class="status-item">
          <span class="status-label">çµŒéæ™‚é–“:</span>
          <span class="status-value" id="elapsedTime">0ç§’</span>
        </div>
        <div class="status-item">
          <span class="status-label">ã‚¿ã‚¹ã‚¯ID:</span>
          <span class="status-value" id="taskId">-</span>
        </div>
      </div>
    </div>

    <div class="test-panel">
      <h2>å®Ÿè¡Œãƒ­ã‚°</h2>
      <div class="log-panel" id="logPanel"></div>
    </div>
  </div>

  <script>
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
    class RetryTestController {
      constructor() {
        this.isRunning = false;
        this.startTime = null;
        this.currentTaskId = null;
        this.retryCount = 0;
        this.selectedScenario = 'timeout';
        
        this.initializeElements();
        this.attachEventListeners();
        this.log('ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'info');
      }

      initializeElements() {
        this.elements = {
          startBtn: document.getElementById('startTest'),
          stopBtn: document.getElementById('stopTest'),
          clearBtn: document.getElementById('clearLog'),
          logPanel: document.getElementById('logPanel'),
          progressBar: document.getElementById('progressBar'),
          testStatus: document.getElementById('testStatus'),
          currentRetry: document.getElementById('currentRetry'),
          elapsedTime: document.getElementById('elapsedTime'),
          taskId: document.getElementById('taskId'),
          aiType: document.getElementById('aiType'),
          prompt: document.getElementById('prompt'),
          timeout: document.getElementById('timeout'),
          maxRetries: document.getElementById('maxRetries'),
          enableDeepResearch: document.getElementById('enableDeepResearch'),
          simulateTimeout: document.getElementById('simulateTimeout')
        };
      }

      attachEventListeners() {
        this.elements.startBtn.addEventListener('click', () => this.startTest());
        this.elements.stopBtn.addEventListener('click', () => this.stopTest());
        this.elements.clearBtn.addEventListener('click', () => this.clearLog());
        
        // ã‚·ãƒŠãƒªã‚ªã‚«ãƒ¼ãƒ‰é¸æŠ
        document.querySelectorAll('.scenario-card').forEach(card => {
          card.addEventListener('click', () => {
            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            this.selectedScenario = card.dataset.scenario;
            this.log(`ã‚·ãƒŠãƒªã‚ªé¸æŠ: ${card.querySelector('.scenario-title').textContent}`, 'info');
          });
        });
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒŠãƒªã‚ªã‚’é¸æŠ
        document.querySelector('[data-scenario="timeout"]').classList.add('selected');
      }

      async startTest() {
        if (this.isRunning) return;
        
        this.isRunning = true;
        this.startTime = Date.now();
        this.retryCount = 0;
        this.currentTaskId = this.generateTaskId();
        
        this.updateUI('running');
        this.log('ãƒ†ã‚¹ãƒˆé–‹å§‹', 'success');
        this.log(`ã‚¿ã‚¹ã‚¯ID: ${this.currentTaskId}`, 'info');
        this.log(`ã‚·ãƒŠãƒªã‚ª: ${this.selectedScenario}`, 'info');
        
        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        this.startTimer();
        
        try {
          const result = await this.executeTestScenario();
          this.handleTestResult(result);
        } catch (error) {
          this.log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          this.updateUI('error');
        }
      }

      async executeTestScenario() {
        const config = {
          taskId: this.currentTaskId,
          prompt: this.elements.prompt.value,
          aiType: this.elements.aiType.value,
          timeout: parseInt(this.elements.timeout.value),
          maxRetries: parseInt(this.elements.maxRetries.value),
          enableDeepResearch: this.elements.enableDeepResearch.checked,
          simulateTimeout: this.elements.simulateTimeout.checked,
          scenario: this.selectedScenario
        };
        
        this.log(`è¨­å®š: ${JSON.stringify(config, null, 2)}`, 'info');
        
        // ã‚·ãƒŠãƒªã‚ªã«å¿œã˜ãŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        switch (this.selectedScenario) {
          case 'timeout':
            return await this.simulateTimeoutScenario(config);
          case 'partial':
            return await this.simulatePartialResponseScenario(config);
          case 'network':
            return await this.simulateNetworkErrorScenario(config);
          case 'success':
            return await this.simulateSuccessScenario(config);
          default:
            throw new Error('æœªçŸ¥ã®ã‚·ãƒŠãƒªã‚ª');
        }
      }

      async simulateTimeoutScenario(config) {
        this.log('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œä¸­...', 'warning');
        
        for (let i = 0; i <= config.maxRetries; i++) {
          this.retryCount = i;
          this.updateRetryCount(i);
          
          if (i > 0) {
            this.log(`ãƒªãƒˆãƒ©ã‚¤ ${i}/${config.maxRetries}`, 'warning');
            this.showRetryNotification(i, config.maxRetries);
          }
          
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
          await this.wait(config.timeout);
          
          // æœ€å¾Œã®è©¦è¡Œã§æˆåŠŸã•ã›ã‚‹
          if (i === config.maxRetries || Math.random() > 0.7) {
            this.log('å¿œç­”å–å¾—æˆåŠŸï¼', 'success');
            return {
              success: true,
              response: 'ãƒ†ã‚¹ãƒˆå¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ',
              retryCount: i
            };
          }
          
          this.log(`ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ ${i + 1})`, 'error');
        }
        
        return {
          success: false,
          error: 'MAX_RETRIES_EXCEEDED',
          retryCount: config.maxRetries
        };
      }

      async simulatePartialResponseScenario(config) {
        this.log('éƒ¨åˆ†å¿œç­”ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œä¸­...', 'warning');
        await this.wait(config.timeout / 2);
        this.log('éƒ¨åˆ†çš„ãªå¿œç­”ã‚’å—ä¿¡...', 'info');
        await this.wait(config.timeout / 2);
        this.log('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - å¿œç­”ãŒä¸å®Œå…¨', 'error');
        
        // ãƒªãƒˆãƒ©ã‚¤
        this.retryCount = 1;
        this.updateRetryCount(1);
        this.showRetryNotification(1, config.maxRetries);
        await this.wait(config.timeout);
        
        return {
          success: true,
          response: 'å®Œå…¨ãªå¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ',
          retryCount: 1
        };
      }

      async simulateNetworkErrorScenario(config) {
        this.log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œä¸­...', 'warning');
        await this.wait(2000);
        this.log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ¤œå‡º', 'error');
        
        // ãƒªãƒˆãƒ©ã‚¤
        for (let i = 1; i <= 2; i++) {
          this.retryCount = i;
          this.updateRetryCount(i);
          this.showRetryNotification(i, config.maxRetries);
          await this.wait(3000);
          
          if (i === 2) {
            this.log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šå›å¾©', 'success');
            return {
              success: true,
              response: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›å¾©å¾Œã®å¿œç­”',
              retryCount: i
            };
          }
        }
      }

      async simulateSuccessScenario(config) {
        this.log('æˆåŠŸã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œä¸­...', 'info');
        const duration = Math.min(config.timeout / 2, 5000);
        await this.wait(duration);
        this.log('å¿œç­”å–å¾—æˆåŠŸï¼', 'success');
        
        return {
          success: true,
          response: 'æ­£å¸¸ãªå¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ',
          retryCount: 0
        };
      }

      showRetryNotification(current, max) {
        // å®Ÿéš›ã®é€šçŸ¥ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        const notification = {
          taskId: this.currentTaskId,
          retryCount: current,
          maxRetries: max,
          error: 'TIMEOUT_NO_RESPONSE',
          errorMessage: 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã—ã¾ã—ãŸ'
        };
        
        this.log(`é€šçŸ¥: ${JSON.stringify(notification)}`, 'info');
        
        // Chromeæ‹¡å¼µæ©Ÿèƒ½APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯å®Ÿéš›ã«é€šçŸ¥ã‚’é€ä¿¡
        if (typeof chrome !== 'undefined' && chrome.runtime) {
          chrome.runtime.sendMessage({
            type: 'RETRY_NOTIFICATION',
            data: notification
          }).catch(() => {});
        }
      }

      handleTestResult(result) {
        this.stopTimer();
        
        if (result.success) {
          this.log(`ãƒ†ã‚¹ãƒˆæˆåŠŸ (ãƒªãƒˆãƒ©ã‚¤å›æ•°: ${result.retryCount})`, 'success');
          this.updateUI('success');
          this.updateProgress(100);
        } else {
          this.log(`ãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}`, 'error');
          this.updateUI('failed');
        }
        
        this.isRunning = false;
        this.elements.startBtn.disabled = false;
        this.elements.stopBtn.disabled = true;
      }

      stopTest() {
        if (!this.isRunning) return;
        
        this.isRunning = false;
        this.stopTimer();
        this.log('ãƒ†ã‚¹ãƒˆåœæ­¢', 'warning');
        this.updateUI('stopped');
        this.elements.startBtn.disabled = false;
        this.elements.stopBtn.disabled = true;
      }

      startTimer() {
        this.timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
          this.elements.elapsedTime.textContent = `${elapsed}ç§’`;
          
          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
          const timeout = parseInt(this.elements.timeout.value) / 1000;
          const progress = Math.min((elapsed / timeout) * 100, 100);
          this.updateProgress(progress);
        }, 100);
      }

      stopTimer() {
        if (this.timerInterval) {
          clearInterval(this.timerInterval);
          this.timerInterval = null;
        }
      }

      updateUI(status) {
        const statusTexts = {
          running: 'å®Ÿè¡Œä¸­',
          success: 'æˆåŠŸ',
          failed: 'å¤±æ•—',
          stopped: 'åœæ­¢',
          error: 'ã‚¨ãƒ©ãƒ¼'
        };
        
        this.elements.testStatus.textContent = statusTexts[status] || 'å¾…æ©Ÿä¸­';
        this.elements.taskId.textContent = this.currentTaskId || '-';
        
        if (status === 'running') {
          this.elements.startBtn.disabled = true;
          this.elements.stopBtn.disabled = false;
        }
      }

      updateRetryCount(count) {
        this.elements.currentRetry.textContent = count;
      }

      updateProgress(percent) {
        this.elements.progressBar.style.width = `${percent}%`;
        this.elements.progressBar.textContent = `${Math.round(percent)}%`;
      }

      log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${timestamp}] ${message}`;
        this.elements.logPanel.appendChild(entry);
        this.elements.logPanel.scrollTop = this.elements.logPanel.scrollHeight;
      }

      clearLog() {
        this.elements.logPanel.innerHTML = '';
        this.log('ãƒ­ã‚°ã‚¯ãƒªã‚¢', 'info');
      }

      generateTaskId() {
        return `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }

      wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
    }

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼åˆæœŸåŒ–
    const testController = new RetryTestController();
  </script>
</body>
</html>