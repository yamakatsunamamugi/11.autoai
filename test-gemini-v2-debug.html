<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini V2デバッグテスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        .log-entry.info {
            border-color: #4299e1;
            color: #63b3ed;
        }
        .log-entry.success {
            border-color: #48bb78;
            color: #68d391;
        }
        .log-entry.error {
            border-color: #f56565;
            color: #fc8181;
        }
        .log-entry.warning {
            border-color: #ed8936;
            color: #f6ad55;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #c6f6d5;
            color: #22543d;
        }
        .status.error {
            background: #fed7d7;
            color: #742a2a;
        }
        .status.info {
            background: #bee3f8;
            color: #2c5282;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a5568;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Gemini V2 デバッグテスト</h1>
        
        <div class="test-section">
            <h2>📋 V2システム状態</h2>
            <div id="v2-status" class="status info">チェック中...</div>
            <button onclick="checkV2Status()">V2ステータス確認</button>
            <button onclick="loadV2Scripts()">V2スクリプト手動ロード</button>
        </div>

        <div class="test-section">
            <h2>🎮 V2テスト実行</h2>
            
            <div class="input-group">
                <label>モデル選択:</label>
                <select id="model-select">
                    <option value="">選択してください</option>
                    <option value="Flash">2.5 Flash</option>
                    <option value="Pro">2.5 Pro</option>
                    <option value="Thinking">2.0 Flash Thinking</option>
                </select>
            </div>

            <div class="input-group">
                <label>機能選択:</label>
                <select id="function-select">
                    <option value="">なし</option>
                    <option value="Canvas">Canvas</option>
                    <option value="Deep Research">Deep Research</option>
                    <option value="Deep Think">Deep Think</option>
                </select>
            </div>

            <div class="input-group">
                <label>プロンプト:</label>
                <textarea id="prompt-input" placeholder="テストプロンプトを入力...">桃太郎について2000文字で解説して</textarea>
            </div>

            <div class="grid">
                <button onclick="runV2Test()">V2テスト実行</button>
                <button onclick="runNormalTest()">通常モードテスト</button>
                <button onclick="runIntegrationTest()">統合テスト実行</button>
            </div>
        </div>

        <div class="test-section">
            <h2>🔍 デバッグ機能</h2>
            <div class="grid">
                <button onclick="checkAvailableModels()">利用可能モデル確認</button>
                <button onclick="checkAvailableFunctions()">利用可能機能確認</button>
                <button onclick="checkGlobalState()">グローバル状態確認</button>
                <button onclick="clearLog()">ログクリア</button>
            </div>
        </div>

        <div class="test-section">
            <h2>📝 実行ログ</h2>
            <div id="log" class="log">
                <div class="log-entry info">テストシステム起動...</div>
            </div>
        </div>
    </div>

    <script>
        // ログ関数
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            entry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        // V2ステータス確認
        async function checkV2Status() {
            log('V2ステータス確認開始...', 'info');
            
            const statusDiv = document.getElementById('v2-status');
            const checks = {
                'runIntegrationTest': window.runIntegrationTest,
                'continueTest': window.continueTest,
                'GeminiV2Integration': window.GeminiV2Integration,
                'GeminiAutomation': window.GeminiAutomation,
                'GeminiAutomation.runAutomation': window.GeminiAutomation?.runAutomation,
                'availableModels': window.availableModels,
                'availableFeatures': window.availableFeatures
            };
            
            let allGood = true;
            for (const [name, exists] of Object.entries(checks)) {
                if (exists) {
                    log(`✅ ${name}: 利用可能`, 'success');
                } else {
                    log(`❌ ${name}: 利用不可`, 'error');
                    allGood = false;
                }
            }
            
            if (allGood) {
                statusDiv.textContent = '✅ V2システム完全動作中';
                statusDiv.className = 'status success';
            } else {
                statusDiv.textContent = '⚠️ V2システム一部機能なし';
                statusDiv.className = 'status warning';
            }
        }

        // V2スクリプト手動ロード
        async function loadV2Scripts() {
            log('V2スクリプト手動ロード開始...', 'info');
            
            try {
                // V2スクリプトをロード
                const v2Script = document.createElement('script');
                v2Script.src = chrome.runtime.getURL('src/platforms/gemini-automation-v2.js');
                v2Script.onload = () => {
                    log('✅ gemini-automation-v2.jsロード完了', 'success');
                };
                document.head.appendChild(v2Script);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // V2統合スクリプトをロード
                const integrationScript = document.createElement('script');
                integrationScript.src = chrome.runtime.getURL('src/platforms/gemini-v2-integration.js');
                integrationScript.onload = () => {
                    log('✅ gemini-v2-integration.jsロード完了', 'success');
                };
                document.head.appendChild(integrationScript);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                checkV2Status();
            } catch (error) {
                log(`エラー: ${error.message}`, 'error');
            }
        }

        // V2テスト実行
        async function runV2Test() {
            log('V2テスト実行開始...', 'info');
            
            const model = document.getElementById('model-select').value;
            const func = document.getElementById('function-select').value;
            const prompt = document.getElementById('prompt-input').value;
            
            if (!window.GeminiAutomation?.runAutomation) {
                log('GeminiAutomation.runAutomationが利用できません', 'error');
                return;
            }
            
            const config = {
                model: model || null,
                function: func || 'none',
                text: prompt,
                send: true,
                waitResponse: false,
                getResponse: false,
                useV2: true  // V2モード明示的指定
            };
            
            log(`設定: ${JSON.stringify(config, null, 2)}`, 'info');
            
            try {
                const result = await window.GeminiAutomation.runAutomation(config);
                log(`✅ V2実行成功: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`❌ V2実行エラー: ${error.message}`, 'error');
            }
        }

        // 通常モードテスト
        async function runNormalTest() {
            log('通常モードテスト実行開始...', 'info');
            
            const model = document.getElementById('model-select').value;
            const func = document.getElementById('function-select').value;
            const prompt = document.getElementById('prompt-input').value;
            
            if (!window.GeminiAutomation?.runAutomation) {
                log('GeminiAutomation.runAutomationが利用できません', 'error');
                return;
            }
            
            const config = {
                model: model || null,
                function: func || 'none',
                text: prompt,
                send: true,
                waitResponse: false,
                getResponse: false,
                useV2: false  // 通常モード
            };
            
            log(`設定: ${JSON.stringify(config, null, 2)}`, 'info');
            
            try {
                const result = await window.GeminiAutomation.runAutomation(config);
                log(`✅ 通常実行成功: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`❌ 通常実行エラー: ${error.message}`, 'error');
            }
        }

        // 統合テスト実行
        async function runIntegrationTest() {
            log('統合テスト実行開始...', 'info');
            
            if (!window.runIntegrationTest) {
                log('runIntegrationTest関数が利用できません', 'error');
                return;
            }
            
            try {
                log('Step 1: runIntegrationTest実行中...', 'info');
                await window.runIntegrationTest();
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (window.availableModels && window.availableFeatures) {
                    log(`✅ モデル: ${window.availableModels.length}個検出`, 'success');
                    log(`✅ 機能: ${window.availableFeatures.length}個検出`, 'success');
                    
                    // モデル1、機能1で続行
                    log('Step 2: continueTest(1, 1)実行中...', 'info');
                    const result = await window.continueTest(1, 1);
                    log(`✅ 統合テスト完了: ${JSON.stringify(result)}`, 'success');
                } else {
                    log('モデル/機能リストが取得できませんでした', 'error');
                }
            } catch (error) {
                log(`❌ 統合テストエラー: ${error.message}`, 'error');
            }
        }

        // 利用可能モデル確認
        async function checkAvailableModels() {
            log('利用可能モデル確認中...', 'info');
            
            if (window.GeminiAutomation?.collectAvailableModels) {
                try {
                    const models = await window.GeminiAutomation.collectAvailableModels();
                    log(`検出されたモデル数: ${models.length}`, 'info');
                    models.forEach((model, index) => {
                        log(`  ${index + 1}. ${model.name}`, 'success');
                    });
                } catch (error) {
                    log(`エラー: ${error.message}`, 'error');
                }
            } else {
                log('collectAvailableModels関数が利用できません', 'error');
            }
        }

        // 利用可能機能確認
        async function checkAvailableFunctions() {
            log('利用可能機能確認中...', 'info');
            
            if (window.GeminiAutomation?.collectAvailableFunctions) {
                try {
                    const functions = await window.GeminiAutomation.collectAvailableFunctions();
                    log(`検出された機能数: ${functions.length}`, 'info');
                    functions.forEach((func, index) => {
                        log(`  ${index + 1}. ${func.name} (${func.active ? '有効' : '無効'})`, func.active ? 'success' : 'info');
                    });
                } catch (error) {
                    log(`エラー: ${error.message}`, 'error');
                }
            } else {
                log('collectAvailableFunctions関数が利用できません', 'error');
            }
        }

        // グローバル状態確認
        function checkGlobalState() {
            log('グローバル状態確認中...', 'info');
            
            if (window.globalState) {
                log(`現在のモデル: ${window.globalState.currentModel || 'なし'}`, 'info');
                log(`有効な機能: ${window.globalState.activeFunctions?.join(', ') || 'なし'}`, 'info');
                log(`デバッグモード: ${window.globalState.debugMode ? 'ON' : 'OFF'}`, 'info');
                log(`モデルキャッシュ: ${window.globalState.modelCache ? '有効' : '無効'}`, 'info');
                log(`機能キャッシュ: ${window.globalState.functionCache ? '有効' : '無効'}`, 'info');
            } else {
                log('globalStateが利用できません', 'error');
            }
            
            if (window.availableModels) {
                log(`window.availableModels: ${window.availableModels.length}個`, 'success');
            }
            if (window.availableFeatures) {
                log(`window.availableFeatures: ${window.availableFeatures.length}個`, 'success');
            }
        }

        // ログクリア
        function clearLog() {
            const logElement = document.getElementById('log');
            logElement.innerHTML = '<div class="log-entry info">ログをクリアしました</div>';
        }

        // 初期化
        window.addEventListener('load', async () => {
            log('ページロード完了', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));
            checkV2Status();
        });
    </script>
</body>
</html>