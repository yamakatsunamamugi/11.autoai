<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini V2ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        .log-entry.info {
            border-color: #4299e1;
            color: #63b3ed;
        }
        .log-entry.success {
            border-color: #48bb78;
            color: #68d391;
        }
        .log-entry.error {
            border-color: #f56565;
            color: #fc8181;
        }
        .log-entry.warning {
            border-color: #ed8936;
            color: #f6ad55;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #c6f6d5;
            color: #22543d;
        }
        .status.error {
            background: #fed7d7;
            color: #742a2a;
        }
        .status.info {
            background: #bee3f8;
            color: #2c5282;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a5568;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Gemini V2 ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h2>ğŸ“‹ V2ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h2>
            <div id="v2-status" class="status info">ãƒã‚§ãƒƒã‚¯ä¸­...</div>
            <button onclick="checkV2Status()">V2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª</button>
            <button onclick="loadV2Scripts()">V2ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ‰‹å‹•ãƒ­ãƒ¼ãƒ‰</button>
        </div>

        <div class="test-section">
            <h2>ğŸ® V2ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
            
            <div class="input-group">
                <label>ãƒ¢ãƒ‡ãƒ«é¸æŠ:</label>
                <select id="model-select">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="Flash">2.5 Flash</option>
                    <option value="Pro">2.5 Pro</option>
                    <option value="Thinking">2.0 Flash Thinking</option>
                </select>
            </div>

            <div class="input-group">
                <label>æ©Ÿèƒ½é¸æŠ:</label>
                <select id="function-select">
                    <option value="">ãªã—</option>
                    <option value="Canvas">Canvas</option>
                    <option value="Deep Research">Deep Research</option>
                    <option value="Deep Think">Deep Think</option>
                </select>
            </div>

            <div class="input-group">
                <label>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</label>
                <textarea id="prompt-input" placeholder="ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›...">æ¡ƒå¤ªéƒã«ã¤ã„ã¦2000æ–‡å­—ã§è§£èª¬ã—ã¦</textarea>
            </div>

            <div class="grid">
                <button onclick="runV2Test()">V2ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button onclick="runNormalTest()">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="runIntegrationTest()">çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ” ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</h2>
            <div class="grid">
                <button onclick="checkAvailableModels()">åˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«ç¢ºèª</button>
                <button onclick="checkAvailableFunctions()">åˆ©ç”¨å¯èƒ½æ©Ÿèƒ½ç¢ºèª</button>
                <button onclick="checkGlobalState()">ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç¢ºèª</button>
                <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ å®Ÿè¡Œãƒ­ã‚°</h2>
            <div id="log" class="log">
                <div class="log-entry info">ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ èµ·å‹•...</div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ­ã‚°é–¢æ•°
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            entry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        // V2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
        async function checkV2Status() {
            log('V2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªé–‹å§‹...', 'info');
            
            const statusDiv = document.getElementById('v2-status');
            const checks = {
                'runIntegrationTest': window.runIntegrationTest,
                'continueTest': window.continueTest,
                'GeminiV2Integration': window.GeminiV2Integration,
                'GeminiAutomation': window.GeminiAutomation,
                'GeminiAutomation.runAutomation': window.GeminiAutomation?.runAutomation,
                'availableModels': window.availableModels,
                'availableFeatures': window.availableFeatures
            };
            
            let allGood = true;
            for (const [name, exists] of Object.entries(checks)) {
                if (exists) {
                    log(`âœ… ${name}: åˆ©ç”¨å¯èƒ½`, 'success');
                } else {
                    log(`âŒ ${name}: åˆ©ç”¨ä¸å¯`, 'error');
                    allGood = false;
                }
            }
            
            if (allGood) {
                statusDiv.textContent = 'âœ… V2ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å‹•ä½œä¸­';
                statusDiv.className = 'status success';
            } else {
                statusDiv.textContent = 'âš ï¸ V2ã‚·ã‚¹ãƒ†ãƒ ä¸€éƒ¨æ©Ÿèƒ½ãªã—';
                statusDiv.className = 'status warning';
            }
        }

        // V2ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ‰‹å‹•ãƒ­ãƒ¼ãƒ‰
        async function loadV2Scripts() {
            log('V2ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ‰‹å‹•ãƒ­ãƒ¼ãƒ‰é–‹å§‹...', 'info');
            
            try {
                // V2ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
                const v2Script = document.createElement('script');
                v2Script.src = chrome.runtime.getURL('src/platforms/gemini-automation-v2.js');
                v2Script.onload = () => {
                    log('âœ… gemini-automation-v2.jsãƒ­ãƒ¼ãƒ‰å®Œäº†', 'success');
                };
                document.head.appendChild(v2Script);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // V2çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
                const integrationScript = document.createElement('script');
                integrationScript.src = chrome.runtime.getURL('src/platforms/gemini-v2-integration.js');
                integrationScript.onload = () => {
                    log('âœ… gemini-v2-integration.jsãƒ­ãƒ¼ãƒ‰å®Œäº†', 'success');
                };
                document.head.appendChild(integrationScript);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                checkV2Status();
            } catch (error) {
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // V2ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runV2Test() {
            log('V2ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹...', 'info');
            
            const model = document.getElementById('model-select').value;
            const func = document.getElementById('function-select').value;
            const prompt = document.getElementById('prompt-input').value;
            
            if (!window.GeminiAutomation?.runAutomation) {
                log('GeminiAutomation.runAutomationãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            const config = {
                model: model || null,
                function: func || 'none',
                text: prompt,
                send: true,
                waitResponse: false,
                getResponse: false,
                useV2: true  // V2ãƒ¢ãƒ¼ãƒ‰æ˜ç¤ºçš„æŒ‡å®š
            };
            
            log(`è¨­å®š: ${JSON.stringify(config, null, 2)}`, 'info');
            
            try {
                const result = await window.GeminiAutomation.runAutomation(config);
                log(`âœ… V2å®Ÿè¡ŒæˆåŠŸ: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`âŒ V2å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
        async function runNormalTest() {
            log('é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹...', 'info');
            
            const model = document.getElementById('model-select').value;
            const func = document.getElementById('function-select').value;
            const prompt = document.getElementById('prompt-input').value;
            
            if (!window.GeminiAutomation?.runAutomation) {
                log('GeminiAutomation.runAutomationãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            const config = {
                model: model || null,
                function: func || 'none',
                text: prompt,
                send: true,
                waitResponse: false,
                getResponse: false,
                useV2: false  // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
            };
            
            log(`è¨­å®š: ${JSON.stringify(config, null, 2)}`, 'info');
            
            try {
                const result = await window.GeminiAutomation.runAutomation(config);
                log(`âœ… é€šå¸¸å®Ÿè¡ŒæˆåŠŸ: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`âŒ é€šå¸¸å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runIntegrationTest() {
            log('çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹...', 'info');
            
            if (!window.runIntegrationTest) {
                log('runIntegrationTesté–¢æ•°ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                log('Step 1: runIntegrationTestå®Ÿè¡Œä¸­...', 'info');
                await window.runIntegrationTest();
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (window.availableModels && window.availableFeatures) {
                    log(`âœ… ãƒ¢ãƒ‡ãƒ«: ${window.availableModels.length}å€‹æ¤œå‡º`, 'success');
                    log(`âœ… æ©Ÿèƒ½: ${window.availableFeatures.length}å€‹æ¤œå‡º`, 'success');
                    
                    // ãƒ¢ãƒ‡ãƒ«1ã€æ©Ÿèƒ½1ã§ç¶šè¡Œ
                    log('Step 2: continueTest(1, 1)å®Ÿè¡Œä¸­...', 'info');
                    const result = await window.continueTest(1, 1);
                    log(`âœ… çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†: ${JSON.stringify(result)}`, 'success');
                } else {
                    log('ãƒ¢ãƒ‡ãƒ«/æ©Ÿèƒ½ãƒªã‚¹ãƒˆãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
                }
            } catch (error) {
                log(`âŒ çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // åˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«ç¢ºèª
        async function checkAvailableModels() {
            log('åˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«ç¢ºèªä¸­...', 'info');
            
            if (window.GeminiAutomation?.collectAvailableModels) {
                try {
                    const models = await window.GeminiAutomation.collectAvailableModels();
                    log(`æ¤œå‡ºã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«æ•°: ${models.length}`, 'info');
                    models.forEach((model, index) => {
                        log(`  ${index + 1}. ${model.name}`, 'success');
                    });
                } catch (error) {
                    log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            } else {
                log('collectAvailableModelsé–¢æ•°ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
            }
        }

        // åˆ©ç”¨å¯èƒ½æ©Ÿèƒ½ç¢ºèª
        async function checkAvailableFunctions() {
            log('åˆ©ç”¨å¯èƒ½æ©Ÿèƒ½ç¢ºèªä¸­...', 'info');
            
            if (window.GeminiAutomation?.collectAvailableFunctions) {
                try {
                    const functions = await window.GeminiAutomation.collectAvailableFunctions();
                    log(`æ¤œå‡ºã•ã‚ŒãŸæ©Ÿèƒ½æ•°: ${functions.length}`, 'info');
                    functions.forEach((func, index) => {
                        log(`  ${index + 1}. ${func.name} (${func.active ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'})`, func.active ? 'success' : 'info');
                    });
                } catch (error) {
                    log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            } else {
                log('collectAvailableFunctionsé–¢æ•°ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç¢ºèª
        function checkGlobalState() {
            log('ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç¢ºèªä¸­...', 'info');
            
            if (window.globalState) {
                log(`ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«: ${window.globalState.currentModel || 'ãªã—'}`, 'info');
                log(`æœ‰åŠ¹ãªæ©Ÿèƒ½: ${window.globalState.activeFunctions?.join(', ') || 'ãªã—'}`, 'info');
                log(`ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${window.globalState.debugMode ? 'ON' : 'OFF'}`, 'info');
                log(`ãƒ¢ãƒ‡ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${window.globalState.modelCache ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
                log(`æ©Ÿèƒ½ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${window.globalState.functionCache ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
            } else {
                log('globalStateãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
            }
            
            if (window.availableModels) {
                log(`window.availableModels: ${window.availableModels.length}å€‹`, 'success');
            }
            if (window.availableFeatures) {
                log(`window.availableFeatures: ${window.availableFeatures.length}å€‹`, 'success');
            }
        }

        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLog() {
            const logElement = document.getElementById('log');
            logElement.innerHTML = '<div class="log-entry info">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</div>';
        }

        // åˆæœŸåŒ–
        window.addEventListener('load', async () => {
            log('ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº†', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));
            checkV2Status();
        });
    </script>
</body>
</html>